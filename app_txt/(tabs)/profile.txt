# TÃ“M Táº®T LOGIC TRANG PROFILE.TSX

## ğŸ¯ Má»¤C ÄÃCH
Trang há»“ sÆ¡ cÃ¡ nhÃ¢n vá»›i cÃ¡c chá»©c nÄƒng theo vai trÃ²:
- **Guest:** Hiá»ƒn thá»‹ thÃ´ng bÃ¡o, nÃºt Ä‘Äƒng nháº­p
- **User thÆ°á»ng:** Xem/sá»­a thÃ´ng tin, lá»‹ch sá»­ Ä‘Æ¡n hÃ ng, Ä‘iá»ƒm thÆ°á»Ÿng
- **Admin:** Truy cáº­p trang quáº£n trá»‹
- **Shop Owner:** Quáº£n lÃ½ thá»±c Ä‘Æ¡n (báº­t/táº¯t mÃ³n)
- **Shipper:** Báº­t/táº¯t tráº¡ng thÃ¡i sáºµn sÃ ng, xem vÃ­ cÃ´ng ná»£

## ğŸ“Š STATE & DATA

**Store:**
- `currentUser`: thÃ´ng tin user hiá»‡n táº¡i
- `foods`: danh sÃ¡ch mÃ³n Äƒn (Ä‘á»ƒ filter myFoods)
- `logout()`: Ä‘Äƒng xuáº¥t
- `updateProfile()`: cáº­p nháº­t thÃ´ng tin
- `toggleFoodStatus()`: báº­t/táº¯t mÃ³n
- `ensureShipperReadyFresh()`: Ä‘á»“ng bá»™ tráº¡ng thÃ¡i shipper
- `setShipperReadyToday()`: báº­t sáºµn sÃ ng
- `setShipperNotReady()`: táº¯t sáºµn sÃ ng

**Local State:**
- `isEditing`: Ä‘ang sá»­a thÃ´ng tin
- `name`, `address`: thÃ´ng tin Ä‘ang edit
- `readyLoading`: Ä‘ang cáº­p nháº­t tráº¡ng thÃ¡i shipper

**Role Check:**
```js
const isGuestUser = currentUser && !currentUser.password;
const isAdmin = !isGuestUser && currentUser?.role === 'admin';
const isShopOwner = !isGuestUser && (currentUser?.role === 'chá»§ shop' || currentUser?.role === 'admin');
const isShipper = !isGuestUser && currentUser?.role === 'shipper';
```

## ğŸ”„ LUá»’NG THá»°C THI

### Guest Flow
1. Hiá»ƒn thá»‹ avatar "?", tÃªn "KhÃ¡ch vÃ£ng lai", ID
2. Hiá»ƒn thá»‹ thÃ´ng bÃ¡o "ÄÄƒng kÃ½ tÃ i khoáº£n Ä‘á»ƒ tÃ­ch Ä‘iá»ƒm"
3. NÃºt "ÄÄ‚NG NHáº¬P NGAY" â†’ navigate `/login`

### User Flow
1. Hiá»ƒn thá»‹ avatar (chá»¯ cÃ¡i Ä‘áº§u), tÃªn, SÄT, Ä‘iá»ƒm
2. ThÃ´ng tin cÃ¡ nhÃ¢n: Xem hoáº·c Sá»¬A (name, address)
3. NÃºt "Lá»‹ch sá»­ Ä‘Æ¡n hÃ ng" â†’ navigate `/orders`
4. NÃºt "ÄÄ‚NG XUáº¤T" â†’ logout â†’ `/login`

### Admin Flow
(User flow +)
5. Tháº» "Quáº£n trá»‹ há»‡ thá»‘ng" â†’ navigate `/admin`

### Shop Owner Flow
(User flow +)
6. Tháº» "Quáº£n lÃ½ thá»±c Ä‘Æ¡n"
7. Danh sÃ¡ch mÃ³n cá»§a shop (filter theo `shopId === currentUser.id`)
8. Má»—i mÃ³n cÃ³ Switch báº­t/táº¯t (`status: enable/disable`)

### Shipper Flow
(User flow +)
9. Tháº» "GÃ³c Shipper"
10. Switch "Tráº¡ng thÃ¡i sáºµn sÃ ng hÃ´m nay"
11. NÃºt "VÃ­ cÃ´ng ná»£ & TÃ i chÃ­nh" â†’ navigate `/shipper/finance`

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### `handleToggleFood(food)`
Báº­t/táº¯t tráº¡ng thÃ¡i mÃ³n:
```js
const result = await toggleFoodStatus(food.id, food.status);
if (!result.success) console.log("Lá»—i cáº­p nháº­t tráº¡ng thÃ¡i");
```

### `handleToggleReady()`
Báº­t/táº¯t tráº¡ng thÃ¡i sáºµn sÃ ng shipper:
```js
setReadyLoading(true);
await ensureShipperReadyFresh(); // Äá»“ng bá»™ trÆ°á»›c
const action = currentUser?.isReady ? setShipperNotReady : setShipperReadyToday;
const result = await action();
setReadyLoading(false);
```

### `handleSaveProfile()`
LÆ°u thÃ´ng tin profile:
```js
if (isGuestUser) return;
const res = await updateProfile({ name, address });
if (res.success) setIsEditing(false);
```

### `handleAuthAction()`
ÄÄƒng xuáº¥t hoáº·c Ä‘Äƒng nháº­p:
```js
await logout();
router.replace('/login');
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Avatar (chá»¯ cÃ¡i hoáº·c "?")
  â”‚   â””â”€ Info
  â”‚       â”œâ”€ Name (hoáº·c "KhÃ¡ch vÃ£ng lai")
  â”‚       â”œâ”€ Phone (hoáº·c ID guest)
  â”‚       â”œâ”€ Point Tag (náº¿u khÃ´ng pháº£i guest)
  â”‚       â””â”€ Role
  â”‚
  â””â”€ ScrollView (Content)
      â”œâ”€ Guest Notice (náº¿u guest)
      â”‚
      â”œâ”€ Card: ThÃ´ng tin cÃ¡ nhÃ¢n
      â”‚   â”œâ”€ Header: Title + NÃºt Sá»¬A/LÆ¯U
      â”‚   â””â”€ Body:
      â”‚       â”œâ”€ isEditing: 2 MyInput (name, address)
      â”‚       â””â”€ !isEditing: 2 Row (person, location)
      â”‚
      â”œâ”€ Card: Lá»‹ch sá»­ Ä‘Æ¡n hÃ ng â†’ /orders
      â”‚
      â”œâ”€ Card: Quáº£n trá»‹ há»‡ thá»‘ng (isAdmin) â†’ /admin
      â”‚
      â”œâ”€ Card: GÃ³c Shipper (isShipper)
      â”‚   â”œâ”€ Switch: Tráº¡ng thÃ¡i sáºµn sÃ ng
      â”‚   â””â”€ NÃºt: VÃ­ cÃ´ng ná»£ â†’ /shipper/finance
      â”‚
      â”œâ”€ Card: Quáº£n lÃ½ thá»±c Ä‘Æ¡n (isShopOwner)
      â”‚   â””â”€ Danh sÃ¡ch mÃ³n (Image + Name + Price + Switch)
      â”‚
      â””â”€ Button: ÄÄ‚NG XUáº¤T / ÄÄ‚NG NHáº¬P NGAY
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

1. **Guest Detection:** `currentUser && !currentUser.password`
2. **Multi-role Support:** Admin, Shop Owner, Shipper, User thÆ°á»ng, Guest
3. **Conditional UI:** Hiá»ƒn thá»‹ cÃ¡c section khÃ¡c nhau tÃ¹y role
4. **Realtime Shipper Status:** Gá»i `ensureShipperReadyFresh()` trong useEffect
5. **Food List Filter:** `foods.filter(f => f.shopId === currentUser?.id)`
6. **Switch Color Coding:**
   - Food: trackColor false=#767577, true=COLORS.primary
   - Shipper: trackColor false=#E0E0E0, true=#81C784
7. **Avatar Letter:** `currentUser?.name?.charAt(0)?.toUpperCase()`
8. **Point Display:** `currentUser?.point || 0` Ä‘iá»ƒm
9. **Guest Notice:** Background #FFF4E5, icon information-circle
10. **Border Left Color:** Admin card cÃ³ border mÃ u #2E7D32, Shipper card mÃ u #E67E22

## ğŸš€ USER JOURNEY

### Guest
1. VÃ o Profile â†’ Tháº¥y avatar "?", ID guest
2. ThÃ´ng bÃ¡o: "ÄÄƒng kÃ½ Ä‘á»ƒ tÃ­ch Ä‘iá»ƒm"
3. Nháº¥n "ÄÄ‚NG NHáº¬P NGAY" â†’ Login page

### User thÆ°á»ng
1. VÃ o Profile â†’ Tháº¥y tÃªn, SÄT, Ä‘iá»ƒm
2. Nháº¥n "Sá»¬A" â†’ Edit name/address â†’ "LÆ¯U"
3. Nháº¥n "Lá»‹ch sá»­ Ä‘Æ¡n hÃ ng" â†’ Orders page
4. Nháº¥n "ÄÄ‚NG XUáº¤T" â†’ Login page

### Admin
(User flow +)
5. Nháº¥n "Quáº£n trá»‹ há»‡ thá»‘ng" â†’ Admin dashboard

### Shop Owner
(User flow +)
6. Xem danh sÃ¡ch mÃ³n cá»§a mÃ¬nh
7. Toggle Switch Ä‘á»ƒ báº­t/táº¯t mÃ³n

### Shipper
(User flow +)
8. Toggle Switch "Sáºµn sÃ ng hÃ´m nay" (cáº§n báº­t Ä‘á»ƒ nháº­n Ä‘Æ¡n)
9. Nháº¥n "VÃ­ cÃ´ng ná»£ & TÃ i chÃ­nh" â†’ Shipper finance page

## ğŸ”— NAVIGATION

**Navigates TO:**
- `/login` (Ä‘Äƒng xuáº¥t hoáº·c nÃºt Ä‘Äƒng nháº­p guest)
- `/orders` (lá»‹ch sá»­ Ä‘Æ¡n hÃ ng)
- `/admin` (quáº£n trá»‹ - admin only)
- `/shipper/finance` (vÃ­ ná»£ - shipper only)

**Navigates FROM:**
- Bottom tab navigation
- Shipper tab (nÃºt "Báº­t sáºµn sÃ ng" trong not-ready notice)

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

1. **Guest Logic:** KhÃ´ng cho edit profile, khÃ´ng cÃ³ Ä‘iá»ƒm
2. **Role Hierarchy:** Admin cÅ©ng lÃ  Shop Owner (cÃ³ thá»ƒ quáº£n lÃ½ mÃ³n)
3. **isReady Flag:** Shipper cáº§n báº­t `isReady = true` Ä‘á»ƒ nháº­n Ä‘Æ¡n trong shipper tab
4. **readyDate:** LÆ°u ngÃ y báº­t sáºµn sÃ ng (format: YYYY-MM-DD)
5. **ensureShipperReadyFresh():** Äáº£m báº£o tráº¡ng thÃ¡i isReady Ä‘Æ°á»£c reset náº¿u qua ngÃ y má»›i
6. **toggleFoodStatus():** Cáº­p nháº­t Firestore `foods/{foodId}` â†’ `status: enable/disable`
7. **updateProfile():** Cáº­p nháº­t Firestore `users/{userId}` â†’ `{ name, address }`
8. **Price Display:**
   ```js
   const priceNormal = (food.priceNormal || 0) * 1000;
   const pricePromo = (food.pricePromo || 0) * 1000;
   ```
9. **Switch Value:** `value={food.status === 'enable'}` hoáº·c `value={currentUser?.isReady || false}`
10. **Loading Disable:** Switch shipper disabled khi `readyLoading = true`
11. **MyInput Component:** Import tá»« `../../src/components/MyUI`
12. **Food Image:** Fallback `https://via.placeholder.com/150` náº¿u khÃ´ng cÃ³
13. **Guest ID Display:** `ID: ${currentUser?.id}` thay vÃ¬ sá»‘ Ä‘iá»‡n thoáº¡i
14. **Point Tag:** Icon ribbon + text Ä‘iá»ƒm + background #Fdf2f2
15. **Logout Button Color:** Guest: #2E7D32 (xanh lÃ¡), User: #FF4747 (Ä‘á»)
