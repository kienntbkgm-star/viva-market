# TÃ“M Táº®T LOGIC TRANG CART.TSX

## ğŸ¯ Má»¤C ÄÃCH
Trang giá» hÃ ng cho phÃ©p:
- Xem danh sÃ¡ch mÃ³n Ä‘Ã£ thÃªm vÃ o giá»
- Chá»‰nh sá»‘ lÆ°á»£ng mÃ³n (tÄƒng/giáº£m)
- Chá»n hÃ¬nh thá»©c giao hÃ ng (Táº¡i sáº£nh / Táº¡i cá»­a)
- Chá»n mÃ£ Æ°u Ä‘Ã£i (promos)
- Nháº­p thÃ´ng tin giao hÃ ng (cho khÃ¡ch vÃ£ng lai)
- XÃ¡c nháº­n Ä‘áº·t hÃ ng

## ğŸ“Š STATE & DATA

**Store:**
- `cart`: danh sÃ¡ch mÃ³n trong giá»
- `currentUser`: thÃ´ng tin user hiá»‡n táº¡i
- `system`: cáº¥u hÃ¬nh há»‡ thá»‘ng (phÃ­ ship)
- `promos`: danh sÃ¡ch mÃ£ Æ°u Ä‘Ã£i
- `users`: danh sÃ¡ch ngÆ°á»i dÃ¹ng (Ä‘á»ƒ láº¥y shopName)

**Local State:**
- `shipType`: 'normal' hoáº·c 'atDoor'
- `appliedPromo`: mÃ£ Æ°u Ä‘Ã£i Ä‘ang chá»n (null náº¿u khÃ´ng chá»n)
- `loading`: tráº¡ng thÃ¡i Ä‘ang xá»­ lÃ½ Ä‘Æ¡n
- `isSuccess`: Ä‘áº·t hÃ ng thÃ nh cÃ´ng
- `showConfirm`: hiá»‡n modal xÃ¡c nháº­n
- `gName`, `gPhone`, `gAddress`: thÃ´ng tin giao hÃ ng cho guest

## ğŸ”„ LUá»’NG THá»°C THI

1. **Hiá»ƒn thá»‹ giá» hÃ ng:** FlatList cart items
2. **TÃ­nh toÃ¡n giÃ¡:**
   - `subTotal`: Tá»•ng tiá»n mÃ³n (bao gá»“m giÃ¡ mÃ³n + giÃ¡ option)
   - `baseShipFee`: PhÃ­ ship cÆ¡ báº£n (normal/atDoor)
   - `extraStepFee`: PhÃ­ thÃªm quÃ¡n (sá»‘ shop - 1) * stepPrice
   - `discount`: Giáº£m giÃ¡ tá»« promo (percent/freeship/fixed)
   - `finalTotal`: Tá»•ng cuá»‘i = subTotal + totalShipFee - discount
3. **Chá»n promo:** Nháº¥n vÃ o promo ticket Ä‘á»ƒ apply/remove
4. **Nháº¥n Äáº¶T HÃ€NG NGAY:** Gá»i `handleOpenConfirm()`
   - Validate thÃ´ng tin giao hÃ ng (guest/user)
   - Hiá»‡n modal xÃ¡c nháº­n
5. **XÃ¡c nháº­n Ä‘Æ¡n:** Gá»i `handleConfirmOrder()`
   - Táº¡o orderId: `FOOD-{timestamp}`
   - Táº¡o order object (14 fields)
   - LÆ°u vÃ o Firestore `foodOrders`
   - Cá»™ng Ä‘iá»ƒm cho user (náº¿u khÃ´ng pháº£i guest)
   - XÃ³a giá» hÃ ng
   - Hiá»ƒn thá»‹ mÃ n hÃ¬nh thÃ nh cÃ´ng

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### `formatCurrency(val)`
Chuyá»ƒn Ä‘á»•i sá»‘ sang Ä‘á»‹nh dáº¡ng VNÄ:
```js
(val * 1000).toLocaleString('vi-VN')
```

### `getShopNameFromId(shopId)`
Láº¥y tÃªn shop tá»« users array:
```js
const shopData = users?.find(u => u.id === shopId || u.uid === shopId);
return shopData?.shopName || `QuÃ¡n #${shopId}`;
```

### `validatePhoneNumber(phone)`
Validate sá»‘ Ä‘iá»‡n thoáº¡i Viá»‡t Nam:
```js
const vnf_regex = /((09|03|07|08|05)+([0-9]{8})\b)/g;
return vnf_regex.test(phone.trim());
```

### `handleOpenConfirm()`
Kiá»ƒm tra trÆ°á»›c khi má»Ÿ modal xÃ¡c nháº­n:
- Cart khÃ´ng rá»—ng
- Guest: pháº£i nháº­p Ä‘áº§y Ä‘á»§ name/phone/address vÃ  phone há»£p lá»‡
- User: pháº£i cÃ³ address vÃ  phone trong profile

### `handleConfirmOrder()`
Táº¡o Ä‘Æ¡n hÃ ng má»›i:
```js
const orderId = `FOOD-${Date.now()}`;
const newOrder = {
  orderId, userId, userName, userPhone, address,
  items: cart.map(item => ({...item, shopName: getShopNameFromId(item.shopId)})),
  totalFood: subTotal, baseShip, extraStepFee, shopCount, discount, finalTotal,
  shipType, status: 'pending', paymentMethod: 'COD',
  createdAt: new Date().toISOString(),
  isGuest: isGuestUser || !currentUser,
  promoCode: appliedPromo?.code || "",
  logs: [...]
};
await addDoc(collection(db, 'foodOrders'), newOrder);
```

### Logic tÃ­nh phÃ­ ship theo sá»‘ shop
```js
const uniqueShopsCount = new Set(cart.map(item => item.shopId)).size;
const extraStepFee = uniqueShopsCount > 1 ? (uniqueShopsCount - 1) * stepPrice : 0;
const totalShipFee = baseShipFee + extraStepFee;
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header (TiÃªu Ä‘á» "Giá» hÃ ng" + NÃºt "XÃ³a háº¿t")
  â”‚
  â”œâ”€ FlatList (Cart Items)
  â”‚   â””â”€ renderItem: Card mÃ³n
  â”‚       â”œâ”€ Image
  â”‚       â”œâ”€ Name + Options + Price + Shop
  â”‚       â””â”€ Quantity Box (+/-)
  â”‚
  â””â”€ ScrollView (Summary)
      â”œâ”€ Section: ThÃ´ng tin giao hÃ ng (guest only)
      â”‚   â””â”€ 3 TextInput: TÃªn/SÄT/Äá»‹a chá»‰
      â”‚
      â”œâ”€ Section: Æ¯u Ä‘Ã£i (Promo Tickets)
      â”‚   â””â”€ ScrollView ngang: Danh sÃ¡ch promo
      â”‚
      â”œâ”€ Section: HÃ¬nh thá»©c nháº­n hÃ ng (náº¿u normal â‰  atDoor)
      â”‚   â””â”€ 2 buttons: Táº¡i sáº£nh / Táº¡i cá»­a
      â”‚
      â”œâ”€ Price Container
      â”‚   â”œâ”€ Táº¡m tÃ­nh
      â”‚   â”œâ”€ PhÃ­ ship
      â”‚   â”œâ”€ PhÃ­ thÃªm quÃ¡n (náº¿u > 1 shop)
      â”‚   â”œâ”€ Giáº£m giÃ¡ (náº¿u cÃ³ promo)
      â”‚   â””â”€ Tá»”NG Cá»˜NG
      â”‚
      â””â”€ Button: Äáº¶T HÃ€NG NGAY

Modal (XÃ¡c nháº­n Ä‘Æ¡n hÃ ng)
  â”œâ”€ Icon help-circle
  â”œâ”€ Text: "XÃ¡c nháº­n Ä‘áº·t hÃ ng?"
  â”œâ”€ Text: Sá»‘ shop (náº¿u > 1)
  â””â”€ 2 Buttons: Há»¦Y / Äá»’NG Ã
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

1. **Guest Support:** Hiá»ƒn thá»‹ form nháº­p thÃ´ng tin giao hÃ ng cho guest (`!currentUser || currentUser && !currentUser.password`)
2. **Multi-shop Order:** TÃ­nh phÃ­ thÃªm quÃ¡n náº¿u Ä‘Æ¡n hÃ ng cÃ³ mÃ³n tá»« nhiá»u shop khÃ¡c nhau
3. **Promo Types:**
   - `percent`: Giáº£m % (cÃ³ maxDiscount)
   - `freeship`: Giáº£m phÃ­ ship (tá»‘i Ä‘a = totalShipFee)
   - `fixed`: Giáº£m sá»‘ tiá»n cá»‘ Ä‘á»‹nh
4. **Ship Type Toggle:** Chá»‰ hiá»‡n khi `normalShipPrice !== atDoorShipPrice`
5. **Success Screen:** Hiá»ƒn thá»‹ icon checkmark + nÃºt "TIáº¾P Tá»¤C MUA Sáº®M"
6. **Point Reward:** Cá»™ng `Math.floor(finalTotal / 10)` Ä‘iá»ƒm cho user (khÃ´ng cá»™ng guest)
7. **ShopName in items:** Má»—i mÃ³n trong order Ä‘Æ°á»£c gáº¯n thÃªm `shopName` Ä‘á»ƒ dá»… hiá»ƒn thá»‹
8. **Logs Array:** LÆ°u lá»‹ch sá»­ Ä‘Æ¡n hÃ ng ngay tá»« lÃºc táº¡o
9. **Price Calculation Fix:** TÃ­nh táº¡m tÃ­nh bao gá»“m cáº£ `extraPrice` tá»« option
10. **Modal Overlay:** DÃ¹ng transparent background + fade animation

## ğŸš€ USER JOURNEY

**KhÃ¡ch vÃ£ng lai:**
1. VÃ o Cart (Ä‘Ã£ thÃªm mÃ³n tá»« ItemDetail)
2. Nháº­p thÃ´ng tin: TÃªn, SÄT, Äá»‹a chá»‰
3. Chá»n promo (náº¿u cÃ³)
4. Chá»n hÃ¬nh thá»©c giao hÃ ng
5. Nháº¥n Äáº¶T HÃ€NG NGAY
6. XÃ¡c nháº­n modal â†’ ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o
7. MÃ n hÃ¬nh thÃ nh cÃ´ng â†’ Quay home

**User thÆ°á»ng:**
1. VÃ o Cart (Ä‘Ã£ cÃ³ SÄT vÃ  Ä‘á»‹a chá»‰ trong profile)
2. Chá»n promo (náº¿u cÃ³)
3. Chá»n hÃ¬nh thá»©c giao hÃ ng
4. Nháº¥n Äáº¶T HÃ€NG NGAY
5. XÃ¡c nháº­n modal â†’ ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o
6. MÃ n hÃ¬nh thÃ nh cÃ´ng â†’ Quay home
7. Nháº­n Ä‘iá»ƒm thÆ°á»Ÿng

## ğŸ”— NAVIGATION

**Navigates TO:**
- `/(tabs)/home` (sau khi Ä‘áº·t hÃ ng thÃ nh cÃ´ng)

**Navigates FROM:**
- `home.tsx` (nÃºt giá» hÃ ng)
- Bottom tab navigation

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

1. **Guest Detection:** `const isGuestUser = currentUser && !currentUser.password`
2. **Order ID format:** `FOOD-{timestamp}`
3. **Item Price Calculation:**
   ```js
   const itemPrice = (item.pricePromo || item.priceNormal) * 1000;
   const optionPrice = item.extraPrice || 0;
   const totalPrice = (itemPrice + optionPrice) * item.quantity;
   ```
4. **shipConfig tá»« system:**
   ```js
   const shipConfig = system?.ship?.food;
   const normalShipPrice = shipConfig?.normalValue || 11;
   const atDoorShipPrice = shipConfig?.atDoorValue || 15;
   const stepPrice = shipConfig?.step || 5;
   ```
5. **Promo filter:** Chá»‰ hiá»ƒn thá»‹ promo cÃ³ `enable = true`
6. **Promo UI:** Active promo cÃ³ background COLORS.primary, inactive cÃ³ background #fff
7. **Validation flow:** Validate trÆ°á»›c khi má»Ÿ modal, khÃ´ng validate láº¡i khi confirm
8. **Loading state:** Disable nÃºt khi Ä‘ang xá»­ lÃ½
9. **Clear cart:** Gá»i `clearCart()` sau khi táº¡o Ä‘Æ¡n thÃ nh cÃ´ng
10. **Payment method:** Hiá»‡n táº¡i hardcode `COD`, chÆ°a cÃ³ option khÃ¡c
11. **Alert platform-specific:** Web dÃ¹ng `window.alert()`, native dÃ¹ng `Alert.alert()`
12. **Image source:** Æ¯u tiÃªn `item.img`, fallback sang `item.image[0]` náº¿u lÃ  array
