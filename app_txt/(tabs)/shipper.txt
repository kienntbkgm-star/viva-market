# TÃ“M Táº®T LOGIC TRANG SHIPPER.TSX

## ðŸŽ¯ Má»¤C ÄÃCH
Tab dÃ nh riÃªng cho shipper Ä‘á»ƒ:
- Xem sáº£nh Ä‘Æ¡n hÃ ng (available orders - status pending)
- Nháº­n Ä‘Æ¡n hÃ ng (chuyá»ƒn sang processing)
- Xem Ä‘Æ¡n Ä‘ang giao (my processing orders)
- HoÃ n thÃ nh Ä‘Æ¡n (chuyá»ƒn sang completed + táº¡o transaction ná»£)
- Xem lá»‹ch sá»­ Ä‘Æ¡n Ä‘Ã£ giao (completed orders)

## ðŸ“Š STATE & DATA

**Store:**
- `foodOrders`: danh sÃ¡ch Ä‘Æ¡n hÃ ng food
- `currentUser`: thÃ´ng tin shipper hiá»‡n táº¡i
- `system`: cáº¥u hÃ¬nh há»‡ thá»‘ng (shipperShipRatio)

**Local State:**
- `activeTab`: 'available' | 'my_orders' | 'completed'

**Computed Values:**
- `availableOrders`: ÄÆ¡n pending (chÆ°a cÃ³ shipper)
- `myOrders`: ÄÆ¡n processing cá»§a shipper nÃ y
- `completedOrders`: ÄÆ¡n completed cá»§a shipper nÃ y
- `shipperRatio`: % tiá»n ship shipper nháº­n (default 70%)
- `adminRatio`: % tiá»n ship admin nháº­n (default 30%)

## ðŸ”„ LUá»’NG THá»°C THI

### Tab Available (Sáº£nh Ä‘Æ¡n)
1. Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n `status === 'pending'`
2. Shipper nháº¥n "NHáº¬N ÄÆ N"
3. Check `currentUser.isReady`:
   - Náº¿u false â†’ Alert "Báº­t tráº¡ng thÃ¡i Sáºµn sÃ ng"
   - Náº¿u true â†’ Update Firestore:
     - `status = 'processing'`
     - `shipperId = currentUser.id`
     - ThÃªm log "Shipper Ä‘Ã£ nháº­n Ä‘Æ¡n"
4. Chuyá»ƒn sang tab "Äang giao"

### Tab My Orders (Äang giao)
1. Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n `status === 'processing' && shipperId === currentUser.id`
2. Shipper nháº¥n "ÄÃƒ GIAO"
3. TÃ­nh toÃ¡n tiá»n:
   - `totalShip = baseShip + extraStepFee`
   - `adminShare = totalShip * adminRatio / 100`
   - `netDebt = adminShare - discount` (lÃ m trÃ²n 3 chá»¯ sá»‘ tháº­p phÃ¢n)
4. Update Firestore:
   - `status = 'completed'`
   - ThÃªm log "Shipper Ä‘Ã£ giao hÃ ng thÃ nh cÃ´ng"
5. Táº¡o transaction (náº¿u COD):
   - `type: 'DEBT'`
   - `amount: netDebt`
   - `desc: 'PhÃ­ ship Ä‘Æ¡n #{orderId}'`
6. Alert thÃ nh cÃ´ng

### Tab Completed (Lá»‹ch sá»­)
1. Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n `status === 'completed' && shipperId === currentUser.id`
2. Chá»‰ xem, khÃ´ng cÃ³ hÃ nh Ä‘á»™ng

## ðŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### `handleReceiveOrder(item)`
Nháº­n Ä‘Æ¡n tá»« sáº£nh:
```js
if (!currentUser?.isReady) {
  Alert.alert("ChÆ°a sáºµn sÃ ng", "Vui lÃ²ng báº­t tráº¡ng thÃ¡i 'Sáºµn sÃ ng' trong Há»“ sÆ¡...");
  return;
}
await updateDoc(orderRef, {
  status: 'processing',
  shipperId: currentUser.id,
  logs: arrayUnion({ content: 'Shipper Ä‘Ã£ nháº­n Ä‘Æ¡n', status: 'processing', time: ... })
});
setActiveTab('my_orders');
```

### `handleCompleteOrder(item)`
HoÃ n thÃ nh Ä‘Æ¡n:
```js
const totalShip = (item.baseShip || 0) + (item.extraStepFee || 0);
const adminShare = (totalShip * adminRatio) / 100;
const discount = item.discount || 0;
const netDebt = Math.round((adminShare - discount) * 1000) / 1000; // LÃ m trÃ²n 3 chá»¯ sá»‘

await updateDoc(orderRef, {
  status: 'completed',
  logs: arrayUnion({ content: 'Shipper Ä‘Ã£ giao hÃ ng thÃ nh cÃ´ng', status: 'completed', time: ... })
});

if (item.paymentMethod === 'COD') {
  await addDoc(collection(db, 'transactions'), {
    userId: currentUser.id,
    userName: currentUser.name,
    type: 'DEBT',
    amount: netDebt,
    orderId: item.orderId || item.id,
    desc: `PhÃ­ ship Ä‘Æ¡n #${item.orderId || item.id}`,
    createdAt: new Date().toISOString(),
    performedBy: 'system'
  });
}
```

### Logic tÃ­nh tiá»n
```js
const totalShip = (item.baseShip || 0) + (item.extraStepFee || 0);
const shipperEarn = (totalShip * shipperRatio) / 100; // CÃ´ng shipper nháº­n
const adminShare = (totalShip * adminRatio) / 100; // Admin nháº­n
const debtAmount = adminShare - (item.discount || 0); // Ná»£ = adminShare - giáº£m giÃ¡
```

## ðŸŽ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Greeting: "ChÃ o Shipper, {name}"
  â”‚   â””â”€ Wallet Button â†’ /shipper/finance
  â”‚
  â”œâ”€ Tabs (3 tabs)
  â”‚   â”œâ”€ Sáº£nh Ä‘Æ¡n (availableOrders.length)
  â”‚   â”œâ”€ Äang giao (myOrders.length)
  â”‚   â””â”€ Lá»‹ch sá»­
  â”‚
  â””â”€ Content
      â”œâ”€ (Náº¿u available tab vÃ  !isReady)
      â”‚   â””â”€ Not Ready Container
      â”‚       â”œâ”€ Icon alert-circle
      â”‚       â”œâ”€ Title: "Báº¡n chÆ°a báº­t tráº¡ng thÃ¡i sáºµn sÃ ng"
      â”‚       â”œâ”€ Desc: "Vui lÃ²ng báº­t..."
      â”‚       â””â”€ Button: "ÄI Äáº¾N Há»’ SÆ "
      â”‚
      â””â”€ (Náº¿u ready hoáº·c tab khÃ¡c)
          â””â”€ FlatList (orders)
              â””â”€ renderOrderItem: Order Card (tap vÃ o â†’ /admin/order-detail)
                  â”œâ”€ Header: #{orderId} + Time
                  â”œâ”€ Address Box
                  â”‚   â”œâ”€ Person: userName - userPhone
                  â”‚   â””â”€ Location: address
                  â”œâ”€ Footer
                  â”‚   â”œâ”€ Left:
                  â”‚   â”‚   â”œâ”€ Thu khÃ¡ch: finalTotal
                  â”‚   â”‚   â”œâ”€ CÃ´ng: shipperEarn (náº¿u processing/completed)
                  â”‚   â”‚   â””â”€ Ná»™p Admin: debtAmount (náº¿u processing/completed)
                  â”‚   â””â”€ Right:
                  â”‚       â”œâ”€ Button "NHáº¬N ÄÆ N" (available)
                  â”‚       â””â”€ Button "ÄÃƒ GIAO" (my_orders)
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

1. **isReady Guard:** Shipper pháº£i báº­t "Sáºµn sÃ ng hÃ´m nay" trong profile trÆ°á»›c khi nháº­n Ä‘Æ¡n
2. **Not Ready Screen:** Hiá»ƒn thá»‹ khi available tab vÃ  !isReady, cÃ³ nÃºt Ä‘i Ä‘áº¿n profile
3. **Full Order ID Display:** Hiá»ƒn thá»‹ full `orderId` (VD: FOOD-1234567890) thay vÃ¬ substring
4. **Transaction Auto-create:** Tá»± Ä‘á»™ng táº¡o transaction DEBT khi hoÃ n thÃ nh Ä‘Æ¡n COD
5. **netDebt Rounding:** LÃ m trÃ²n 3 chá»¯ sá»‘ tháº­p phÃ¢n Ä‘á»ƒ trÃ¡nh lá»—i sá»‘ dÃ i
6. **Debt Color Coding:**
   - `debtAmount >= 0` â†’ #E67E22 (cam) "Ná»™p Admin"
   - `debtAmount < 0` â†’ #27AE60 (xanh) "Admin bÃ¹"
7. **Tab Badge:** Sá»‘ lÆ°á»£ng Ä‘Æ¡n hiá»ƒn thá»‹ trong label tab
8. **Address Box:** Background #F8F9FA, icons person + location
9. **Order Card Tap:** Navigate Ä‘áº¿n `/admin/order-detail` vá»›i orderId params
10. **Wallet Button:** Icon wallet-membership, background #FFF4E5

## ðŸš€ USER JOURNEY

**Shipper chÆ°a sáºµn sÃ ng:**
1. VÃ o Shipper tab â†’ Tab "Sáº£nh Ä‘Æ¡n"
2. Tháº¥y thÃ´ng bÃ¡o "Báº¡n chÆ°a báº­t tráº¡ng thÃ¡i sáºµn sÃ ng"
3. Nháº¥n "ÄI Äáº¾N Há»’ SÆ "
4. Báº­t Switch "Sáºµn sÃ ng hÃ´m nay" trong profile
5. Quay láº¡i Shipper tab â†’ Tháº¥y sáº£nh Ä‘Æ¡n

**Shipper Ä‘Ã£ sáºµn sÃ ng:**
1. VÃ o Shipper tab â†’ Tháº¥y sáº£nh Ä‘Æ¡n (pending orders)
2. Nháº¥n "NHáº¬N ÄÆ N" trÃªn Ä‘Æ¡n muá»‘n giao
3. Chuyá»ƒn sang tab "Äang giao" â†’ Tháº¥y Ä‘Æ¡n vá»«a nháº­n
4. Giao hÃ ng cho khÃ¡ch
5. Nháº¥n "ÄÃƒ GIAO"
6. ÄÆ¡n chuyá»ƒn sang tab "Lá»‹ch sá»­"
7. Transaction ná»£ Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng

**Xem vÃ­ ná»£:**
8. Nháº¥n icon VÃ­ ná»£ (header) â†’ Shipper finance page

## ðŸ”— NAVIGATION

**Navigates TO:**
- `/shipper/finance` (nÃºt wallet header)
- `/profile` (nÃºt "ÄI Äáº¾N Há»’ SÆ " khi chÆ°a ready)
- `/admin/order-detail` (tap vÃ o order card, vá»›i orderId params)

**Navigates FROM:**
- Bottom tab navigation (shipper tab)

## ðŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

1. **shipperShipRatio Config:**
   ```js
   const shipperRatio = system?.money?.shipperShipRatio || 70;
   const adminRatio = 100 - shipperRatio;
   ```
2. **Filter Queries:**
   ```js
   availableOrders: order.status === 'pending'
   myOrders: order.status === 'processing' && order.shipperId === currentUser?.id
   completedOrders: order.status === 'completed' && order.shipperId === currentUser?.id
   ```
3. **Transaction Structure:**
   ```js
   {
     userId: string,
     userName: string,
     type: 'DEBT',
     amount: number,
     orderId: string,
     desc: string,
     createdAt: ISO string,
     performedBy: 'system'
   }
   ```
4. **Math.round() Fix:** TrÃ¡nh sá»‘ tháº­p phÃ¢n dÃ i (VD: 12.999999999998):
   ```js
   Math.round((adminShare - discount) * 1000) / 1000
   ```
5. **orderId Priority:** Æ¯u tiÃªn `item.orderId`, fallback `item.id`
6. **Time Display:**
   ```js
   new Date(item.createdAt).toLocaleTimeString('vi-VN')
   ```
7. **Price Format:**
   ```js
   ((finalTotal || 0) * 1000).toLocaleString() + 'Ä‘'
   ```
8. **Switch Tab After Action:** `setActiveTab('my_orders')` sau khi nháº­n Ä‘Æ¡n
9. **Alert Platform-specific:** Web `window.alert()`, Native `Alert.alert()`
10. **COD Check:** Chá»‰ táº¡o transaction náº¿u `paymentMethod === 'COD'`
11. **Tab Active Style:** Border bottom COLORS.primary khi active
12. **No Loading State:** Giáº£ Ä‘á»‹nh foodOrders Ä‘Ã£ load xong
13. **numberOfLines:** Address text cÃ³ `numberOfLines={2}`
14. **Card Touch:** `onPress={() => router.push({ pathname: '/admin/order-detail', params: { orderId } })}`
15. **Wallet Text:** "VÃ­ ná»£" (khÃ´ng pháº£i "VÃ­ cÃ´ng ná»£")

## ðŸ” TÃNH TOÃN TIá»€N CHI TIáº¾T

**VÃ­ dá»¥:**
- `totalShip = 15` (baseShip 11 + extraStepFee 4)
- `shipperRatio = 70%`
- `adminRatio = 30%`
- `discount = 5`

**Káº¿t quáº£:**
- `shipperEarn = 15 * 70 / 100 = 10.5` (shipper nháº­n)
- `adminShare = 15 * 30 / 100 = 4.5` (admin nháº­n tá»« phÃ­ ship)
- `netDebt = 4.5 - 5 = -0.5` (admin bÃ¹ láº¡i shipper 0.5k vÃ¬ discount > adminShare)

**Hiá»ƒn thá»‹:**
- Thu khÃ¡ch: 115k (finalTotal)
- CÃ´ng: 10.5k
- Admin bÃ¹: 500Ä‘ (mÃ u xanh)
