# TÃ“M Táº®T LOGIC TRANG ORDERS.TSX

## ğŸ¯ Má»¤C ÄÃCH
Trang lá»‹ch sá»­ Ä‘Æ¡n hÃ ng thá»©c Äƒn cá»§a user hiá»‡n táº¡i:
- Hiá»ƒn thá»‹ táº¥t cáº£ Ä‘Æ¡n hÃ ng food theo userId
- Xem chi tiáº¿t tá»«ng Ä‘Æ¡n: mÃ³n Äƒn, giÃ¡, phÃ­ ship, log hÃ nh trÃ¬nh
- Há»§y Ä‘Æ¡n hÃ ng (chá»‰ khi status = pending/pendding)
- Realtime update tá»« Firestore
- Sáº¯p xáº¿p Ä‘Æ¡n theo Æ°u tiÃªn: pending â†’ confirmed â†’ shipping â†’ completed â†’ cancelled

## ğŸ“Š STATE & DATA

**Store:**
- `currentUser`: thÃ´ng tin user hiá»‡n táº¡i (láº¥y userId Ä‘á»ƒ query)

**Local State:**
- `orders`: danh sÃ¡ch Ä‘Æ¡n hÃ ng food cá»§a user (realtime tá»« Firestore)
- `loading`: tráº¡ng thÃ¡i Ä‘ang táº£i

**Firestore Listener:**
Query Ä‘Æ¡n hÃ ng theo `userId = currentUser.id` tá»« collection `foodOrders`, sáº¯p xáº¿p theo `createdAt desc`

## ğŸ”„ LUá»’NG THá»°C THI

1. **Load dá»¯ liá»‡u:**
   - Láº¥y `currentUser.id`
   - Query Firestore: `where('userId', '==', targetId)` + `orderBy('createdAt', 'desc')`
   - Realtime listener: `onSnapshot()`
2. **Sáº¯p xáº¿p Ä‘Æ¡n:**
   - Priority: pending(1) â†’ confirmed(2) â†’ shipping(3) â†’ completed(4) â†’ cancelled(5)
   - Náº¿u cÃ¹ng priority thÃ¬ sáº¯p xáº¿p theo `createdAt` giáº£m dáº§n
3. **Hiá»ƒn thá»‹ Ä‘Æ¡n:** FlatList vá»›i renderOrderItem
4. **Há»§y Ä‘Æ¡n:** Chá»‰ cho phÃ©p khi status = pending/pendding
   - Hiá»‡n confirm dialog
   - Update Firestore: `status = 'cancelled'` + thÃªm log
5. **Real-time update:** Má»—i khi cÃ³ thay Ä‘á»•i trÃªn Firestore â†’ update UI

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### `formatCurrency(val)`
Chuyá»ƒn Ä‘á»•i sá»‘ sang Ä‘á»‹nh dáº¡ng VNÄ:
```js
(val * 1000).toLocaleString('vi-VN')
```

### `getStatusColor(status)`
Tráº£ vá» mÃ u sáº¯c cho tá»«ng tráº¡ng thÃ¡i:
- `pending/pendding` â†’ #F39C12 (cam)
- `confirmed` â†’ #3498DB (xanh dÆ°Æ¡ng)
- `shipping` â†’ #9B59B6 (tÃ­m)
- `completed` â†’ #27AE60 (xanh lÃ¡)
- `cancelled` â†’ #E74C3C (Ä‘á»)

### `getStatusText(status)`
Chuyá»ƒn Ä‘á»•i status code sang text tiáº¿ng Viá»‡t:
- `pending/pendding` â†’ "Chá» xÃ¡c nháº­n"
- `confirmed` â†’ "Äang chuáº©n bá»‹"
- `shipping` â†’ "Äang giao hÃ ng"
- `completed` â†’ "ÄÃ£ hoÃ n thÃ nh"
- `cancelled` â†’ "ÄÃ£ há»§y"

### `handleCancelOrder(order)`
Logic há»§y Ä‘Æ¡n:
```js
if (status !== 'pending' && status !== 'pendding') return;
// Confirm dialog
await updateDoc(orderRef, {
  status: 'cancelled',
  logs: arrayUnion({
    time: new Date().toISOString(),
    content: currentUser ? "NgÆ°á»i dÃ¹ng Ä‘Ã£ há»§y Ä‘Æ¡n hÃ ng" : "KhÃ¡ch vÃ£ng lai Ä‘Ã£ há»§y Ä‘Æ¡n hÃ ng",
    status: 'cancelled'
  })
});
```

### Logic sáº¯p xáº¿p Ä‘Æ¡n hÃ ng
```js
const priority = { 'pending': 1, 'pendding': 1, 'confirmed': 2, 'shipping': 3, 'completed': 4, 'cancelled': 5 };
const pA = priority[a.status?.toLowerCase()] || 99;
const pB = priority[b.status?.toLowerCase()] || 99;
if (pA !== pB) return pA - pB;
return new Date(b.createdAt) - new Date(a.createdAt);
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button (arrow-back)
  â”‚   â””â”€ Title: "ÄÆ¡n hÃ ng cá»§a tÃ´i"
  â”‚
  â””â”€ FlatList (orders)
      â””â”€ renderOrderItem: Order Card
          â”œâ”€ Order Header
          â”‚   â”œâ”€ MÃ£ Ä‘Æ¡n
          â”‚   â”œâ”€ Thá»i gian táº¡o
          â”‚   â””â”€ NÃºt "Há»§y" (náº¿u pending)
          â”‚
          â”œâ”€ Status Badge (mÃ u theo status)
          â”‚
          â”œâ”€ Item Section
          â”‚   â””â”€ Danh sÃ¡ch mÃ³n: "â€¢ Name x Quantity"
          â”‚
          â”œâ”€ Price Section
          â”‚   â”œâ”€ Tiá»n mÃ³n
          â”‚   â”œâ”€ PhÃ­ váº­n chuyá»ƒn gá»‘c
          â”‚   â”œâ”€ PhÃ­ thÃªm shop (náº¿u > 1 shop)
          â”‚   â”œâ”€ Giáº£m giÃ¡ (náº¿u cÃ³)
          â”‚   â””â”€ Tá»•ng thanh toÃ¡n
          â”‚
          â””â”€ Log Section (HÃ nh trÃ¬nh Ä‘Æ¡n hÃ ng)
              â””â”€ Danh sÃ¡ch logs: Dot + Time + Content
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

1. **Realtime Listener:** DÃ¹ng `onSnapshot()` Ä‘á»ƒ tá»± Ä‘á»™ng update khi cÃ³ thay Ä‘á»•i
2. **Status Normalization:** Xá»­ lÃ½ cáº£ "pending" vÃ  "pendding" (lá»—i typo trong DB)
3. **Cancel Permission:** Chá»‰ cho há»§y Ä‘Æ¡n khi status = pending/pendding
4. **Log Color Coding:** Má»—i log cÃ³ mÃ u dot theo status (pending/cancelled/completed)
5. **Priority Sorting:** ÄÆ¡n pending luÃ´n lÃªn Ä‘áº§u, completed/cancelled xuá»‘ng dÆ°á»›i
6. **Empty State:** Hiá»ƒn thá»‹ icon + text "Báº¡n chÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o"
7. **Loading State:** ActivityIndicator khi Ä‘ang query Firestore
8. **Platform-specific Confirm:** Web dÃ¹ng `window.confirm()`, native dÃ¹ng `Alert.alert()`
9. **Order ID Display:** Æ¯u tiÃªn `orderId`, fallback sang `id.substring(0,8)`
10. **Back Navigation:** NÃºt back vá» trang trÆ°á»›c (`router.back()`)

## ğŸš€ USER JOURNEY

**User thÆ°á»ng:**
1. VÃ o Orders (tá»« profile hoáº·c bottom tab)
2. Xem danh sÃ¡ch Ä‘Æ¡n hÃ ng (pending á»Ÿ trÃªn)
3. Nháº¥n nÃºt "Há»§y" náº¿u muá»‘n há»§y Ä‘Æ¡n pending
4. XÃ¡c nháº­n dialog â†’ ÄÆ¡n chuyá»ƒn sang cancelled
5. Xem chi tiáº¿t mÃ³n, giÃ¡, log hÃ nh trÃ¬nh
6. Nháº¥n Back Ä‘á»ƒ quay láº¡i

**KhÃ¡ch vÃ£ng lai:**
(TÆ°Æ¡ng tá»± user thÆ°á»ng, náº¿u Ä‘Ã£ cÃ³ Ä‘Æ¡n tá»« session hiá»‡n táº¡i)

## ğŸ”— NAVIGATION

**Navigates TO:**
- (ChÆ°a navigate Ä‘i Ä‘Ã¢u tá»« trang nÃ y, chá»‰ hiá»ƒn thá»‹)

**Navigates FROM:**
- `/profile` (nÃºt "Lá»‹ch sá»­ Ä‘Æ¡n hÃ ng")
- Bottom tab navigation

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

1. **Query condition:**
   ```js
   where('userId', '==', targetId)
   orderBy('createdAt', 'desc')
   ```
2. **Listener cleanup:** Return `unsubscribe()` trong useEffect Ä‘á»ƒ trÃ¡nh memory leak
3. **Status lowercase:** LuÃ´n chuyá»ƒn vá» lowercase trÆ°á»›c khi so sÃ¡nh
4. **Time format:**
   ```js
   new Date(createdAt).toLocaleString('vi-VN')
   new Date(log.time).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})
   ```
5. **Firestore update vá»›i arrayUnion:**
   ```js
   await updateDoc(orderRef, {
     status: 'cancelled',
     logs: arrayUnion({ time, content, status })
   });
   ```
6. **Loading timeout:** Náº¿u khÃ´ng cÃ³ user, set timeout 2s rá»“i táº¯t loading
7. **Error handling:** Catch lá»—i query vÃ  set loading = false
8. **Log structure:** `{ time: ISO string, content: string, status: string }`
9. **Order structure:** `{ id, orderId, userId, userName, userPhone, address, items[], totalFood, baseShip, extraStepFee, discount, finalTotal, shipType, status, paymentMethod, createdAt, isGuest, promoCode, logs[] }`
10. **numberOfLines:** MÃ³n Äƒn truncate vá»›i `numberOfLines={1}`
11. **Status priority map:** Hardcode trong component, khÃ´ng lÆ°u trong DB
12. **Small cancel button:** Nhá» gá»n, chá»‰ text "Há»§y", border Ä‘á»
