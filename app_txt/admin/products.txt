# T√ìM T·∫ÆT LOGIC TRANG ADMIN/PRODUCTS.TSX

## üéØ M·ª§C ƒê√çCH
Qu·∫£n l√Ω danh s√°ch m√≥n ƒÉn/ƒë·ªì u·ªëng:
- Hi·ªÉn th·ªã t·∫•t c·∫£ foods t·ª´ Firestore
- B·∫≠t/t·∫Øt tr·∫°ng th√°i m√≥n (enable/disable)
- T√¨m ki·∫øm theo t√™n ho·∫∑c ID
- **XU·∫§T Excel** (Export) - Header chu·∫©n DB
- **NH·∫¨P Excel** (Import) - Header chu·∫©n DB
- Navigate ƒë·∫øn edit-food ƒë·ªÉ ch·ªânh s·ª≠a chi ti·∫øt

## üìä STATE & DATA

**Store:**
- `foods`: Danh s√°ch m√≥n ƒÉn t·ª´ collection `foods`

**Local State:**
- `searchQuery`: T·ª´ kh√≥a t√¨m ki·∫øm
- `isProcessing`: Tr·∫°ng th√°i ƒëang x·ª≠ l√Ω import/export

**Excel Structure (Header chu·∫©n DB):**
```
id, name, type, priceNormal, pricePromo, shopId, status, timeStart, timeEnd,
note, orderCount, index, img, image, option
```

## üîÑ LU·ªíNG TH·ª∞C THI

### Display Flow
1. Load `foods` t·ª´ store
2. Filter theo `searchQuery` (t√¨m trong name ho·∫∑c id)
3. Hi·ªÉn th·ªã FlatList v·ªõi card m√≥n
4. M·ªói card c√≥ Switch b·∫≠t/t·∫Øt

### Toggle Status
1. Nh·∫•n Switch
2. G·ªçi `handleToggleStatus(id, currentStatus)`
3. Toggle `enable ‚Üî disable`
4. Update Firestore `foods/{id}`

### Export Excel
1. Nh·∫•n n√∫t Export (cloud-download)
2. Map foods array th√†nh format Excel:
   - `option`: Array ‚Üí String format "Size L (+8k), Th·∫°ch (+2k)"
   - `image`: Array ‚Üí String ngƒÉn c√°ch xu·ªëng d√≤ng
3. T·∫°o Excel file b·∫±ng XLSX library
4. **Web:** T·ª± ƒë·ªông download
5. **Mobile:** Share file qua Sharing API

### Import Excel
1. Nh·∫•n n√∫t Import (cloud-upload)
2. Ch·ªçn file Excel (.xlsx)
3. Parse file th√†nh JSON array
4. Loop qua t·ª´ng row:
   - Parse `option` string ‚Üí Array objects `{name, price, status, index}`
   - Parse `image` string ‚Üí Array URLs
   - Map c√°c field v√†o payload
5. Batch write v√†o Firestore (merge mode)
6. Alert th√†nh c√¥ng v·ªõi s·ªë m√≥n nh·∫≠p ƒë∆∞·ª£c

## üîß C√ÅC FUNCTION QUAN TR·ªåNG

### `handleToggleStatus(id, currentStatus)`
B·∫≠t/t·∫Øt m√≥n:
```js
const newStatus = currentStatus === 'enable' ? 'disable' : 'enable';
await updateDoc(doc(db, 'foods', id.toString()), { status: newStatus });
```

### `handleExportExcel()`
Xu·∫•t danh s√°ch:
```js
const dataToExport = foods.map(item => {
  const optionsString = (item.option || [])
    .map(opt => `${opt.name} (+${opt.price}k)`)
    .join(', ');
  const imagesString = (item.image || []).join('\n');
  
  return {
    id: item.id,
    name: item.name,
    // ... all fields
    option: optionsString,
    image: imagesString
  };
});

const ws = XLSX.utils.json_to_sheet(dataToExport);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "MenuData");
const fileName = `DB_Foods_${Date.now()}.xlsx`;

// Web: XLSX.writeFile(wb, fileName);
// Mobile: FileSystem + Sharing
```

### `handleImportExcel()`
Nh·∫≠p t·ª´ file:
```js
// Parse options: "Size L (+8k), Th·∫°ch (+2k)"
let optionList = [];
if (row["option"]) {
  const rawOpts = row["option"].toString().split(',');
  rawOpts.forEach((str, idx) => {
    const match = str.trim().match(/^(.*)\s\(\+(\d+)k\)$/);
    if (match) {
      optionList.push({
        name: match[1].trim(),
        price: parseInt(match[2]),
        status: true,
        index: idx + 1
      });
    }
  });
}

// Parse images: "url1\nurl2\nurl3"
let imageList = [];
if (row["image"]) {
  imageList = row["image"].toString().split(/[,\n]+/).map(s => s.trim()).filter(Boolean);
}

const payload = { id, name, type, priceNormal, pricePromo, shopId, status, ... };
batch.set(docRef, payload, { merge: true });
```

## üé® UI C·∫§U TR√öC

```
SafeAreaView
  ‚îú‚îÄ Header
  ‚îÇ   ‚îú‚îÄ Back Button
  ‚îÇ   ‚îú‚îÄ Title: "Qu·∫£n l√Ω th·ª±c ƒë∆°n"
  ‚îÇ   ‚îî‚îÄ Button Group
  ‚îÇ       ‚îú‚îÄ Import Button (cloud-upload, #2980B9)
  ‚îÇ       ‚îú‚îÄ Export Button (cloud-download, #27AE60)
  ‚îÇ       ‚îî‚îÄ Add Button (add, primary color)
  ‚îÇ
  ‚îú‚îÄ Search Container
  ‚îÇ   ‚îî‚îÄ TextInput: "T√¨m t√™n m√≥n ho·∫∑c ID..."
  ‚îÇ
  ‚îî‚îÄ FlatList (Product Cards)
      ‚îî‚îÄ renderProductItem: Card
          ‚îú‚îÄ Image (80x80)
          ‚îú‚îÄ Info
          ‚îÇ   ‚îú‚îÄ Row: Name + ID + Switch
          ‚îÇ   ‚îú‚îÄ Price (pricePromo + oldPrice strikethrough)
          ‚îÇ   ‚îú‚îÄ Time: timeStart - timeEnd
          ‚îÇ   ‚îî‚îÄ Status Label (ƒêang b√°n/T·∫°m ngh·ªâ/ƒê√£ ·∫©n)
          ‚îÇ
          ‚îî‚îÄ onPress: Navigate to /admin/edit-food
```

## ‚ö° ƒêI·ªÇM ƒê·∫∂C BI·ªÜT

1. **Header chu·∫©n DB:** Export/Import d√πng ƒë√∫ng t√™n field trong Firestore (kh√¥ng vi·∫øt hoa, kh√¥ng th√™m k√Ω t·ª±)
2. **Option Format:** String "T√™n (+Gi√° k)" cho d·ªÖ edit trong Excel
3. **Image Array:** NgƒÉn c√°ch b·ªüi xu·ªëng d√≤ng trong Excel
4. **Batch Write:** D√πng `writeBatch` ƒë·ªÉ import nhi·ªÅu m√≥n c√πng l√∫c (hi·ªáu su·∫•t cao)
5. **Merge Mode:** `{merge: true}` ƒë·ªÉ kh√¥ng ghi ƒë√® to√†n b·ªô document
6. **Platform Specific:** Web d√πng `XLSX.writeFile()`, Mobile d√πng `FileSystem + Sharing`
7. **ID Generation:** N·∫øu Excel thi·∫øu ID ‚Üí T·∫°o `Date.now() + random`
8. **Status Toggle:** Switch c√≥ `stopPropagation` ƒë·ªÉ kh√¥ng trigger navigate
9. **Disabled Card:** Opacity 0.8 khi `effectiveStatus !== 'enable'`
10. **ActivityIndicator:** Hi·ªán spinner khi ƒëang import/export

## üöÄ USER JOURNEY

**Admin:**
1. V√†o Admin Products t·ª´ dashboard
2. Xem danh s√°ch m√≥n
3. **Export:** Nh·∫•n n√∫t Export ‚Üí Download Excel
4. **Edit Excel:** M·ªü file, s·ª≠a m√≥n, th√™m m√≥n m·ªõi
5. **Import:** Nh·∫•n n√∫t Import ‚Üí Ch·ªçn file ‚Üí Confirm
6. **Toggle m√≥n:** Nh·∫•n Switch ƒë·ªÉ b·∫≠t/t·∫Øt
7. **Edit m√≥n:** Nh·∫•n card ‚Üí Edit-food page

## üîó NAVIGATION

**Navigates TO:**
- `/admin/edit-food` (nh·∫•n card ho·∫∑c n√∫t Add)

**Navigates FROM:**
- `/admin` (dashboard menu "Qu·∫£n l√Ω M√≥n ƒÉn")

## üí° L∆ØU √ù K·ª∏ THU·∫¨T

1. **Excel Column Names:**
   - Ph·∫£i match ch√≠nh x√°c v·ªõi field trong Firestore
   - Vi·∫øt th∆∞·ªùng: `id`, `name`, `priceNormal` (kh√¥ng ph·∫£i `ID`, `Name`, `Price_Normal`)
2. **Option Parse Regex:**
   ```js
   /^(.*)\s\(\+(\d+)k\)$/
   ```
   Match format: "T√™n (+S·ªë k)"
3. **Image Split:**
   ```js
   .split(/[,\n]+/)
   ```
   Support c·∫£ d·∫•u ph·∫©y v√† xu·ªëng d√≤ng
4. **Number Conversion:**
   ```js
   priceNormal: Number(row["priceNormal"]) || 0
   ```
   Fallback v·ªÅ 0 n·∫øu r·ªóng
5. **Time Fields:** `timeStart`, `timeEnd` l√† number (0-24)
6. **Status Values:** 'enable' | 'disable' (string)
7. **effectiveStatus:** Copy t·ª´ `status` ƒë·ªÉ sync
8. **isOutOfTime:** M·∫∑c ƒë·ªãnh `false` khi import
9. **Image Fallback:** N·∫øu kh√¥ng c√≥ `image` array, d√πng `img` field
10. **Batch Limit:** Firestore batch t·ªëi ƒëa 500 ops (c·∫ßn split n·∫øu import > 500)
11. **File Extension:** `.xlsx` (OpenXML format), kh√¥ng support `.xls` c≈©
12. **Mobile Permissions:** C·∫ßn permission ƒë·ªçc file tr√™n Android/iOS
13. **Error Handling:** Wrap trong try-catch, alert l·ªói cho user
14. **Loading State:** Disable n√∫t Import/Export khi `isProcessing = true`
15. **Success Message:** Alert s·ªë m√≥n ƒë√£ import th√†nh c√¥ng

## üîç SO S√ÅNH V·ªöI SERVICES/PROMOS/USERS

**Gi·ªëng:**
- C√πng pattern Import/Export Excel
- C√πng c·∫•u tr√∫c UI: Header + Search + List + Toggle
- C√πng navigate ƒë·∫øn edit page

**Kh√°c:**
- Products: Parse ph·ª©c t·∫°p (option, image array)
- Products: C√≥ logic time (timeStart, timeEnd)
- Products: C√≥ shopId field (thu·ªôc v·ªÅ shop c·ª• th·ªÉ)
- Services: C√≥ moneyShare field (% chia s·∫ª)
- Promos: C√≥ usedBy array, durationDays
- Users: C√≥ nhi·ªÅu field nh·∫•t (role, password, checkIn...)
