# TÃ“M Táº®T LOGIC TRANG ADMIN/USERS.TSX

## ğŸ¯ Má»¤C ÄÃCH
Quáº£n lÃ½ danh sÃ¡ch ngÆ°á»i dÃ¹ng:
- Hiá»ƒn thá»‹ táº¥t cáº£ users tá»« Firestore
- TÃ¬m kiáº¿m theo tÃªn, SÄT, ID
- Báº­t/táº¯t tráº¡ng thÃ¡i tÃ i khoáº£n (enable/disable)
- Hiá»ƒn thá»‹ role badge vá»›i mÃ u sáº¯c khÃ¡c nhau
- **XUáº¤T Excel** (Export) - Header chuáº©n DB
- **NHáº¬P Excel** (Import) - Header chuáº©n DB
- Navigate Ä‘áº¿n edit-user Ä‘á»ƒ chá»‰nh sá»­a chi tiáº¿t

## ğŸ“Š STATE & DATA

**Store:**
- `users`: Danh sÃ¡ch ngÆ°á»i dÃ¹ng tá»« collection `users`

**Local State:**
- `searchQuery`: Tá»« khÃ³a tÃ¬m kiáº¿m
- `isProcessing`: Tráº¡ng thÃ¡i Ä‘ang xá»­ lÃ½ import/export

**Excel Structure (Header chuáº©n DB):**
```
id, uid, name, phone, role, status, address, shopName, password, expoToken, 
point, imgShop, imgShopSquare, mustCheckIn, checkInDate, index
```

**Role Colors:**
- `admin` â†’ #E74C3C (Ä‘á»)
- `chá»§ shop` â†’ #E67E22 (cam)
- `manager` â†’ #3498DB (xanh dÆ°Æ¡ng)
- `shipper` â†’ #9B59B6 (tÃ­m)
- `user` â†’ #7F8C8D (xÃ¡m)

## ğŸ”„ LUá»’NG THá»°C THI

### Display Flow
1. Load `users` tá»« store
2. Filter theo searchQuery (tÃ¬m trong name, phone, id)
3. Hiá»ƒn thá»‹ FlatList vá»›i user card
4. Card cÃ³ avatar (chá»¯ cÃ¡i Ä‘áº§u), role badge, Switch

### Toggle Status
1. Nháº¥n Switch
2. Gá»i `handleToggleUserStatus(userId, currentStatus)`
3. Toggle `enable â†” disable`
4. Update Firestore `users/{userId}`

### Export Excel
1. Nháº¥n nÃºt Export
2. Map users array vá»›i táº¥t cáº£ 16 fields
3. **LÆ°u Ã½:** Export cáº£ `password` (plaintext) - cáº©n tháº­n báº£o máº­t
4. Download file: `DB_Users_{timestamp}.xlsx`

### Import Excel
1. Nháº¥n nÃºt Import
2. Parse file
3. Generate ID náº¿u thiáº¿u: `Date.now() + random`
4. Generate uid náº¿u thiáº¿u: `user_{id}`
5. Password máº·c Ä‘á»‹nh: "123456" náº¿u thiáº¿u
6. Batch write â†’ Alert success

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### `handleToggleUserStatus(userId, currentStatus)`
```js
const newStatus = currentStatus === 'enable' ? 'disable' : 'enable';
const userRef = doc(db, 'users', userId.toString());
await updateDoc(userRef, { status: newStatus });
```

### `getRoleColor(role)`
```js
switch (role) {
  case 'admin': return '#E74C3C';
  case 'chá»§ shop': return '#E67E22';
  case 'manager': return '#3498DB';
  case 'shipper': return '#9B59B6';
  default: return '#7F8C8D';
}
```

### `handleExportExcel()`
```js
const dataToExport = users.map(user => ({
  id: user.id,
  uid: user.uid || '',
  name: user.name,
  phone: user.phone,
  role: user.role,
  status: user.status,
  address: user.address || '',
  shopName: user.shopName || '',
  password: user.password || '', // âš ï¸ Plaintext
  expoToken: user.expoToken || '',
  point: user.point || 0,
  imgShop: user.imgShop || '',
  imgShopSquare: user.imgShopSquare || '',
  mustCheckIn: user.mustCheckIn || 'disable',
  checkInDate: user.checkInDate || '',
  index: user.index || 0
}));
```

### `handleImportExcel()`
```js
const rawID = row["id"];
const docId = (rawID && rawID.toString().trim() !== "") 
  ? rawID.toString() 
  : Math.floor(Date.now() + Math.random() * 1000).toString();

const payload = {
  id: Number(docId),
  uid: row["uid"] || `user_${docId}`,
  name: row["name"] || "NgÆ°á»i dÃ¹ng má»›i",
  phone: row["phone"] || "",
  role: row["role"] || "user",
  status: row["status"] || "enable",
  address: row["address"] || "",
  shopName: row["shopName"] || "",
  password: row["password"] || "123456",
  expoToken: row["expoToken"] || "",
  point: row["point"] || "",
  imgShop: row["imgShop"] || "",
  imgShopSquare: row["imgShopSquare"] || "",
  mustCheckIn: row["mustCheckIn"] || "disable",
  checkInDate: row["checkInDate"] || "",
  index: Number(row["index"]) || 0,
  log: []
};
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button
  â”‚   â”œâ”€ Title: "Quáº£n lÃ½ ngÆ°á»i dÃ¹ng"
  â”‚   â””â”€ Button Group
  â”‚       â”œâ”€ Import (#2980B9)
  â”‚       â””â”€ Export (#27AE60)
  â”‚
  â”œâ”€ Search Container
  â”‚   â””â”€ TextInput: "TÃ¬m tÃªn, SÄT hoáº·c ID..."
  â”‚
  â””â”€ FlatList (User Cards)
      â””â”€ renderUserItem: Card
          â”œâ”€ Avatar (chá»¯ cÃ¡i Ä‘áº§u, background primary)
          â”œâ”€ Info
          â”‚   â”œâ”€ Row: Name + ID + Role Badge
          â”‚   â”œâ”€ Phone
          â”‚   â”œâ”€ Address
          â”‚   â”œâ”€ Shop Name (náº¿u cÃ³)
          â”‚   â””â”€ Status Row: Dot + Label + Switch
          â”‚
          â””â”€ onPress: Navigate to /admin/edit-user
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

1. **Password Export:** Export plaintext password (âš ï¸ báº£o máº­t thá»±c táº¿ cáº§n mÃ£ hÃ³a)
2. **Role Badge:** MÃ u sáº¯c theo role (admin/shop/manager/shipper/user)
3. **Avatar Text:** Chá»¯ cÃ¡i Ä‘áº§u tÃªn user, uppercase
4. **Shop Name:** Chá»‰ hiá»ƒn thá»‹ náº¿u user cÃ³ shopName
5. **Status Indicator:** Dot + Text (Hoáº¡t Ä‘á»™ng/ÄÃ£ khÃ³a)
6. **Switch stopPropagation:** KhÃ´ng trigger navigate card
7. **ID Generation:** Timestamp + random náº¿u thiáº¿u
8. **uid Fallback:** `user_{id}` náº¿u thiáº¿u
9. **Password Default:** "123456" náº¿u khÃ´ng cÃ³
10. **log Reset:** Array rá»—ng khi import
11. **mustCheckIn:** 'enable' | 'disable' (string)
12. **checkInDate:** String hoáº·c rá»—ng
13. **point Field:** Sá»‘ Ä‘iá»ƒm tÃ­ch lÅ©y (thÆ°á»ng rá»—ng hoáº·c 0)
14. **imgShop vs imgShopSquare:** 2 áº£nh khÃ¡c nhau cho shop
15. **No Add Button:** KhÃ´ng cÃ³ nÃºt Add (user tá»± Ä‘Äƒng kÃ½)

## ğŸš€ USER JOURNEY

**Admin:**
1. VÃ o Admin Users tá»« dashboard
2. TÃ¬m kiáº¿m user theo tÃªn/SÄT/ID
3. **Export:** Backup danh sÃ¡ch user (bao gá»“m password)
4. **Edit Excel:** Sá»­a role, status, thÃ´ng tin
5. **Import:** Nháº­p láº¡i há»‡ thá»‘ng
6. **Lock/Unlock:** Toggle Switch Ä‘á»ƒ khÃ³a/má»Ÿ tÃ i khoáº£n
7. **Edit Detail:** Nháº¥n card â†’ Edit-user page

## ğŸ”— NAVIGATION

**Navigates TO:**
- `/admin/edit-user` (nháº¥n card)

**Navigates FROM:**
- Admin dashboard menu "Quáº£n lÃ½ NgÆ°á»i dÃ¹ng"

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

1. **id vs uid:**
   - `id`: Number, primary key (VD: 123)
   - `uid`: String, Firebase Auth UID (VD: "user_123")
2. **password:** Plaintext (khÃ´ng hash) - Cáº§n cáº£i thiá»‡n báº£o máº­t thá»±c táº¿
3. **role Values:** 'admin', 'chá»§ shop', 'manager', 'shipper', 'user'
4. **status Values:** 'enable', 'disable' (string)
5. **expoToken:** Push notification token (Expo)
6. **mustCheckIn:** Shop owner cÃ³ thá»ƒ báº¯t buá»™c check-in
7. **checkInDate:** NgÃ y check-in cuá»‘i (format string)
8. **point:** Äiá»ƒm tÃ­ch lÅ©y tá»« Ä‘Æ¡n hÃ ng (Math.floor(finalTotal / 10))
9. **imgShop:** áº¢nh shop (hÃ¬nh chá»¯ nháº­t)
10. **imgShopSquare:** áº¢nh shop (hÃ¬nh vuÃ´ng) - dÃ¹ng cho badge
11. **index:** Thá»© tá»± sáº¯p xáº¿p (khÃ´ng dÃ¹ng trong UI nÃ y)
12. **log Array:** Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng (reset khi import)
13. **Search Case:** Lowercase search, khÃ´ng bá» dáº¥u
14. **Filter Query:**
    ```js
    user.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    user.phone?.toString().includes(searchQuery) ||
    user.id?.toString().includes(searchQuery)
    ```
15. **numberOfLines:** name: 1, address: 1 Ä‘á»ƒ trÃ¡nh card quÃ¡ cao

## ğŸ” SO SÃNH Vá»šI PRODUCTS/SERVICES/PROMOS

**Giá»‘ng:**
- Import/Export Excel pattern
- Toggle switch
- Search bar
- Navigate edit page

**KhÃ¡c:**
- Users: Nhiá»u field nháº¥t (16 fields)
- Users: CÃ³ password plaintext
- Users: CÃ³ role badge vá»›i mÃ u
- Users: CÃ³ avatar vá»›i chá»¯ cÃ¡i
- Users: KhÃ´ng cÃ³ Add button (user tá»± register)
- Users: CÃ³ shop-specific fields (shopName, imgShop)
- Users: CÃ³ check-in fields
- Users: CÃ³ expoToken cho push notification

## âš ï¸ Báº¢O Máº¬T

**Cáº¢NH BÃO:** 
- Export password plaintext lÃ  Rá»¦I RO báº£o máº­t cao
- Thá»±c táº¿ nÃªn:
  1. Hash password trÆ°á»›c khi lÆ°u
  2. KhÃ´ng export password
  3. Hoáº·c mÃ£ hÃ³a file Excel
  4. Giá»›i háº¡n quyá»n admin download
