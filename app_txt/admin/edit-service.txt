# TÃ“M Táº®T LOGIC TRANG ADMIN/EDIT-SERVICE.TSX

## ğŸ¯ Má»¤C ÄÃCH
MÃ n hÃ¬nh thÃªm/sá»­a dá»‹ch vá»¥ (repair & cleaning):
- ThÃªm dá»‹ch vá»¥ má»›i hoáº·c cáº­p nháº­t dá»‹ch vá»¥ cÃ³ sáºµn
- Cáº¥u hÃ¬nh giÃ¡, % chia sáº» admin (moneyShare)
- Quáº£n lÃ½ tráº¡ng thÃ¡i, thá»© tá»± hiá»ƒn thá»‹
- ÄÆ¡n giáº£n hÆ¡n edit-food (khÃ´ng cÃ³ options, khÃ´ng upload áº£nh)

## ğŸ“Š STATE & DATA

**Store:**
- `services`: Danh sÃ¡ch dá»‹ch vá»¥ (load Ä‘á»ƒ edit)

**Route Params:**
- `id`: ID dá»‹ch vá»¥ (náº¿u edit), undefined náº¿u táº¡o má»›i

**Local State:**
```js
loading: boolean // Tráº¡ng thÃ¡i Ä‘ang save
formData: {
  name: string,
  priceNormal: string,    // GiÃ¡ gá»‘c (k)
  pricePromo: string,     // GiÃ¡ bÃ¡n (k)
  moneyShare: string,     // % cho Admin (VD: "20")
  image: string,          // URL áº£nh (nháº­p tay)
  status: 'enable' | 'disable',
  index: string,          // Thá»© tá»± hiá»ƒn thá»‹
  shopId: string,         // Máº·c Ä‘á»‹nh 209 (shop dá»‹ch vá»¥)
  note: string
}
```

## ğŸ”„ LUá»’NG THá»°C THI

### 1. Load Data (Edit Mode)
```js
useEffect(() => {
  if (id && services) {
    const service = services.find(s => s.id === id);
    if (service) {
      setFormData({
        ...service,
        priceNormal: service.priceNormal?.toString() || '',
        pricePromo: service.pricePromo?.toString() || '',
        moneyShare: service.moneyShare?.toString() || '0',
        index: service.index?.toString() || '0',
        shopId: service.shopId?.toString() || '209'
      });
    }
  }
}, [id, services]);
```

### 2. Save to Firestore
```js
const handleSave = async () => {
  // Validation
  if (!formData.name || !formData.pricePromo || !formData.image) {
    Alert.alert("Lá»—i", "Vui lÃ²ng nháº­p TÃªn, GiÃ¡ bÃ¡n vÃ  Link áº£nh dá»‹ch vá»¥");
    return;
  }
  
  setLoading(true);
  
  try {
    const serviceId = id || Date.now().toString();
    const serviceRef = doc(db, 'services', serviceId);
    
    const finalData = {
      ...formData,
      id: isNaN(Number(serviceId)) ? serviceId : Number(serviceId),
      name: formData.name.trim(),
      priceNormal: Number(formData.priceNormal),
      pricePromo: Number(formData.pricePromo),
      moneyShare: Number(formData.moneyShare), // % cho Admin
      index: Number(formData.index),
      shopId: Number(formData.shopId),
      status: formData.status,
      log: [] // Reset log array
    };
    
    if (id) {
      await updateDoc(serviceRef, finalData);
    } else {
      await setDoc(serviceRef, finalData, { merge: true });
    }
    
    Alert.alert("ThÃ nh cÃ´ng", "ÄÃ£ lÆ°u thÃ´ng tin dá»‹ch vá»¥");
    router.back();
  } catch (error) {
    Alert.alert("Lá»—i", "KhÃ´ng thá»ƒ lÆ°u dá»¯ liá»‡u: " + error.message);
  } finally {
    setLoading(false);
  }
};
```

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### No Image Upload Function
- KhÃ¡c vá»›i edit-food, khÃ´ng cÃ³ upload áº£nh
- User nháº­p trá»±c tiáº¿p URL áº£nh (tá»« Imgur, ImgBB, v.v.)
- LÃ½ do: Dá»‹ch vá»¥ Ã­t áº£nh hÆ¡n, cÃ³ thá»ƒ dÃ¹ng áº£nh cÃ³ sáºµn

### Number Parsing
```js
// Convert string â†’ number before save
priceNormal: Number(formData.priceNormal)
pricePromo: Number(formData.pricePromo)
moneyShare: Number(formData.moneyShare)
index: Number(formData.index)
shopId: Number(formData.shopId)
```

### ID Handling
```js
// Create: Date.now() string
// Parse: Náº¿u lÃ  sá»‘ â†’ Number, náº¿u khÃ´ng â†’ giá»¯ string
const serviceId = id || Date.now().toString();
const finalId = isNaN(Number(serviceId)) ? serviceId : Number(serviceId);
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button
  â”‚   â”œâ”€ Title: "Cáº­p nháº­t dá»‹ch vá»¥" / "ThÃªm dá»‹ch vá»¥ má»›i"
  â”‚   â”‚   â””â”€ ID Subtitle (náº¿u edit)
  â”‚   â””â”€ Save Button (Loading indicator náº¿u Ä‘ang save)
  â”‚
  â””â”€ KeyboardAvoidingView
      â””â”€ ScrollView (Form Container)
          â”œâ”€ TÃªn dá»‹ch vá»¥ (TextInput)
          â”œâ”€ Link áº£nh (Image URL) (TextInput)
          â”œâ”€ Row 1:
          â”‚   â”œâ”€ GiÃ¡ gá»‘c (K)
          â”‚   â””â”€ GiÃ¡ bÃ¡n (K)
          â”œâ”€ Row 2:
          â”‚   â”œâ”€ % Cho Admin (moneyShare)
          â”‚   â””â”€ Sá»‘ thá»© tá»± hiá»ƒn thá»‹ (index)
          â”œâ”€ Ghi chÃº dá»‹ch vá»¥ (TextInput multiline)
          â””â”€ KÃ­ch hoáº¡t dá»‹ch vá»¥ (Switch)
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

### MoneyShare Field
1. **Ã nghÄ©a:**
   - % tiá»n admin nháº­n tá»« dá»‹ch vá»¥
   - VD: moneyShare=20 â†’ Admin nháº­n 20% giÃ¡ dá»‹ch vá»¥
   - Shop nháº­n 80% cÃ²n láº¡i

2. **Default Value:** "20" (20%)

3. **Calculation Example:**
   ```js
   pricePromo = 50k
   moneyShare = 20%
   
   adminMoney = 50 * 0.20 = 10k
   shopMoney = 50 * 0.80 = 40k
   ```

### Shop ID Field
4. **Default:** "209" (ID shop dá»‹ch vá»¥ chung)
5. **Purpose:** PhÃ¢n biá»‡t dá»‹ch vá»¥ thuá»™c shop nÃ o
6. **Note:** KhÃ´ng validate shopId tá»“n táº¡i

### Image Handling
7. **No Upload:** User nháº­p trá»±c tiáº¿p URL
8. **Placeholder:** `"https://i.imgur.com/..."`
9. **Validation:** Required field

### Status Switch
10. **Values:**
    - `enable`: Dá»‹ch vá»¥ kÃ­ch hoáº¡t
    - `disable`: Dá»‹ch vá»¥ táº¡m khÃ³a
11. **Switch Colors:**
    - false: #D1D1D1 (gray)
    - true: #27AE60 (green)

### Log Field
12. **Reset on Save:** `log: []`
13. **Purpose:** Tracking changes history (not implemented yet)

### Loading State
14. **Button Disabled:** `disabled={loading}`
15. **Show Spinner:** `<ActivityIndicator />` thay text "LÆ°u"

## ğŸš€ USER JOURNEY

### Admin - ThÃªm dá»‹ch vá»¥ má»›i
1. Navigate to `/admin/edit-service` (khÃ´ng cÃ³ id param)
2. Nháº­p tÃªn dá»‹ch vá»¥: "Thay lÃµi lá»c nÆ°á»›c"
3. Nháº­p link áº£nh: "https://i.imgur.com/..."
4. Nháº­p giÃ¡:
   - GiÃ¡ gá»‘c: 50k
   - GiÃ¡ bÃ¡n: 40k (giáº£m giÃ¡)
5. Cáº¥u hÃ¬nh % cho Admin: 20%
6. Chá»n thá»© tá»± hiá»ƒn thá»‹: index=1
7. Nháº­p ghi chÃº (optional)
8. Báº­t/táº¯t tráº¡ng thÃ¡i (Switch)
9. Nháº¥n "LÆ°u" â†’ Táº¡o document má»›i trong Firestore
10. Alert "ThÃ nh cÃ´ng" â†’ Back to services list

### Admin - Sá»­a dá»‹ch vá»¥ cÃ³ sáºµn
1. Navigate to `/admin/edit-service?id=123`
2. Load data tá»« `services.find(s => s.id === id)`
3. Populate form vá»›i data hiá»‡n táº¡i
4. Sá»­a cÃ¡c trÆ°á»ng cáº§n thiáº¿t (giÃ¡, %, ghi chÃº, v.v.)
5. Nháº¥n "LÆ°u" â†’ Update document trong Firestore
6. Alert "ThÃ nh cÃ´ng" â†’ Back to services list

## ğŸ”— NAVIGATION

**Navigates TO:** KhÃ´ng (modal-style screen)

**Navigates FROM:**
- Admin Services page â†’ Nháº¥n "Sá»­a" trÃªn service card
- Admin Services page â†’ Nháº¥n "ThÃªm dá»‹ch vá»¥ má»›i"

**Back Navigation:**
- Back button (header left)
- After save success â†’ `router.back()`

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

### Firestore Operations
1. **Collection:** `services`
2. **Document ID:**
   - Edit: Use existing `id`
   - Create: `Date.now().toString()` (timestamp string)
3. **Update vs SetDoc:**
   - Edit: `updateDoc(serviceRef, finalData)`
   - Create: `setDoc(serviceRef, finalData, { merge: true })`
4. **Merge Option:** `{ merge: true }` Ä‘á»ƒ khÃ´ng overwrite toÃ n bá»™ doc

### Service Structure
```js
{
  id: number | string,
  name: string,
  priceNormal: number,   // GiÃ¡ gá»‘c (nghÃ¬n Ä‘á»“ng)
  pricePromo: number,    // GiÃ¡ bÃ¡n (nghÃ¬n Ä‘á»“ng)
  moneyShare: number,    // % cho Admin (0-100)
  image: string,         // URL áº£nh (single, khÃ´ng pháº£i array)
  status: 'enable' | 'disable',
  index: number,         // Thá»© tá»± hiá»ƒn thá»‹
  shopId: number,        // Default 209
  note: string,
  log: []                // Empty array (future use)
}
```

### So SÃ¡nh vá»›i edit-food.tsx
| Feature | edit-food | edit-service |
|---------|-----------|--------------|
| **Image Upload** | âœ… ImgBB integration | âŒ Manual URL input |
| **Options** | âœ… Complex options array | âŒ No options |
| **Time Config** | âœ… timeStart/timeEnd | âŒ No time restriction |
| **Type** | âœ… Ä‘á»“ Äƒn/Ä‘á»“ uá»‘ng | âŒ No type field |
| **MoneyShare** | âŒ No moneyShare | âœ… % cho Admin |
| **Complexity** | High (694 lines) | Low (213 lines) |

### Validation Rules
5. **Required Fields:**
   - âœ… `name`: KhÃ´ng rá»—ng
   - âœ… `pricePromo`: KhÃ´ng rá»—ng, pháº£i lÃ  sá»‘
   - âœ… `image`: KhÃ´ng rá»—ng (URL)

6. **Optional Fields:**
   - `priceNormal`: CÃ³ thá»ƒ rá»—ng (convert vá» 0)
   - `note`: CÃ³ thá»ƒ rá»—ng
   - `moneyShare`: Default "20" náº¿u rá»—ng

7. **No Validation:**
   - Image URL format (khÃ´ng check URL há»£p lá»‡)
   - ShopId existence (khÃ´ng check shop tá»“n táº¡i)
   - Price range (cÃ³ thá»ƒ Ã¢m? â†’ NÃªn validate)

### KeyboardAvoidingView
8. **Behavior:**
   - iOS: `"padding"`
   - Android: `"height"` (khÃ¡c vá»›i edit-food dÃ¹ng null)

### Form Layout
9. **Input Groups:**
   - Full width: name, image, note
   - Row (2 columns): priceNormal+pricePromo, moneyShare+index

10. **Spacing:**
    - marginBottom: 20 per inputGroup
    - marginRight: 10 for left column in row

11. **Input Style:**
    - backgroundColor: #fff
    - borderWidth: 1
    - borderColor: #DDD
    - borderRadius: 12
    - padding: 12

### Status Container
12. **Layout:**
    - flexDirection: row
    - justifyContent: space-between
    - backgroundColor: #F9F9F9
    - padding: 15
    - borderRadius: 12

### Save Button State
13. **Normal:** Text "LÆ°u", color primary, fontWeight bold
14. **Loading:** ActivityIndicator size="small" color primary
15. **Disabled:** opacity 0.5 (trong styles.saveBtn)

### Error Handling
16. **Network Error:**
    - Alert "Lá»—i", "KhÃ´ng thá»ƒ lÆ°u dá»¯ liá»‡u: [error.message]"

17. **Validation Error:**
    - Alert "Lá»—i", "Vui lÃ²ng nháº­p TÃªn, GiÃ¡ bÃ¡n vÃ  Link áº£nh dá»‹ch vá»¥"

### State Management
18. **Local State Only:** KhÃ´ng update Zustand store
19. **Firestore Auto-update:** Store listener tá»± Ä‘á»™ng fetch data má»›i
20. **No Optimistic Update:** Chá» save xong má»›i back

## ğŸ¯ USE CASES

### 1. Thay lÃµi lá»c nÆ°á»›c
```js
{
  name: "Thay lÃµi lá»c nÆ°á»›c",
  priceNormal: 50,
  pricePromo: 40,
  moneyShare: 20,  // Admin nháº­n 8k (20% of 40k)
  image: "https://i.imgur.com/water-filter.jpg",
  status: "enable",
  index: 1,
  shopId: 209,
  note: "Bao gá»“m váº­t tÆ° vÃ  cÃ´ng thay"
}
```

### 2. Sá»­a mÃ¡y giáº·t
```js
{
  name: "Sá»­a mÃ¡y giáº·t",
  priceNormal: 100,
  pricePromo: 80,
  moneyShare: 25,  // Admin nháº­n 20k (25% of 80k)
  image: "https://i.imgur.com/washing-machine.jpg",
  status: "enable",
  index: 2,
  shopId: 209,
  note: "GiÃ¡ chá»‰ Ã¡p dá»¥ng cho sá»­a chá»¯a cÆ¡ báº£n"
}
```

### 3. Vá»‡ sinh mÃ¡y láº¡nh
```js
{
  name: "Vá»‡ sinh mÃ¡y láº¡nh",
  priceNormal: 150,
  pricePromo: 150, // KhÃ´ng giáº£m giÃ¡
  moneyShare: 30,  // Admin nháº­n 45k (30% of 150k)
  image: "https://i.imgur.com/air-conditioner.jpg",
  status: "enable",
  index: 3,
  shopId: 209,
  note: "Dá»‹ch vá»¥ vá»‡ sinh sÃ¢u, thÃ¡o láº¯p mÃ¡y láº¡nh"
}
```

## ğŸ” MONEYSHARE CALCULATION

### Formula
```js
const adminMoney = pricePromo * (moneyShare / 100);
const shopMoney = pricePromo - adminMoney;
```

### Examples
| pricePromo | moneyShare | adminMoney | shopMoney |
|------------|------------|------------|-----------|
| 40k | 20% | 8k | 32k |
| 80k | 25% | 20k | 60k |
| 150k | 30% | 45k | 105k |
| 50k | 0% | 0k | 50k |
| 100k | 100% | 100k | 0k |

### Edge Cases
- **moneyShare = 0%:** Shop nháº­n toÃ n bá»™ (Admin khÃ´ng nháº­n)
- **moneyShare = 100%:** Admin nháº­n toÃ n bá»™ (Shop khÃ´ng nháº­n)
- **moneyShare > 100%:** KhÃ´ng validate (cÃ³ thá»ƒ nháº­p, nhÆ°ng khÃ´ng há»£p lÃ½)
- **moneyShare < 0%:** KhÃ´ng validate (cÃ³ thá»ƒ nháº­p, nhÆ°ng khÃ´ng há»£p lÃ½)

## ğŸš¨ MISSING FEATURES & IMPROVEMENTS

### Current Limitations
1. **No Image Upload:**
   - User pháº£i tá»± upload áº£nh lÃªn Imgur/ImgBB trÆ°á»›c
   - Copy URL rá»“i paste vÃ o form
   - â†’ NÃªn thÃªm upload button nhÆ° edit-food

2. **No URL Validation:**
   - KhÃ´ng check image URL há»£p lá»‡
   - KhÃ´ng check áº£nh cÃ³ load Ä‘Æ°á»£c khÃ´ng
   - â†’ NÃªn thÃªm Image preview

3. **No Price Validation:**
   - CÃ³ thá»ƒ nháº­p giÃ¡ Ã¢m
   - CÃ³ thá»ƒ nháº­p pricePromo > priceNormal
   - â†’ NÃªn validate pricePromo <= priceNormal

4. **No MoneyShare Validation:**
   - CÃ³ thá»ƒ nháº­p > 100% hoáº·c < 0%
   - â†’ NÃªn validate 0 <= moneyShare <= 100

5. **No ShopId Validation:**
   - KhÃ´ng check shop tá»“n táº¡i
   - â†’ NÃªn dropdown select tá»« danh sÃ¡ch shops

### Suggested Improvements
6. **Image Upload:**
   ```js
   // ThÃªm nhÆ° edit-food
   <TouchableOpacity onPress={handlePickAndUpload}>
     <Ionicons name="cloud-upload-outline" />
   </TouchableOpacity>
   ```

7. **Image Preview:**
   ```js
   {formData.image && (
     <Image source={{ uri: formData.image }} style={styles.preview} />
   )}
   ```

8. **Validation:**
   ```js
   if (Number(formData.pricePromo) > Number(formData.priceNormal)) {
     Alert.alert("Lá»—i", "GiÃ¡ bÃ¡n khÃ´ng thá»ƒ lá»›n hÆ¡n giÃ¡ gá»‘c");
     return;
   }
   
   const share = Number(formData.moneyShare);
   if (share < 0 || share > 100) {
     Alert.alert("Lá»—i", "% cho Admin pháº£i tá»« 0-100");
     return;
   }
   ```

9. **Shop Dropdown:**
   ```js
   const shops = users.filter(u => u.role === 'chá»§ shop');
   <Picker
     selectedValue={formData.shopId}
     onValueChange={(v) => setFormData({...formData, shopId: v})}
   >
     {shops.map(s => <Picker.Item key={s.id} label={s.shopName} value={s.id} />)}
   </Picker>
   ```

10. **Loading Overlay:**
    - Hiá»‡n loading full screen khi Ä‘ang save
    - Disable toÃ n bá»™ form

## ğŸ“ DEVELOPER NOTES

### Code Quality
- âœ… TypeScript: `@ts-nocheck` (cáº§n enable type checking)
- âœ… Clean structure: Easy to understand
- âœ… KeyboardAvoidingView: Handle keyboard properly
- âš ï¸ No validation: Need more validation logic
- âš ï¸ No image upload: User experience not optimal

### Maintainability
- ğŸ“¦ 213 lines (compact, easy to maintain)
- ğŸ¨ Consistent styling with GlobalStyles
- ğŸ”„ Reusable pattern (similar to edit-promo, edit-user)

### Performance
- âš¡ Fast: No heavy operations
- âš¡ No unnecessary re-renders
- âš¡ Lightweight form

### Security
- âš ï¸ No input sanitization
- âš ï¸ No XSS protection for note field
- âš ï¸ No SQL injection (Firestore safe)
