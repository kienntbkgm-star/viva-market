# TÃ“M Táº®T LOGIC TRANG ADMIN/SERVICE-ORDER-DETAIL.TSX

## ğŸ¯ Má»¤C ÄÃCH
MÃ n hÃ¬nh chi tiáº¿t Ä‘Æ¡n dá»‹ch vá»¥ (admin view):
- Xem thÃ´ng tin yÃªu cáº§u dá»‹ch vá»¥ tá»« khÃ¡ch hÃ ng
- Hiá»ƒn thá»‹ khÃ¡ch hÃ ng, dá»‹ch vá»¥ yÃªu cáº§u, ghi chÃº
- Xem nháº­t kÃ½ xá»­ lÃ½
- Admin tiáº¿p nháº­n (pending â†’ processing)
- Admin hoÃ n thÃ nh (processing â†’ completed)
- Admin há»§y yÃªu cáº§u (â†’ cancelled)

## ğŸ“Š STATE & DATA

**Store:**
- `serviceOrders`: Danh sÃ¡ch Ä‘Æ¡n dá»‹ch vá»¥
- `services`: Danh sÃ¡ch dá»‹ch vá»¥ (Ä‘á»ƒ láº¥y image)
- `currentUser`: User Ä‘ang login (check role admin)

**Route Params:**
- `orderId`: ID cá»§a Ä‘Æ¡n dá»‹ch vá»¥ cáº§n xem

**Computed:**
```js
const order = useMemo(() => 
  serviceOrders.find(o => 
    String(o.orderId) === String(orderId) || 
    String(o.id) === String(orderId)
  )
, [orderId, serviceOrders]);

const serviceInfo = useMemo(() => {
  if (order?.serviceId) {
    return services.find(s => String(s.id) === String(order.serviceId));
  }
  return null;
}, [order, services]);

const isAdmin = currentUser?.role === 'admin';
```

## ğŸ”„ LUá»’NG THá»°C THI

### 1. Load Order & Service Info
```js
// Find order
const order = serviceOrders.find(o => o.orderId === orderId);

// Find service Ä‘á»ƒ láº¥y áº£nh
const serviceInfo = services.find(s => s.id === order.serviceId);
```

### 2. Update Status
```js
const updateStatus = async (newStatus, note) => {
  try {
    const orderRef = doc(db, 'serviceOrders', order.id || order.orderId);
    
    await updateDoc(orderRef, {
      status: newStatus,
      logs: arrayUnion({
        content: note,
        status: newStatus,
        time: new Date().toISOString()
      })
    });
    
    const msg = "ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n dá»‹ch vá»¥";
    if (Platform.OS === 'web') window.alert(msg);
    else Alert.alert("ThÃ nh cÃ´ng", msg);
  } catch (error) {
    Alert.alert("Lá»—i", "KhÃ´ng thá»ƒ cáº­p nháº­t Ä‘Æ¡n hÃ ng");
  }
};
```

### 3. Admin Actions
**Tiáº¿p nháº­n (pending â†’ processing):**
```js
updateStatus('processing', 'Admin Ä‘Ã£ tiáº¿p nháº­n yÃªu cáº§u');
```

**HoÃ n thÃ nh (processing â†’ completed):**
```js
updateStatus('completed', 'Dá»‹ch vá»¥ Ä‘Ã£ hoÃ n thÃ nh');
```

**Há»§y yÃªu cáº§u (â†’ cancelled):**
```js
updateStatus('cancelled', 'Admin Ä‘Ã£ há»§y yÃªu cáº§u');
```

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### Platform-Specific Alert
```js
const showAlert = (title, message, onPressOk) => {
  if (Platform.OS === 'web') {
    if (window.confirm(`${title}: ${message}`)) onPressOk();
  } else {
    Alert.alert(title, message, [
      { text: "Há»§y", style: "cancel" },
      { text: "Äá»“ng Ã½", onPress: onPressOk }
    ]);
  }
};
```

### Price Display
```js
// Service price (khÃ´ng cáº§n nhÃ¢n 1000, Ä‘Ã£ lÃ  Ä‘á»“ng)
(order.price || 0).toLocaleString() + 'Ä‘'
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button
  â”‚   â”œâ”€ Title: "Chi tiáº¿t Dá»‹ch vá»¥"
  â”‚   â””â”€ Spacer
  â”‚
  â””â”€ ScrollView
      â”œâ”€ Card: THÃ”NG TIN CHUNG
      â”‚   â”œâ”€ Order ID + Status Label
      â”‚   â””â”€ Created Time
      â”‚
      â”œâ”€ Card: THÃ”NG TIN KHÃCH HÃ€NG
      â”‚   â”œâ”€ Icon + Name
      â”‚   â”œâ”€ Icon + Phone
      â”‚   â””â”€ Icon + Address
      â”‚
      â”œâ”€ Card: Dá»ŠCH Vá»¤ YÃŠU Cáº¦U
      â”‚   â”œâ”€ Service Item
      â”‚   â”‚   â”œâ”€ Image (60x60)
      â”‚   â”‚   â”œâ”€ Service Name
      â”‚   â”‚   â”œâ”€ Shop Name (primary color)
      â”‚   â”‚   â””â”€ Note (italic)
      â”‚   â”œâ”€ Divider
      â”‚   â””â”€ Tá»”NG PHÃ Dá»° KIáº¾N (bold, primary)
      â”‚
      â”œâ”€ Card: NHáº¬T KÃ Xá»¬ LÃ
      â”‚   â””â”€ Log Items (map)
      â”‚       â”œâ”€ Dot (primary color)
      â”‚       â”œâ”€ Content
      â”‚       â””â”€ Time
      â”‚
      â””â”€ Admin Actions (náº¿u isAdmin && status khÃ´ng pháº£i completed/cancelled)
          â”œâ”€ TIáº¾P NHáº¬N button (náº¿u status = pending, mÃ u xanh #27AE60)
          â”œâ”€ HOÃ€N THÃ€NH button (náº¿u status = processing, mÃ u primary)
          â””â”€ Há»¦Y YÃŠU Cáº¦U button (border Ä‘á»)
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

### Service Order vs Food Order
1. **KhÃ¡c biá»‡t cÆ¡ báº£n:**
   - Food Order: Danh sÃ¡ch items, nhiá»u mÃ³n
   - Service Order: 1 dá»‹ch vá»¥ duy nháº¥t
   - Food Order: CÃ³ shipper giao hÃ ng
   - Service Order: Shop trá»±c tiáº¿p thá»±c hiá»‡n

2. **Price:**
   - Food: Tá»•ng tiá»n items + ship - discount
   - Service: Price cá»‘ Ä‘á»‹nh (dá»± kiáº¿n)
   - Service khÃ´ng cÃ³ ship fee, discount

### Service Info Display
3. **Image:**
   - Load tá»« `serviceInfo.image` (URL)
   - Fallback: Placeholder "https://via.placeholder.com/150"
   - Size: 60x60, borderRadius 8

4. **Service Name:**
   - `order.serviceName` (snapshot táº¡i thá»i Ä‘iá»ƒm Ä‘áº·t)
   - KhÃ´ng dÃ¹ng `serviceInfo.name` (cÃ³ thá»ƒ thay Ä‘á»•i)

5. **Shop Name:**
   - `order.shopName`
   - Color: primary
   - Hiá»ƒn thá»‹ Ä‘Æ¡n vá»‹ thá»±c hiá»‡n dá»‹ch vá»¥

6. **Note:**
   - `order.note` (ghi chÃº tá»« customer)
   - "KhÃ´ng cÃ³" náº¿u rá»—ng
   - Italic, gray color

### Status Flow
7. **Service Order States:**
   ```
   pending â†’ processing â†’ completed
              â†“
           cancelled
   ```

8. **Pending:**
   - YÃªu cáº§u má»›i, chá» admin tiáº¿p nháº­n
   - Action: TIáº¾P NHáº¬N

9. **Processing:**
   - Admin Ä‘Ã£ tiáº¿p nháº­n, Ä‘ang xá»­ lÃ½
   - Action: HOÃ€N THÃ€NH hoáº·c Há»¦Y

10. **Completed:**
    - Dá»‹ch vá»¥ Ä‘Ã£ hoÃ n thÃ nh
    - No more actions

11. **Cancelled:**
    - YÃªu cáº§u bá»‹ há»§y
    - No more actions

### Admin Actions Visibility
12. **Show Actions If:**
    - `isAdmin = true` AND
    - `status !== 'completed'` AND
    - `status !== 'cancelled'`

13. **Button Logic:**
    - Pending: Show "TIáº¾P NHáº¬N" + "Há»¦Y YÃŠU Cáº¦U"
    - Processing: Show "HOÃ€N THÃ€NH" + "Há»¦Y YÃŠU Cáº¦U"
    - Completed/Cancelled: Hide all buttons

### Price Field
14. **Field Name:** `price` (not `finalTotal`)
15. **Unit:** Äá»“ng (full, khÃ´ng pháº£i nghÃ¬n)
16. **Display:** `(order.price || 0).toLocaleString() + 'Ä‘'`
17. **Label:** "Tá»”NG PHÃ Dá»° KIáº¾N" (estimated, not final)

### Logs Display
18. **Same as Food Order:**
    - Dot + Content + Time
    - Chronological order

## ğŸš€ USER JOURNEY

### Customer - Äáº·t dá»‹ch vá»¥ (not in this file)
1. Customer vÃ o trang Services
2. Chá»n dá»‹ch vá»¥: "Thay lÃµi lá»c nÆ°á»›c"
3. Nháº­p ghi chÃº: "MÃ¡y lá»c 10 lÃµi, cáº§n thay cáº£ 10"
4. Nháº¥n "Äáº·t dá»‹ch vá»¥"
5. Táº¡o serviceOrder vá»›i status='pending'

### Admin - Tiáº¿p nháº­n yÃªu cáº§u
1. Navigate to `/admin/service-order-detail?orderId=123`
2. Load order data (status = 'pending')
3. Xem thÃ´ng tin:
   - Customer: TÃªn, SÄT, Äá»‹a chá»‰
   - Dá»‹ch vá»¥: Thay lÃµi lá»c nÆ°á»›c
   - Ghi chÃº: "MÃ¡y lá»c 10 lÃµi, cáº§n thay cáº£ 10"
   - GiÃ¡ dá»± kiáº¿n: 50,000Ä‘
4. Nháº¥n "TIáº¾P NHáº¬N"
5. Confirm â†’ updateStatus('processing', 'Admin Ä‘Ã£ tiáº¿p nháº­n yÃªu cáº§u')
6. Status â†’ 'processing'
7. Log má»›i Ä‘Æ°á»£c thÃªm

### Admin - HoÃ n thÃ nh dá»‹ch vá»¥
1. Shop Ä‘Ã£ thá»±c hiá»‡n xong dá»‹ch vá»¥
2. Admin vÃ o order detail (status = 'processing')
3. Nháº¥n "HOÃ€N THÃ€NH"
4. Confirm â†’ updateStatus('completed', 'Dá»‹ch vá»¥ Ä‘Ã£ hoÃ n thÃ nh')
5. Status â†’ 'completed'
6. Log má»›i Ä‘Æ°á»£c thÃªm
7. Admin actions hidden (completed)

### Admin - Há»§y yÃªu cáº§u
1. Customer há»§y hoáº·c khÃ´ng thá»ƒ thá»±c hiá»‡n
2. Admin nháº¥n "Há»¦Y YÃŠU Cáº¦U"
3. Confirm â†’ updateStatus('cancelled', 'Admin Ä‘Ã£ há»§y yÃªu cáº§u')
4. Status â†’ 'cancelled'
5. Admin actions hidden

## ğŸ”— NAVIGATION

**Navigates TO:** KhÃ´ng

**Navigates FROM:**
- Admin Orders page (service orders tab) â†’ Nháº¥n vÃ o order card

**Back Navigation:**
- Back button (header left) â†’ `router.back()`

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

### Firestore Operations
1. **Collection:** `serviceOrders`
2. **Document ID:** `order.id` hoáº·c `order.orderId`
3. **Update:** `updateDoc(orderRef, {...})`
4. **ArrayUnion:** Add log without overwriting

### Service Order Structure
```js
{
  id: string,
  orderId: string,           // Same as id
  userId: number,
  userName: string,
  userPhone: string,
  userAddress: string,       // hoáº·c address
  serviceId: number,
  serviceName: string,       // Snapshot at order time
  shopName: string,          // Shop thá»±c hiá»‡n dá»‹ch vá»¥
  note: string,              // Customer note
  price: number,             // Äá»“ng (full, not thousands)
  status: 'pending' | 'processing' | 'completed' | 'cancelled',
  logs: Array<{
    content: string,
    status: string,
    time: string
  }>,
  createdAt: string          // ISO timestamp
}
```

### Service Structure (Reference)
```js
{
  id: number,
  name: string,
  priceNormal: number,
  pricePromo: number,
  moneyShare: number,        // % cho Admin
  image: string,             // Single image URL
  status: 'enable' | 'disable',
  index: number,
  shopId: number,            // Shop thá»±c hiá»‡n
  note: string,
  log: []
}
```

### Address Field
5. **Flexible Naming:**
   - `order.userAddress` OR `order.address`
   - Check cáº£ 2 fields

### UseMemo Optimization
6. **Order Lookup:**
   - useMemo vá»›i deps: [orderId, serviceOrders]

7. **Service Lookup:**
   - useMemo vá»›i deps: [order, services]
   - Chá»‰ lookup náº¿u order tá»“n táº¡i

### Status Management
8. **No Reset Function:**
   - KhÃ¡c food order (khÃ´ng cÃ³ reset)
   - Service order khÃ´ng cáº§n reset vá» pending

9. **Linear Flow:**
   - Pending â†’ Processing â†’ Completed (one way)
   - Hoáº·c: Pending/Processing â†’ Cancelled

### Platform Differences
10. **Web Alert:** `window.confirm()`
11. **Mobile Alert:** `Alert.alert()`

### Price Display
12. **No Thousands:**
    - Service price lÃ  Ä‘á»“ng (full)
    - Food price lÃ  nghÃ¬n (k)
    - VD: Service 50000, Food 50

13. **Fallback:**
    - `order.price || 0` (náº¿u thiáº¿u price)

### Error Handling
14. **Order Not Found:**
    - Show error view vá»›i centered text

15. **Service Not Found:**
    - serviceInfo = null
    - Use placeholder image
    - serviceName váº«n hiá»ƒn thá»‹ tá»« order

### ScrollView
16. **contentContainerStyle:** `{ padding: 15 }`

## ğŸ” LOG EXAMPLES

### Service Order Timeline
```js
[
  {
    content: "YÃªu cáº§u dá»‹ch vá»¥ Ä‘Ã£ Ä‘Æ°á»£c táº¡o",
    status: "pending",
    time: "2026-01-27T10:00:00.000Z"
  },
  {
    content: "Admin Ä‘Ã£ tiáº¿p nháº­n yÃªu cáº§u",
    status: "processing",
    time: "2026-01-27T10:30:00.000Z"
  },
  {
    content: "Dá»‹ch vá»¥ Ä‘Ã£ hoÃ n thÃ nh",
    status: "completed",
    time: "2026-01-27T14:00:00.000Z"
  }
]
```

### Cancelled Timeline
```js
[
  {
    content: "YÃªu cáº§u dá»‹ch vá»¥ Ä‘Ã£ Ä‘Æ°á»£c táº¡o",
    status: "pending",
    time: "2026-01-27T10:00:00.000Z"
  },
  {
    content: "Admin Ä‘Ã£ há»§y yÃªu cáº§u",
    status: "cancelled",
    time: "2026-01-27T10:15:00.000Z"
  }
]
```

## ğŸ¯ USE CASES

### 1. Thay lÃµi lá»c nÆ°á»›c
```js
{
  serviceName: "Thay lÃµi lá»c nÆ°á»›c",
  userName: "Nguyá»…n VÄƒn A",
  userPhone: "0901234567",
  userAddress: "123 ÄÆ°á»ng ABC, Q1, TP.HCM",
  shopName: "Dá»‹ch vá»¥ nÆ°á»›c sáº¡ch XYZ",
  note: "MÃ¡y lá»c 10 lÃµi, cáº§n thay táº¥t cáº£",
  price: 500000, // 500k
  status: "pending"
}
```

### 2. Sá»­a mÃ¡y giáº·t
```js
{
  serviceName: "Sá»­a mÃ¡y giáº·t",
  userName: "Tráº§n Thá»‹ B",
  userPhone: "0902345678",
  userAddress: "456 ÄÆ°á»ng DEF, Q2, TP.HCM",
  shopName: "Äiá»‡n láº¡nh Minh TÃ¢m",
  note: "MÃ¡y khÃ´ng váº¯t, cáº§n kiá»ƒm tra",
  price: 300000, // 300k
  status: "processing"
}
```

### 3. Vá»‡ sinh mÃ¡y láº¡nh
```js
{
  serviceName: "Vá»‡ sinh mÃ¡y láº¡nh",
  userName: "LÃª VÄƒn C",
  userPhone: "0903456789",
  userAddress: "789 ÄÆ°á»ng GHI, Q3, TP.HCM",
  shopName: "Äiá»‡n láº¡nh Minh TÃ¢m",
  note: "MÃ¡y láº¡nh 2HP, cáº§n vá»‡ sinh sÃ¢u",
  price: 800000, // 800k
  status: "completed"
}
```

## ğŸš¨ EDGE CASES

1. **Order Not Found:**
   - orderId khÃ´ng tá»“n táº¡i
   - Show error view

2. **Service Not Found:**
   - serviceId khÃ´ng tá»“n táº¡i trong services collection
   - serviceInfo = null
   - Use placeholder image
   - serviceName tá»« order váº«n hiá»ƒn thá»‹

3. **No Note:**
   - note = '' hoáº·c undefined
   - Display: "KhÃ´ng cÃ³"

4. **Completed/Cancelled:**
   - Admin buttons hidden
   - Cannot update status anymore

5. **Web vs Mobile:**
   - Alert handling khÃ¡c nhau
   - window.confirm vs Alert.alert

6. **Address Field:**
   - CÃ³ thá»ƒ lÃ  `userAddress` hoáº·c `address`
   - Check cáº£ 2 fields

7. **Price = 0:**
   - Display "0Ä‘"
   - Valid use case (free service)

8. **Empty Logs:**
   - Order má»›i, logs = []
   - Section váº«n hiá»ƒn thá»‹ (khÃ´ng cÃ³ items)

## ğŸ“ SO SÃNH Vá»šI ORDER-DETAIL.TSX

| Feature | Food Order Detail | Service Order Detail |
|---------|-------------------|----------------------|
| **Collection** | foodOrders | serviceOrders |
| **Items** | Multiple items array | Single service |
| **Shipper** | Yes, with info card | No shipper |
| **Price** | Thousands (k) | Full (Ä‘á»“ng) |
| **Ship Fee** | Yes (baseShip + extraStepFee) | No ship fee |
| **Discount** | Yes (promo code) | No discount |
| **Admin Actions** | Reset + Cancel | Accept + Complete + Cancel |
| **Status Flow** | pending â†’ processing â†’ completed | Same |
| **Reset Function** | Yes (remove shipper) | No reset |
| **Price Display** | `*1000` then format | Direct format |
| **Image** | From items array | From services collection |

## ğŸ’¡ SUGGESTED IMPROVEMENTS

### 1. Service Image Preview
```js
{serviceInfo?.image && (
  <Image 
    source={{ uri: serviceInfo.image }} 
    style={styles.serviceImgLarge}
    resizeMode="cover"
  />
)}
```

### 2. MoneyShare Display
```js
// From serviceInfo
const adminShare = serviceInfo 
  ? (order.price * serviceInfo.moneyShare / 100) 
  : 0;
const shopShare = order.price - adminShare;

<Text>Admin nháº­n: {adminShare.toLocaleString()}Ä‘ ({serviceInfo?.moneyShare}%)</Text>
<Text>Shop nháº­n: {shopShare.toLocaleString()}Ä‘</Text>
```

### 3. Call Customer
```js
<TouchableOpacity onPress={() => Linking.openURL(`tel:${order.userPhone}`)}>
  <Ionicons name="call" size={18} color="#4CAF50" />
</TouchableOpacity>
```

### 4. Status Badge Color
```js
const statusColors = {
  pending: '#FFA726',
  processing: '#42A5F5',
  completed: '#66BB6A',
  cancelled: '#EF5350'
};

<View style={[styles.statusBadge, { backgroundColor: statusColors[order.status] }]}>
  <Text>{order.status.toUpperCase()}</Text>
</View>
```

### 5. Copy Order ID
```js
<TouchableOpacity onPress={() => Clipboard.setString(order.orderId)}>
  <Text>#{order.orderId} (nháº¥n Ä‘á»ƒ copy)</Text>
</TouchableOpacity>
```

### 6. Estimated Completion Time
```js
// Náº¿u cÃ³ field estimatedDuration trong service
const completionTime = new Date(
  new Date(order.createdAt).getTime() + 
  serviceInfo.estimatedDuration * 60 * 60 * 1000
);

<Text>Dá»± kiáº¿n hoÃ n thÃ nh: {completionTime.toLocaleString('vi-VN')}</Text>
```

### 7. Admin Note Field
```js
// Allow admin to add note when updating status
const [adminNote, setAdminNote] = useState('');

<TextInput 
  placeholder="Ghi chÃº admin (optional)"
  value={adminNote}
  onChangeText={setAdminNote}
/>

// When update
updateStatus('processing', adminNote || 'Admin Ä‘Ã£ tiáº¿p nháº­n yÃªu cáº§u');
```

### 8. Payment Status
```js
// Add payment tracking
{
  paymentStatus: 'unpaid' | 'paid',
  paymentMethod: 'cash' | 'card' | 'transfer'
}

<Text>Thanh toÃ¡n: {order.paymentStatus === 'paid' ? 'ÄÃ£ thanh toÃ¡n' : 'ChÆ°a thanh toÃ¡n'}</Text>
```

### 9. Before/After Photos
```js
// Allow shop to upload photos
{
  beforePhotos: string[],
  afterPhotos: string[]
}

<View>
  <Text>TrÆ°á»›c khi sá»­a:</Text>
  {order.beforePhotos?.map(url => <Image source={{uri: url}} />)}
</View>
```

### 10. Customer Rating
```js
// After completed, allow customer to rate
{
  rating: number, // 1-5 stars
  review: string
}

<View>
  <Text>ÄÃ¡nh giÃ¡: {order.rating} â­</Text>
  <Text>{order.review}</Text>
</View>
```
