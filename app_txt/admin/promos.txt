# TÃ“M Táº®T LOGIC TRANG ADMIN/PROMOS.TSX

## ğŸ¯ Má»¤C ÄÃCH
Quáº£n lÃ½ danh sÃ¡ch mÃ£ khuyáº¿n mÃ£i:
- Hiá»ƒn thá»‹ táº¥t cáº£ promos tá»« Firestore
- Báº­t/táº¯t tráº¡ng thÃ¡i mÃ£ (enable: true/false)
- TÃ­nh toÃ¡n ngÃ y háº¿t háº¡n dá»±a trÃªn `created` + `durationDays`
- **XUáº¤T Excel** (Export) - Header chuáº©n DB
- **NHáº¬P Excel** (Import) - Header chuáº©n DB
- Navigate Ä‘áº¿n edit-promo Ä‘á»ƒ chá»‰nh sá»­a chi tiáº¿t

## ğŸ“Š STATE & DATA

**Store:**
- `promos`: Danh sÃ¡ch khuyáº¿n mÃ£i tá»« collection `promos`

**Local State:**
- `isProcessing`: Tráº¡ng thÃ¡i Ä‘ang xá»­ lÃ½ import/export

**Excel Structure (Header chuáº©n DB):**
```
id, code, value, limit, used, maxPerUser, durationDays, created, enable, usedBy
```

**Promo Fields:**
- `code`: MÃ£ giáº£m giÃ¡ (VD: "SUMMER2024")
- `value`: GiÃ¡ trá»‹ giáº£m (%, hoáº·c fixed)
- `limit`: Tá»•ng sá»‘ lÆ°á»£t phÃ¡t hÃ nh
- `used`: Sá»‘ lÆ°á»£t Ä‘Ã£ dÃ¹ng
- `maxPerUser`: Tá»‘i Ä‘a má»—i user dÃ¹ng bao nhiÃªu láº§n
- `durationDays`: Sá»‘ ngÃ y hiá»‡u lá»±c (tá»« ngÃ y created)
- `created`: NgÃ y táº¡o (ISO String)
- `enable`: Tráº¡ng thÃ¡i báº­t/táº¯t (boolean)
- `usedBy`: Array chá»©a userId Ä‘Ã£ dÃ¹ng

## ğŸ”„ LUá»’NG THá»°C THI

### Display Flow
1. Load `promos` tá»« store
2. TÃ­nh toÃ¡n expiry date cho tá»«ng promo:
   ```js
   const expiryDate = new Date(created.getTime() + durationDays * 24 * 60 * 60 * 1000);
   const isExpired = expiryDate < new Date();
   ```
3. Hiá»ƒn thá»‹ FlatList vá»›i promo card
4. Card cÃ³ mÃ u khÃ¡c náº¿u expired hoáº·c disabled

### Toggle Enable
1. Nháº¥n Switch
2. Gá»i `handleTogglePromo(id, currentEnable)`
3. Toggle `true â†” false`
4. Update Firestore `promos/{id}` â†’ `enable`

### Export Excel
1. Nháº¥n nÃºt Export
2. Convert `usedBy` array â†’ String (ngÄƒn cÃ¡ch pháº©y)
3. Map táº¥t cáº£ fields vÃ o Excel
4. Download file: `DB_Promos_{timestamp}.xlsx`

### Import Excel
1. Nháº¥n nÃºt Import
2. Chá»n file
3. Parse usedBy string â†’ Array:
   ```js
   usedByList = row["usedBy"].toString().split(',').map(s => s.trim()).filter(Boolean);
   ```
4. Batch write vÃ o Firestore
5. Alert success

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### `handleTogglePromo(id, currentStatus)`
```js
await updateDoc(doc(db, 'promos', id.toString()), { enable: !currentStatus });
```

### Logic tÃ­nh expiry date
```js
const createdDate = new Date(item.created);
const expiryDate = new Date(createdDate.getTime() + item.durationDays * 24 * 60 * 60 * 1000);
const isExpired = expiryDate < new Date();
```

### `handleExportExcel()`
```js
const dataToExport = promos.map(item => {
  const usedByString = (item.usedBy || []).join(', ');
  
  return {
    id: item.id,
    code: item.code,
    value: item.value,
    limit: item.limit,
    used: item.used,
    maxPerUser: item.maxPerUser,
    durationDays: item.durationDays,
    created: item.created,
    enable: item.enable,
    usedBy: usedByString
  };
});
```

### `handleImportExcel()`
```js
// Parse usedBy: "1, 2, 3" â†’ [1, 2, 3]
let usedByList = [];
if (row["usedBy"]) {
  usedByList = row["usedBy"].toString().split(',').map(s => s.trim()).filter(Boolean);
  usedByList = usedByList.map(u => isNaN(Number(u)) ? u : Number(u));
}

const payload = {
  id: docId,
  code: row["code"] || `KM${Date.now()}`,
  value: Number(row["value"]) || 0,
  limit: Number(row["limit"]) || 100,
  used: Number(row["used"]) || 0,
  maxPerUser: Number(row["maxPerUser"]) || 1,
  durationDays: Number(row["durationDays"]) || 30,
  created: row["created"] || new Date().toISOString(),
  enable: row["enable"] === false ? false : true,
  usedBy: usedByList
};
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button
  â”‚   â”œâ”€ Title: "Quáº£n lÃ½ Khuyáº¿n mÃ£i"
  â”‚   â””â”€ Button Group
  â”‚       â”œâ”€ Import (#2980B9)
  â”‚       â”œâ”€ Export (#27AE60)
  â”‚       â””â”€ Add (primary)
  â”‚
  â””â”€ FlatList (Promo Cards)
      â””â”€ renderPromoItem: Card
          â”œâ”€ Icon: ticket-percent
          â”œâ”€ Info
          â”‚   â”œâ”€ Row: CODE + ID + Switch
          â”‚   â”œâ”€ Text: "X lÆ°á»£t dÃ¹ng cÃ²n láº¡i"
          â”‚   â””â”€ Row: "Giáº£m X%" + Expiry Text
          â”‚
          â””â”€ Style: Disabled/Expired cÃ³ opacity 0.6
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

1. **Expiry Calculation:** `created + durationDays` â†’ expiryDate
2. **isExpired Check:** `expiryDate < new Date()`
3. **usedBy Array:** Parse string "1, 2, 3" â†” Array [1, 2, 3]
4. **enable Boolean:** true/false (khÃ´ng pháº£i enable/disable string)
5. **Remaining Uses:** `limit - used`
6. **Auto Code:** Náº¿u thiáº¿u code â†’ `KM${Date.now()}`
7. **Default Values:**
   - limit: 100
   - maxPerUser: 1
   - durationDays: 30
   - enable: true (náº¿u khÃ´ng cÃ³)
8. **Expired Color:** #E74C3C (Ä‘á») + fontWeight bold
9. **Card Opacity:** 0.6 náº¿u disabled hoáº·c expired
10. **Icon Color:** primary náº¿u enabled, #999 náº¿u disabled

## ğŸš€ USER JOURNEY

**Admin:**
1. VÃ o Admin Promos
2. Xem danh sÃ¡ch mÃ£ KM (cÃ³ expiry date)
3. **Export:** Download Excel Ä‘á»ƒ backup/edit
4. **Edit Excel:** ThÃªm mÃ£ má»›i, sá»­a value, durationDays
5. **Import:** Nháº­p láº¡i vÃ o há»‡ thá»‘ng
6. **Toggle:** Báº­t/táº¯t mÃ£
7. **Edit Detail:** Nháº¥n card â†’ Edit-promo page

## ğŸ”— NAVIGATION

**Navigates TO:**
- `/admin/edit-promo` (nháº¥n card hoáº·c Add)

**Navigates FROM:**
- Admin dashboard (hoáº·c menu)

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

1. **created Field:** ISO String (VD: "2024-01-27T10:00:00.000Z")
2. **durationDays:** Number of days from created date
3. **expiryDate Calculation:**
   ```js
   new Date(createdDate.getTime() + durationDays * 24 * 60 * 60 * 1000)
   ```
4. **usedBy Format:**
   - Export: Array â†’ String "1, 2, 3"
   - Import: String â†’ Array [1, 2, 3]
5. **ID Type:** String hoáº·c Number, convert khi cáº§n
6. **Fallback Code:** `KM${Date.now()}` náº¿u thiáº¿u
7. **enable vs status:** Promos dÃ¹ng `enable` (boolean), khÃ´ng pháº£i `status` (string)
8. **maxPerUser:** Giá»›i háº¡n sá»‘ láº§n 1 user dÃ¹ng mÃ£
9. **limit vs used:** 
   - limit: Tá»•ng sá»‘ lÆ°á»£t
   - used: ÄÃ£ dÃ¹ng bao nhiÃªu lÆ°á»£t
   - CÃ²n láº¡i: `limit - used`
10. **Expiry Display:**
    - Expired: "ÄÃƒ Háº¾T Háº N" (mÃ u Ä‘á»)
    - Not expired: "Háº¿t háº¡n: DD/MM/YYYY"
11. **Switch Value:** `item.enable === true` (check boolean)
12. **Card Icon:** MaterialCommunityIcons ticket-percent
13. **ID Display:** `#{item.id}` inline vá»›i code
14. **Enable Default:** `true` náº¿u khÃ´ng cÃ³ trong Excel
15. **Success Message:** Alert sá»‘ mÃ£ Ä‘Ã£ import

## ğŸ” SO SÃNH Vá»šI PRODUCTS/SERVICES

**Giá»‘ng:**
- CÃ¹ng pattern Import/Export
- CÃ¹ng Toggle switch
- CÃ¹ng navigate edit page

**KhÃ¡c:**
- Promos: enable boolean (not status string)
- Promos: CÃ³ logic expiry date
- Promos: CÃ³ usedBy array
- Promos: Hiá»ƒn thá»‹ "lÆ°á»£t dÃ¹ng cÃ²n láº¡i"
- Promos: Icon ticket-percent Ä‘áº·c biá»‡t
