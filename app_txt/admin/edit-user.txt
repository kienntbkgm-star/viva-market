# T√ìM T·∫ÆT LOGIC TRANG ADMIN/EDIT-USER.TSX

## üéØ M·ª§C ƒê√çCH
M√†n h√¨nh ch·ªânh s·ª≠a h·ªì s∆° ng∆∞·ªùi d√πng (admin only):
- C·∫≠p nh·∫≠t th√¥ng tin t√†i kho·∫£n: t√™n, SƒêT, m·∫≠t kh·∫©u, ƒë·ªãa ch·ªâ
- Qu·∫£n l√Ω vai tr√≤ (role): user, admin, ch·ªß shop, shipper, manager
- C·∫•u h√¨nh h·ªá th·ªëng: status, mustCheckIn, point, index
- Upload ·∫£nh shop (imgShop, imgShopSquare) l√™n ImgBB
- Kh√¥ng t·∫°o m·ªõi user (ch·ªâ edit)

## üìä STATE & DATA

**Store:**
- `users`: Danh s√°ch ng∆∞·ªùi d√πng (load ƒë·ªÉ edit)

**Route Params:**
- `id`: ID user (required, kh√¥ng c√≥ t·∫°o m·ªõi)

**Local State:**
```js
uploadingField: 'imgShop' | 'imgShopSquare' | null // Track field ƒëang upload
formData: {
  id: number,
  uid: string,              // Firebase Auth UID
  name: string,
  phone: string,
  password: string,         // ‚ö†Ô∏è Plaintext password
  address: string,
  role: 'user' | 'admin' | 'ch·ªß shop' | 'shipper' | 'manager',
  status: 'enable' | 'disable',
  mustCheckIn: 'enable' | 'disable',
  checkInDate: string,
  point: string,
  index: number,
  shopName: string,
  imgShop: string,          // ·∫¢nh ngang 16:9
  imgShopSquare: string,    // ·∫¢nh vu√¥ng 1:1
  expoToken: string
}
```

## üîÑ LU·ªíNG TH·ª∞C THI

### 1. Load User Data
```js
useEffect(() => {
  if (id) {
    const user = users.find(x => x.id === id);
    if (user) {
      setFormData({
        ...user,
        point: user.point?.toString() || '',
        index: user.index || 1
      });
    }
  }
}, [id, users]);
```

### 2. Upload ·∫¢nh ImgBB
```js
const handleUpload = async (field) => {
  // 1. Pick image
  const result = await ImagePicker.launchImageLibraryAsync({
    mediaTypes: ImagePicker.MediaTypeOptions.Images,
    allowsEditing: true,
    aspect: field === 'imgShop' ? [16, 9] : [1, 1], // Aspect kh√°c nhau
    quality: 0.7
  });
  
  if (result.canceled) return;
  
  setUploadingField(field); // Show loading
  
  // 2. Prepare FormData
  const data = new FormData();
  data.append('image', {
    uri: Platform.OS === 'ios' ? imageUri.replace('file://', '') : imageUri,
    type: 'image/jpeg',
    name: 'upload.jpg'
  });
  
  // 3. Upload to ImgBB
  const response = await fetch(
    `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,
    { method: 'POST', body: data, headers: { 'Content-Type': 'multipart/form-data' }}
  );
  
  const resJson = await response.json();
  if (resJson.success) {
    setFormData(prev => ({ ...prev, [field]: resJson.data.url }));
  }
  
  setUploadingField(null); // Hide loading
};
```

### 3. Save to Firestore
```js
const handleSave = async () => {
  // Validation
  if (!formData.name || !formData.phone) {
    Alert.alert("L·ªói", "T√™n v√† S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
    return;
  }
  
  try {
    const userRef = doc(db, 'users', id.toString());
    const payload = {
      ...formData,
      id: Number(formData.id),
      index: Number(formData.index || 1)
    };
    
    await updateDoc(userRef, payload);
    
    Alert.alert("Th√†nh c√¥ng", `ƒê√£ c·∫≠p nh·∫≠t User #${id}`, [
      { text: "OK", onPress: () => router.back() }
    ]);
  } catch (err) {
    Alert.alert("L·ªói c·∫≠p nh·∫≠t", err.message);
  }
};
```

## üîß C√ÅC FUNCTION QUAN TR·ªåNG

### ImgBB Upload v·ªõi Platform Handling
```js
const IMGBB_API_KEY = '4be67bc1f9e424d0e25f23a35ab95c03';

// iOS: Remove 'file://' prefix
const imageUri = Platform.OS === 'ios' 
  ? result.assets[0].uri.replace('file://', '') 
  : result.assets[0].uri;

// FormData structure for native
data.append('image', {
  uri: imageUri,
  type: 'image/jpeg',
  name: 'upload.jpg'
});
```

### Role Selection
```js
const roles = ['user', 'admin', 'ch·ªß shop', 'shipper', 'manager'];

<View style={styles.roleGrid}>
  {roles.map(r => (
    <TouchableOpacity 
      key={r}
      style={[styles.roleItem, formData.role === r && styles.roleActive]}
      onPress={() => setFormData({...formData, role: r})}
    >
      <Text>{r}</Text>
    </TouchableOpacity>
  ))}
</View>
```

### Toggle Status/MustCheckIn
```js
<TouchableOpacity 
  style={[styles.toggleBtn, formData.status === 'enable' ? styles.bgGreen : styles.bgRed]}
  onPress={() => setFormData({
    ...formData, 
    status: formData.status === 'enable' ? 'disable' : 'enable'
  })}
>
  <Text>{formData.status === 'enable' ? 'K√≠ch ho·∫°t' : 'Kh√≥a'}</Text>
</TouchableOpacity>
```

## üé® UI C·∫§U TR√öC

```
SafeAreaView
  ‚îî‚îÄ KeyboardAvoidingView
      ‚îú‚îÄ Header
      ‚îÇ   ‚îú‚îÄ Close Button
      ‚îÇ   ‚îú‚îÄ Title: "H·ªì s∆° ng∆∞·ªùi d√πng"
      ‚îÇ   ‚îÇ   ‚îî‚îÄ Subtitle: "ID: [id] | UID: [uid]"
      ‚îÇ   ‚îî‚îÄ Save Button
      ‚îÇ
      ‚îî‚îÄ ScrollView
          ‚îú‚îÄ Section: T√ÄI KHO·∫¢N & B·∫¢O M·∫¨T
          ‚îÇ   ‚îú‚îÄ H·ªç v√† t√™n
          ‚îÇ   ‚îú‚îÄ Row: S·ªë ƒëi·ªán tho·∫°i | M·∫≠t kh·∫©u
          ‚îÇ   ‚îî‚îÄ ƒê·ªãa ch·ªâ
          ‚îÇ
          ‚îú‚îÄ Section: C·∫§U H√åNH H·ªÜ TH·ªêNG
          ‚îÇ   ‚îú‚îÄ Vai tr√≤ (Role Grid - 5 buttons)
          ‚îÇ   ‚îú‚îÄ Row: Tr·∫°ng th√°i | Must Check-in (Toggle buttons)
          ‚îÇ   ‚îî‚îÄ Row: ƒêi·ªÉm (Point) | Th·ª© t·ª± (Index)
          ‚îÇ
          ‚îú‚îÄ Section: TH√îNG TIN C·ª¨A H√ÄNG
          ‚îÇ   ‚îú‚îÄ T√™n Shop
          ‚îÇ   ‚îú‚îÄ ·∫¢nh ngang (Landscape URL) + Upload icon
          ‚îÇ   ‚îî‚îÄ ·∫¢nh vu√¥ng (Square URL) + Upload icon
          ‚îÇ
          ‚îî‚îÄ ExpoToken (readonly text)
```

## ‚ö° ƒêI·ªÇM ƒê·∫∂C BI·ªÜT

### Image Upload
1. **2 Lo·∫°i ·∫¢nh:**
   - `imgShop`: ·∫¢nh ngang 16:9 (banner shop)
   - `imgShopSquare`: ·∫¢nh vu√¥ng 1:1 (logo shop)

2. **Upload Button:**
   - Inline v·ªõi TextInput (inputWithIcon layout)
   - Icon kh√°c nhau: `cloud-upload` vs `image`
   - Color kh√°c nhau: primary vs #E67E22

3. **Loading State:**
   - `uploadingField = 'imgShop'` ‚Üí Show spinner cho imgShop field
   - `uploadingField = 'imgShopSquare'` ‚Üí Show spinner cho imgShopSquare field
   - C√°c field kh√°c kh√¥ng b·ªã disable

4. **Quality:**
   - 0.7 (cao h∆°n edit-food d√πng 0.5)
   - L√Ω do: ·∫¢nh shop c·∫ßn ch·∫•t l∆∞·ª£ng t·ªët h∆°n

### Role Management
5. **5 Roles:**
   - `user`: Ng∆∞·ªùi d√πng th∆∞·ªùng
   - `admin`: Qu·∫£n tr·ªã vi√™n
   - `ch·ªß shop`: Ch·ªß c·ª≠a h√†ng
   - `shipper`: Ng∆∞·ªùi giao h√†ng
   - `manager`: Qu·∫£n l√Ω (role ƒë·∫∑c bi·ªát)

6. **Role Grid:**
   - flexWrap ƒë·ªÉ t·ª± xu·ªëng d√≤ng
   - Active role: Background primary, text white
   - Inactive role: Background white, text gray

### Status Fields
7. **Status:**
   - `enable`: T√†i kho·∫£n k√≠ch ho·∫°t (m√†u xanh #27AE60)
   - `disable`: T√†i kho·∫£n b·ªã kh√≥a (m√†u ƒë·ªè #EB5757)

8. **MustCheckIn:**
   - `enable`: B·∫Øt bu·ªôc check-in (m√†u xanh)
   - `disable`: Kh√¥ng b·∫Øt bu·ªôc (m√†u ƒë·ªè)
   - D√πng cho shipper/shop (tracking location)

### Point System
9. **Point Field:**
   - ƒêi·ªÉm t√≠ch l≈©y c·ªßa user
   - String input ‚Üí Parse khi save
   - D√πng cho ch∆∞∆°ng tr√¨nh loyalty

10. **Index Field:**
    - Th·ª© t·ª± hi·ªÉn th·ªã user
    - Default: 1
    - D√πng cho sorting (VD: admin index=0 l√™n ƒë·∫ßu)

### Shop Info
11. **ShopName:**
    - T√™n c·ª≠a h√†ng (cho role 'ch·ªß shop')
    - Empty n·∫øu kh√¥ng ph·∫£i ch·ªß shop

12. **ImgShop:**
    - ·∫¢nh ngang (landscape banner)
    - Aspect 16:9
    - Hi·ªÉn th·ªã tr√™n trang shop

13. **ImgShopSquare:**
    - ·∫¢nh vu√¥ng (logo)
    - Aspect 1:1
    - Hi·ªÉn th·ªã trong list, avatar

### ExpoToken
14. **Readonly:**
    - Hi·ªÉn th·ªã d∆∞·ªõi c√πng
    - fontSize 9, color #ccc
    - Kh√¥ng cho edit (system generated)

15. **Purpose:**
    - Push notification token
    - Firebase Cloud Messaging

## üöÄ USER JOURNEY

### Admin - S·ª≠a th√¥ng tin user
1. Navigate to `/admin/edit-user?id=123`
2. Load user data t·ª´ store
3. **Section 1: T√†i kho·∫£n**
   - S·ª≠a t√™n, SƒêT, password, ƒë·ªãa ch·ªâ
4. **Section 2: C·∫•u h√¨nh**
   - Ch·ªçn role (nh·∫•n v√†o role button)
   - Toggle status (k√≠ch ho·∫°t/kh√≥a)
   - Toggle mustCheckIn (b·∫≠t/t·∫Øt)
   - Nh·∫≠p point, index
5. **Section 3: C·ª≠a h√†ng** (n·∫øu role l√† 'ch·ªß shop')
   - Nh·∫≠p t√™n shop
   - Upload ·∫£nh ngang (nh·∫•n icon cloud-upload)
   - Upload ·∫£nh vu√¥ng (nh·∫•n icon image)
6. Nh·∫•n "L∆∞u" ‚Üí Update Firestore
7. Alert "Th√†nh c√¥ng" ‚Üí Back to users list

### Admin - Upload ·∫£nh shop
1. Nh·∫•n upload icon (cloud-upload ho·∫∑c image)
2. Pick ·∫£nh t·ª´ gallery
3. Crop ·∫£nh theo aspect (16:9 ho·∫∑c 1:1)
4. Ch·ªù upload ‚Üí Spinner hi·ªÉn th·ªã
5. Upload th√†nh c√¥ng ‚Üí URL update v√†o TextInput
6. C√≥ th·ªÉ preview ·∫£nh (kh√¥ng c√≥ trong code, n√™n th√™m)

## üîó NAVIGATION

**Navigates TO:** Kh√¥ng (modal-style screen)

**Navigates FROM:**
- Admin Users page ‚Üí Nh·∫•n "S·ª≠a" tr√™n user card

**Back Navigation:**
- Close icon (header left)
- After save success ‚Üí `router.back()`

## üí° L∆ØU √ù K·ª∏ THU·∫¨T

### Firestore Operations
1. **Collection:** `users`
2. **Document ID:** Use `id.toString()` (v√¨ id l√† number)
3. **Only Update:** Kh√¥ng t·∫°o m·ªõi user (kh√¥ng c√≥ setDoc)
4. **Why?** User ƒë∆∞·ª£c t·∫°o qua register flow v·ªõi Firebase Auth

### User Structure
```js
{
  id: number,               // User ID
  uid: string,              // Firebase Auth UID
  name: string,
  phone: string,
  password: string,         // ‚ö†Ô∏è Plaintext
  address: string,
  role: string,
  status: 'enable' | 'disable',
  mustCheckIn: 'enable' | 'disable',
  checkInDate: string,
  point: number,
  index: number,
  shopName: string,
  imgShop: string,
  imgShopSquare: string,
  expoToken: string
}
```

### Security Concerns
5. **‚ö†Ô∏è Plaintext Password:**
   - Password l∆∞u d·∫°ng plaintext trong Firestore
   - KH√îNG secure (n√™n hash b·∫±ng bcrypt)
   - Admin c√≥ th·ªÉ xem/s·ª≠a password

6. **Password Display:**
   - Hi·ªÉn th·ªã trong TextInput (kh√¥ng secure)
   - Kh√¥ng c√≥ secureTextEntry

7. **Suggested Fix:**
   ```js
   // Khi save, n·∫øu password thay ƒë·ªïi
   if (password !== originalPassword) {
     // Update Firebase Auth password
     await updatePassword(auth.currentUser, newPassword);
     // Kh√¥ng l∆∞u password v√†o Firestore
   }
   ```

### ImgBB Integration
8. **API Key:** `4be67bc1f9e424d0e25f23a35ab95c03` (same as edit-food)
9. **FormData:** Native structure (kh√°c web)
10. **Headers:** `Content-Type: multipart/form-data`
11. **Response:** `data.data.url` ch·ª©a URL ·∫£nh

### Platform Differences
12. **iOS Image URI:**
    - C√≥ prefix `file://`
    - Ph·∫£i remove: `.replace('file://', '')`

13. **Android Image URI:**
    - Kh√¥ng c√≥ prefix `file://`
    - D√πng tr·ª±c ti·∫øp

### KeyboardAvoidingView
14. **Behavior:**
    - iOS: `"padding"`
    - Android: `null` (kh√¥ng c·∫ßn)

### Validation
15. **Required Fields:**
    - ‚úÖ `name`: Kh√¥ng r·ªóng
    - ‚úÖ `phone`: Kh√¥ng r·ªóng

16. **Optional Fields:**
    - All other fields c√≥ th·ªÉ r·ªóng

17. **No Validation:**
    - Phone format (kh√¥ng check 10 digits)
    - Password strength
    - Image URL format

### Form Sections
18. **Section Style:**
    - backgroundColor: #fff
    - borderRadius: 15
    - padding: 15
    - marginBottom: 15
    - elevation: 1 (shadow)

19. **Section Title:**
    - fontSize: 11, bold
    - color: primary
    - letterSpacing: 0.5
    - marginBottom: 10

### Role Grid Layout
20. **flexWrap:** T·ª± ƒë·ªông xu·ªëng d√≤ng khi h·∫øt ch·ªó
21. **Role Item:**
    - paddingHorizontal: 10
    - paddingVertical: 5
    - borderRadius: 12
    - marginRight: 6, marginBottom: 6

22. **Active Style:**
    - backgroundColor: primary
    - borderColor: primary
    - Text color: white, bold

### Toggle Button Style
23. **Normal:**
    - padding: 10
    - borderRadius: 8
    - alignItems: center

24. **Green (enable):**
    - backgroundColor: #27AE60

25. **Red (disable):**
    - backgroundColor: #EB5757

### Input With Icon Layout
26. **flexDirection: row**
27. **Input:** `flex: 1` (chi·∫øm h·∫øt space)
28. **Icon:** `marginLeft: 10, padding: 5`

## üîç ROLE PERMISSIONS (not in this file)

### Role Capabilities
| Role | Kh·∫£ nƒÉng |
|------|----------|
| **user** | ƒê·∫∑t h√†ng, xem l·ªãch s·ª≠, t√≠ch ƒëi·ªÉm |
| **admin** | To√†n quy·ªÅn qu·∫£n tr·ªã |
| **ch·ªß shop** | Qu·∫£n l√Ω s·∫£n ph·∫©m/d·ªãch v·ª• c·ªßa shop m√¨nh |
| **shipper** | Nh·∫≠n ƒë∆°n, giao h√†ng, xem thu nh·∫≠p |
| **manager** | Xem b√°o c√°o, qu·∫£n l√Ω m·ªôt ph·∫ßn (gi·ªØa admin v√† user) |

## üéØ USE CASES

### 1. Admin s·ª≠a th√¥ng tin user th∆∞·ªùng
```js
// User ID: 5
{
  name: "Nguy·ªÖn VƒÉn A",
  phone: "0901234567",
  address: "123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM",
  role: "user",
  status: "enable",
  mustCheckIn: "disable",
  point: "100",
  index: 1,
  // Kh√¥ng c·∫ßn shop fields
}
```

### 2. Admin th√™m shop owner
```js
// User ID: 10
{
  name: "Tr·∫ßn Th·ªã B",
  phone: "0902345678",
  role: "ch·ªß shop",
  status: "enable",
  shopName: "Qu√°n ƒÇn Ngon",
  imgShop: "https://i.ibb.co/xxx/banner.jpg",      // 16:9
  imgShopSquare: "https://i.ibb.co/xxx/logo.jpg",  // 1:1
  // Shop owner c√≥ th·ªÉ upload ·∫£nh shop
}
```

### 3. Admin c·∫•u h√¨nh shipper
```js
// User ID: 20
{
  name: "L√™ VƒÉn C",
  phone: "0903456789",
  role: "shipper",
  status: "enable",
  mustCheckIn: "enable", // B·∫Øt bu·ªôc check-in ƒë·ªÉ track location
  index: 1,
  // Shipper kh√¥ng c·∫ßn shop fields
}
```

### 4. Admin kh√≥a t√†i kho·∫£n vi ph·∫°m
```js
// User ID: 15
{
  name: "Ph·∫°m VƒÉn D",
  role: "user",
  status: "disable", // Kh√≥a t√†i kho·∫£n
  // User kh√¥ng th·ªÉ login n·ªØa
}
```

## üö® SECURITY ISSUES

### Critical
1. **‚ö†Ô∏è Plaintext Password Storage:**
   - Password l∆∞u d·∫°ng text trong Firestore
   - Admin c√≥ th·ªÉ xem password c·ªßa t·∫•t c·∫£ users
   - KH√îNG secure

2. **‚ö†Ô∏è Password Display:**
   - TextInput kh√¥ng d√πng `secureTextEntry`
   - Password hi·ªÉn th·ªã r√µ r√†ng

3. **‚ö†Ô∏è No Password Validation:**
   - C√≥ th·ªÉ ƒë·∫∑t password r·ªóng
   - Kh√¥ng check ƒë·ªô d√†i t·ªëi thi·ªÉu

### Recommended Fixes
```js
// 1. Kh√¥ng l∆∞u password v√†o Firestore
// 2. Ch·ªâ update Firebase Auth password
const handleSave = async () => {
  // ... validate
  
  // Update Firestore (kh√¥ng include password)
  const { password, ...userData } = formData;
  await updateDoc(userRef, userData);
  
  // N·∫øu password thay ƒë·ªïi, update Firebase Auth
  if (password && password !== originalPassword) {
    const user = auth.currentUser;
    await updatePassword(user, password);
  }
};

// 3. D√πng secureTextEntry cho password field
<TextInput 
  secureTextEntry 
  value={formData.password} 
  onChangeText={t => setFormData({...formData, password: t})} 
/>
```

## üìù SUGGESTED IMPROVEMENTS

### 1. Image Preview
```js
{formData.imgShop && (
  <Image source={{ uri: formData.imgShop }} style={styles.imagePreview} />
)}
```

### 2. Phone Validation
```js
const validatePhone = (phone) => {
  const regex = /^0\d{9}$/;
  return regex.test(phone);
};

if (!validatePhone(formData.phone)) {
  Alert.alert("L·ªói", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (ph·∫£i 10 ch·ªØ s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0)");
  return;
}
```

### 3. Role Description
```js
const roleDescriptions = {
  user: "Ng∆∞·ªùi d√πng th∆∞·ªùng",
  admin: "Qu·∫£n tr·ªã vi√™n (to√†n quy·ªÅn)",
  'ch·ªß shop': "Ch·ªß c·ª≠a h√†ng",
  shipper: "Ng∆∞·ªùi giao h√†ng",
  manager: "Qu·∫£n l√Ω"
};

<Text style={styles.roleDescription}>
  {roleDescriptions[formData.role]}
</Text>
```

### 4. Confirm Dialog for Status Change
```js
const handleToggleStatus = () => {
  if (formData.status === 'enable') {
    Alert.alert(
      "X√°c nh·∫≠n kh√≥a",
      "Kh√≥a t√†i kho·∫£n n√†y? User s·∫Ω kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p.",
      [
        { text: "H·ªßy", style: "cancel" },
        { text: "Kh√≥a", onPress: () => setFormData({...formData, status: 'disable'}) }
      ]
    );
  } else {
    setFormData({...formData, status: 'enable'});
  }
};
```

### 5. UID Display
```js
<TouchableOpacity onPress={() => Clipboard.setString(formData.uid)}>
  <Text>UID: {formData.uid} (nh·∫•n ƒë·ªÉ copy)</Text>
</TouchableOpacity>
```

### 6. CheckInDate Display
```js
{formData.mustCheckIn === 'enable' && formData.checkInDate && (
  <Text>Check-in cu·ªëi: {new Date(formData.checkInDate).toLocaleString('vi-VN')}</Text>
)}
```

### 7. Shop Fields Visibility
```js
{formData.role === 'ch·ªß shop' && (
  <View style={styles.section}>
    <Text style={styles.sectionTitle}>TH√îNG TIN C·ª¨A H√ÄNG</Text>
    {/* Shop fields */}
  </View>
)}
```
