# T√ìM T·∫ÆT LOGIC TRANG ADMIN/SHIPPER-DETAIL-FINANCE.TSX

## üéØ M·ª§C ƒê√çCH
M√†n h√¨nh qu·∫£n l√Ω t√†i ch√≠nh chi ti·∫øt c·ªßa 1 shipper c·ª• th·ªÉ (admin view):
- Xem l·ªãch s·ª≠ giao d·ªãch (transactions) c·ªßa shipper
- Hi·ªÉn th·ªã s·ªë d∆∞ n·ª£ hi·ªán t·∫°i (t·ªïng t·∫•t c·∫£ transactions)
- Admin thu ti·ªÅn m·∫∑t t·ª´ shipper (n·∫øu shipper n·ª£)
- Admin tr·∫£ ti·ªÅn b√π cho shipper (n·∫øu admin n·ª£ shipper)
- Auto ƒë·∫£o d·∫•u logic th√¥ng minh

## üìä STATE & DATA

**Route Params:**
- `shipperId`: ID c·ªßa shipper c·∫ßn qu·∫£n l√Ω
- `name`: T√™n shipper (hi·ªÉn th·ªã trong header)

**Local State:**
```js
transactions: Array<Transaction> // Danh s√°ch giao d·ªãch c·ªßa shipper
payAmount: string // S·ªë ti·ªÅn admin nh·∫≠p ƒë·ªÉ thu/tr·∫£ (ƒë∆°n v·ªã ƒë·ªìng)
```

**Realtime Listener:**
- Query `transactions` collection
- Filter by `userId === shipperId`
- OrderBy `createdAt` desc (s·∫Øp x·∫øp b·∫±ng JS, kh√¥ng d√πng Firestore orderBy)

## üîÑ LU·ªíNG TH·ª∞C THI

### 1. Load Transactions
```js
useEffect(() => {
  if (!shipperId) return;
  
  // Query WITHOUT orderBy (avoid Firestore index error)
  const q = query(
    collection(db, 'transactions'),
    where('userId', '==', Number(shipperId))
  );
  
  const unsubscribe = onSnapshot(q, (snapshot) => {
    // 1. Get data
    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // 2. Sort in JavaScript (safe, no Firestore index required)
    data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    setTransactions(data);
  });
  
  return () => unsubscribe();
}, [shipperId]);
```

### 2. Calculate Total Balance
```js
const totalBalance = transactions.reduce(
  (sum, t) => sum + (t.amount || 0), 
  0
);

// totalBalance > 0: Shipper n·ª£ Admin
// totalBalance < 0: Admin n·ª£ Shipper
// totalBalance = 0: Kh√¥ng n·ª£
```

### 3. Collect Money (Thu/Tr·∫£ ti·ªÅn)
```js
const handleCollectMoney = async () => {
  // Validation
  if (!payAmount || isNaN(payAmount)) {
    Alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá");
    return;
  }
  
  // Convert to thousands
  const inputVal = Number(payAmount) / 1000;
  
  /**
   * AUTO FLIP SIGN LOGIC:
   * - N·∫øu totalBalance > 0 (Shipper n·ª£): C·∫ßn n·∫°p s·ªë √ÇM ƒë·ªÉ gi·∫£m n·ª£
   * - N·∫øu totalBalance < 0 (Admin n·ª£): C·∫ßn n·∫°p s·ªë D∆Ø∆†NG ƒë·ªÉ gi·∫£m n·ª£
   */
  const finalAmount = totalBalance >= 0 ? -inputVal : inputVal;
  
  // Add transaction
  await addDoc(collection(db, 'transactions'), {
    userId: Number(shipperId),
    userName: name,
    type: 'PAYMENT',
    amount: Math.round(finalAmount * 1000) / 1000, // Round to 3 decimals
    desc: totalBalance >= 0 
      ? 'Admin thu ti·ªÅn m·∫∑t' 
      : 'Admin tr·∫£ ti·ªÅn b√π (Voucher/Ship)',
    createdAt: new Date().toISOString(),
    performedBy: 'admin'
  });
  
  setPayAmount(''); // Clear input
  Alert("ƒê√£ c·∫≠p nh·∫≠t giao d·ªãch t√†i ch√≠nh th√†nh c√¥ng");
};
```

## üîß C√ÅC FUNCTION QUAN TR·ªåNG

### Auto Flip Sign Logic
```js
// Magic formula:
const finalAmount = totalBalance >= 0 ? -inputVal : inputVal;

// Example 1: Shipper owes 50k
// - totalBalance = 50 (positive)
// - inputVal = 30 (admin collect 30k cash)
// - finalAmount = -30 (subtract from debt)
// - New balance = 50 + (-30) = 20 (still owe 20k)

// Example 2: Admin owes 20k
// - totalBalance = -20 (negative)
// - inputVal = 10 (admin pay 10k cash)
// - finalAmount = 10 (add to balance)
// - New balance = -20 + 10 = -10 (still owe 10k)
```

### Round to 3 Decimals
```js
// Fix JavaScript floating point precision
Math.round(finalAmount * 1000) / 1000

// Example:
// 0.30000000000000004 ‚Üí 0.300
```

### Platform-Specific Alert
```js
if (Platform.OS === 'web') {
  window.alert(message);
} else {
  Alert.alert("Title", message);
}
```

## üé® UI C·∫§U TR√öC

```
SafeAreaView
  ‚îú‚îÄ Header
  ‚îÇ   ‚îú‚îÄ Back Button
  ‚îÇ   ‚îú‚îÄ Title: "L·ªãch s·ª≠ n·ª£: [name]"
  ‚îÇ   ‚îî‚îÄ Spacer
  ‚îÇ
  ‚îú‚îÄ Summary Section
  ‚îÇ   ‚îú‚îÄ Label: "S·ªë d∆∞ n·ª£ hi·ªán t·∫°i (D∆∞∆°ng: Shipper n·ª£ | √Çm: Admin n·ª£)"
  ‚îÇ   ‚îî‚îÄ Value: [totalBalance] (color: orange if >=0, green if <0)
  ‚îÇ
  ‚îú‚îÄ Collect Box (Input + Button)
  ‚îÇ   ‚îú‚îÄ TextInput: "Nh·∫≠p s·ªë ti·ªÅn m·∫∑t giao nh·∫≠n" (numeric keyboard)
  ‚îÇ   ‚îî‚îÄ Button: "THU N·ª¢" (if balance >=0) / "TR·∫¢ TI·ªÄN" (if balance <0)
  ‚îÇ       Background color: Orange (thu) / Green (tr·∫£)
  ‚îÇ
  ‚îî‚îÄ FlatList: Transaction Items
      ‚îî‚îÄ renderItem: Transaction Row
          ‚îú‚îÄ Desc (bold)
          ‚îú‚îÄ OrderId (if exists, debug info, monospace)
          ‚îú‚îÄ Date (gray, small)
          ‚îî‚îÄ Amount (color: orange if >=0, green if <0)
```

## ‚ö° ƒêI·ªÇM ƒê·∫∂C BI·ªÜT

### Firestore Index Optimization
1. **Problem:**
   - `orderBy('createdAt', 'desc')` requires Firestore composite index
   - Index creation slow/error-prone

2. **Solution:**
   - Query WITHOUT orderBy: `where('userId', '==', shipperId)`
   - Sort in JavaScript: `data.sort((a,b) => ...)`
   - Safe, no index required

### Auto Flip Sign Logic
3. **Smart Logic:**
   - Admin kh√¥ng c·∫ßn ch·ªçn "Thu" hay "Tr·∫£"
   - System t·ª± ƒë·ªông detect d·ª±a tr√™n balance
   - Balance >= 0 ‚Üí Button "THU N·ª¢", amount √¢m
   - Balance < 0 ‚Üí Button "TR·∫¢ TI·ªÄN", amount d∆∞∆°ng

4. **Why?**
   - Gi·∫£m l·ªói admin nh·∫≠p sai d·∫•u
   - UI ƒë∆°n gi·∫£n, ch·ªâ 1 input + 1 button
   - Logic consistent: Balance + amount = New balance

### Balance Color Coding
5. **Color Rules:**
   - `>= 0`: #E67E22 (orange) - "Shipper n·ª£ Admin"
   - `< 0`: #27AE60 (green) - "Admin n·ª£ shipper"

6. **Display:**
   - Positive: `+50,000ƒë` (shipper owes)
   - Negative: `-20,000ƒë` (admin owes)
   - Zero: `0ƒë` (neutral)

### Transaction Amount Display
7. **Same Color Logic:**
   - Transaction amount >= 0: Orange (debt increased)
   - Transaction amount < 0: Green (debt decreased/paid)

8. **Plus Sign:**
   - Show `+` for positive amounts
   - No sign for negative (already has `-`)

### Input Unit
9. **User Input:** ƒê·ªìng (full)
10. **Store:** Ngh√¨n ƒë·ªìng (k)
11. **Conversion:** `Number(payAmount) / 1000`

### OrderId Debug Info
12. **Purpose:**
    - Show full orderId in monospace font
    - Debug info (fontSize 10, color #BBB)
    - Only show if `item.orderId` exists

13. **Example:**
    ```
    Admin thu ti·ªÅn m·∫∑t
    FULL ID: order_abc123xyz
    27/01/2026, 10:30:15
    ```

### Rounding Precision
14. **JavaScript Float Issue:**
    - 0.1 + 0.2 = 0.30000000000000004

15. **Solution:**
    - `Math.round(amount * 1000) / 1000`
    - Ensure 3 decimal places max

## üöÄ USER JOURNEY

### Admin - Xem l·ªãch s·ª≠ shipper
1. Navigate from Admin Finance list ‚Üí Nh·∫•n v√†o shipper card
2. Route: `/admin/shipper-detail-finance?shipperId=5&name=L√™ VƒÉn A`
3. Load transactions c·ªßa shipper #5
4. Xem:
   - S·ªë d∆∞ n·ª£ hi·ªán t·∫°i: +50,000ƒë (shipper n·ª£)
   - L·ªãch s·ª≠ giao d·ªãch:
     - Giao ƒë∆°n #123: +15k (debt)
     - Giao ƒë∆°n #124: +8k (debt)
     - Admin thu ti·ªÅn: -20k (payment)
     - Giao ƒë∆°n #125: +10k (debt)
     - ...

### Admin - Thu ti·ªÅn t·ª´ shipper
1. Shipper n·ª£ 50k ‚Üí Balance: +50,000ƒë (orange)
2. Shipper ƒë∆∞a 30k ti·ªÅn m·∫∑t cho admin
3. Admin nh·∫≠p: 30000 (ƒë∆°n v·ªã ƒë·ªìng)
4. Nh·∫•n "THU N·ª¢"
5. System:
   - Convert: 30000 / 1000 = 30 (k)
   - Flip sign: -30 (v√¨ balance >= 0)
   - Add transaction: { amount: -30, type: 'PAYMENT', desc: 'Admin thu ti·ªÅn m·∫∑t' }
6. New balance: 50 + (-30) = 20k (shipper c√≤n n·ª£ 20k)
7. Alert "ƒê√£ c·∫≠p nh·∫≠t giao d·ªãch t√†i ch√≠nh th√†nh c√¥ng"

### Admin - Tr·∫£ ti·ªÅn cho shipper
1. Admin n·ª£ shipper 20k ‚Üí Balance: -20,000ƒë (green)
2. Admin tr·∫£ ti·ªÅn m·∫∑t 10k cho shipper
3. Admin nh·∫≠p: 10000
4. Nh·∫•n "TR·∫¢ TI·ªÄN"
5. System:
   - Convert: 10000 / 1000 = 10 (k)
   - Flip sign: +10 (v√¨ balance < 0)
   - Add transaction: { amount: +10, type: 'PAYMENT', desc: 'Admin tr·∫£ ti·ªÅn b√π (Voucher/Ship)' }
6. New balance: -20 + 10 = -10k (admin c√≤n n·ª£ 10k)
7. Alert success

## üîó NAVIGATION

**Navigates TO:** Kh√¥ng

**Navigates FROM:**
- Admin Finance page ‚Üí Nh·∫•n v√†o shipper card
- Params: `{ shipperId, name }`

**Back Navigation:**
- Back button (header left) ‚Üí `router.back()`

## üí° L∆ØU √ù K·ª∏ THU·∫¨T

### Firestore Operations
1. **Collection:** `transactions`
2. **Query:**
   - `where('userId', '==', Number(shipperId))`
   - NO orderBy (avoid index error)
3. **Sort:** JavaScript `.sort()`
4. **Add:** `addDoc(collection(db, 'transactions'), {...})`

### Transaction Structure
```js
{
  id: string,              // Auto-generated by Firestore
  userId: number,          // Shipper ID
  userName: string,        // Shipper name (for display)
  type: 'DEBT' | 'PAYMENT' | 'REFUND',
  amount: number,          // Ngh√¨n ƒë·ªìng (k)
  desc: string,            // Description
  orderId?: string,        // Order ID (if DEBT type)
  customerName?: string,   // Customer name (for DEBT)
  createdAt: string,       // ISO timestamp
  performedBy: 'system' | 'admin'
}
```

### Transaction Types
5. **DEBT:**
   - T·∫°o khi shipper giao ƒë∆°n COD
   - amount: Positive (increase debt)
   - performedBy: 'system'

6. **PAYMENT:**
   - T·∫°o khi admin thu/tr·∫£ ti·ªÅn
   - amount: Negative (thu) / Positive (tr·∫£)
   - performedBy: 'admin'

7. **REFUND:**
   - T·∫°o khi discount > adminShare
   - amount: Negative (admin owes)
   - performedBy: 'system'

### Balance Calculation
8. **Formula:** `sum(all amounts)`
9. **Result:**
   - Positive: Shipper owes admin
   - Negative: Admin owes shipper
   - Zero: No debt

### Input Validation
10. **Check Empty:** `!payAmount`
11. **Check Numeric:** `isNaN(payAmount)`
12. **No Negative:** User kh√¥ng c·∫ßn nh·∫≠p d·∫•u √¢m (auto flip)

### Amount Conversion
13. **User Input:** 30000 ƒë·ªìng
14. **Divide by 1000:** 30 k
15. **Flip Sign:** -30 ho·∫∑c +30
16. **Round:** 3 decimals
17. **Store:** -30 k

### Platform Differences
18. **Web Alert:** `window.alert(message)`
19. **Mobile Alert:** `Alert.alert("Title", message)`

### Realtime Update
20. **onSnapshot:** Auto update khi c√≥ transaction m·ªõi
21. **No Manual Refresh:** Data always synced

## üîç TRANSACTION EXAMPLES

### Example 1: Shipper giao ƒë∆°n
```js
{
  userId: 5,
  userName: "L√™ VƒÉn A",
  type: "DEBT",
  amount: 15, // Shipper n·ª£ th√™m 15k
  desc: "ƒê∆°n COD #order_123",
  orderId: "order_abc123xyz",
  customerName: "Nguy·ªÖn VƒÉn B",
  createdAt: "2026-01-27T10:00:00.000Z",
  performedBy: "system"
}
// Balance tr∆∞·ªõc: 50k ‚Üí Sau: 65k
```

### Example 2: Admin thu ti·ªÅn
```js
{
  userId: 5,
  userName: "L√™ VƒÉn A",
  type: "PAYMENT",
  amount: -30, // Gi·∫£m n·ª£ 30k
  desc: "Admin thu ti·ªÅn m·∫∑t",
  createdAt: "2026-01-27T11:00:00.000Z",
  performedBy: "admin"
}
// Balance tr∆∞·ªõc: 65k ‚Üí Sau: 35k
```

### Example 3: Admin tr·∫£ ti·ªÅn b√π
```js
{
  userId: 5,
  userName: "L√™ VƒÉn A",
  type: "PAYMENT",
  amount: 10, // Admin tr·∫£ 10k (balance √¢m)
  desc: "Admin tr·∫£ ti·ªÅn b√π (Voucher/Ship)",
  createdAt: "2026-01-27T12:00:00.000Z",
  performedBy: "admin"
}
// Balance tr∆∞·ªõc: -20k ‚Üí Sau: -10k
```

### Example 4: Refund t·ª´ discount
```js
{
  userId: 5,
  userName: "L√™ VƒÉn A",
  type: "REFUND",
  amount: -2, // Admin n·ª£ shipper 2k
  desc: "B√π discount v∆∞·ª£t qu√° adminShare",
  orderId: "order_def456",
  createdAt: "2026-01-27T13:00:00.000Z",
  performedBy: "system"
}
// Balance tr∆∞·ªõc: 10k ‚Üí Sau: 8k
```

## üéØ USE CASES

### 1. Shipper n·ªôp ti·ªÅn cu·ªëi ng√†y
- Balance: +150k (shipper n·ª£)
- Shipper ƒë∆∞a 100k cash
- Admin nh·∫≠p 100000 ‚Üí Thu n·ª£
- New balance: +50k

### 2. Shipper ƒë√£ tr·∫£ h·∫øt n·ª£, admin c√≤n thi·∫øu
- Balance: -5k (admin n·ª£ shipper)
- Admin tr·∫£ 5k cash
- Admin nh·∫≠p 5000 ‚Üí Tr·∫£ ti·ªÅn
- New balance: 0 (h√≤a)

### 3. Shipper giao nhi·ªÅu ƒë∆°n trong ng√†y
- Start balance: 0
- ƒê∆°n 1: +20k
- ƒê∆°n 2: +15k
- ƒê∆°n 3: +10k
- End balance: +45k
- Admin thu ti·ªÅn: -45k
- Final balance: 0

### 4. Discount l·ªõn, admin ph·∫£i b√π
- Balance: +30k (shipper n·ª£)
- Refund transaction: -35k (discount > adminShare)
- New balance: -5k (admin n·ª£ shipper)
- Admin tr·∫£ ti·ªÅn: +5k
- Final balance: 0

## üö® EDGE CASES

1. **No Transactions:**
   - transactions = []
   - totalBalance = 0
   - FlatList empty ‚Üí Show "Ch∆∞a c√≥ l·ªãch s·ª≠"

2. **Empty Input:**
   - payAmount = ''
   - Alert "Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá"

3. **Invalid Input:**
   - payAmount = 'abc'
   - isNaN check ‚Üí Alert error

4. **Zero Balance:**
   - totalBalance = 0
   - Button still shows "THU N·ª¢" (logic >= 0)
   - Amount flip: -inputVal
   - After payment: Balance goes negative (admin owes)

5. **Very Large Amount:**
   - payAmount = 99999999
   - No validation for max amount
   - Can create huge debt/credit

6. **Negative Input:**
   - User nh·∫≠p -30000
   - System still flip sign
   - May cause confusion ‚Üí Should validate > 0

7. **Float Precision:**
   - 0.1 + 0.2 = 0.30000000000000004
   - Rounding fixes this

8. **ShipperId Not Found:**
   - Invalid shipperId param
   - Query returns empty
   - totalBalance = 0, transactions = []

## üìù SUGGESTED IMPROVEMENTS

### 1. Amount Validation
```js
const amount = Number(payAmount);
if (amount <= 0) {
  Alert("S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0");
  return;
}

const MAX_AMOUNT = 10000000; // 10M
if (amount > MAX_AMOUNT) {
  Alert("S·ªë ti·ªÅn qu√° l·ªõn");
  return;
}
```

### 2. Confirmation Dialog
```js
const balanceAfter = totalBalance + finalAmount;
const message = `Thu ${(inputVal*1000).toLocaleString()}ƒë?\nS·ªë d∆∞ sau: ${(balanceAfter*1000).toLocaleString()}ƒë`;

Alert.alert("X√°c nh·∫≠n", message, [
  { text: "H·ªßy", style: "cancel" },
  { text: "X√°c nh·∫≠n", onPress: () => addTransaction() }
]);
```

### 3. Transaction Note
```js
const [note, setNote] = useState('');

<TextInput 
  placeholder="Ghi ch√∫ (optional)"
  value={note}
  onChangeText={setNote}
/>

// In transaction
desc: note || (totalBalance >= 0 ? 'Admin thu ti·ªÅn m·∫∑t' : 'Admin tr·∫£ ti·ªÅn b√π'),
```

### 4. Receipt Print
```js
const printReceipt = () => {
  const receipt = `
    PHI·∫æU THU TI·ªÄN
    Shipper: ${name}
    S·ªë ti·ªÅn: ${(inputVal*1000).toLocaleString()}ƒë
    S·ªë d∆∞ sau: ${((totalBalance+finalAmount)*1000).toLocaleString()}ƒë
    Th·ªùi gian: ${new Date().toLocaleString('vi-VN')}
  `;
  // Print or share receipt
};
```

### 5. Statistics Summary
```js
const stats = useMemo(() => {
  const debts = transactions.filter(t => t.type === 'DEBT');
  const payments = transactions.filter(t => t.type === 'PAYMENT');
  
  return {
    totalOrders: debts.length,
    totalDebt: debts.reduce((sum, t) => sum + t.amount, 0),
    totalPaid: payments.reduce((sum, t) => sum + Math.abs(t.amount), 0)
  };
}, [transactions]);

<View>
  <Text>T·ªïng ƒë∆°n: {stats.totalOrders}</Text>
  <Text>T·ªïng n·ª£: {(stats.totalDebt*1000).toLocaleString()}ƒë</Text>
  <Text>ƒê√£ n·ªôp: {(stats.totalPaid*1000).toLocaleString()}ƒë</Text>
</View>
```

### 6. Date Range Filter
```js
const [dateRange, setDateRange] = useState('today');

const filteredTransactions = transactions.filter(t => {
  const date = new Date(t.createdAt);
  const today = new Date();
  
  switch(dateRange) {
    case 'today':
      return date.toDateString() === today.toDateString();
    case 'week':
      // Last 7 days
      return (today - date) < 7 * 24 * 60 * 60 * 1000;
    // ...
  }
});
```

### 7. Export Excel
```js
import * as FileSystem from 'expo-file-system';
import * as Sharing from 'expo-sharing';

const exportToExcel = async () => {
  // Generate CSV or XLSX
  const csv = transactions.map(t => 
    `${t.createdAt},${t.desc},${t.amount}`
  ).join('\n');
  
  const path = FileSystem.documentDirectory + 'transactions.csv';
  await FileSystem.writeAsStringAsync(path, csv);
  await Sharing.shareAsync(path);
};
```

### 8. Search Transactions
```js
const [searchQuery, setSearchQuery] = useState('');

const searchedTransactions = transactions.filter(t =>
  t.desc.toLowerCase().includes(searchQuery.toLowerCase()) ||
  t.orderId?.includes(searchQuery)
);
```
