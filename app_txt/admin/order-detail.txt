# TÃ“M Táº®T LOGIC TRANG ADMIN/ORDER-DETAIL.TSX

## ğŸ¯ Má»¤C ÄÃCH
MÃ n hÃ¬nh chi tiáº¿t Ä‘Æ¡n hÃ ng food (admin view):
- Xem thÃ´ng tin Ä‘áº§y Ä‘á»§ cá»§a Ä‘Æ¡n hÃ ng
- Hiá»ƒn thá»‹ khÃ¡ch hÃ ng, shipper, danh sÃ¡ch mÃ³n
- Xem nháº­t kÃ½ váº­n hÃ nh (logs)
- Admin cÃ³ thá»ƒ reset Ä‘Æ¡n vá» pending
- Admin cÃ³ thá»ƒ há»§y Ä‘Æ¡n
- KhÃ´ng cÃ³ chá»©c nÄƒng giao hÃ ng (shipper lÃ m)

## ğŸ“Š STATE & DATA

**Store:**
- `foodOrders`: Danh sÃ¡ch Ä‘Æ¡n hÃ ng food
- `users`: Danh sÃ¡ch users (Ä‘á»ƒ láº¥y shipper info)
- `currentUser`: User Ä‘ang login (check role admin)

**Route Params:**
- `orderId`: ID cá»§a Ä‘Æ¡n hÃ ng cáº§n xem

**Computed:**
```js
const order = useMemo(() => 
  foodOrders.find(o => 
    String(o.orderId) === String(orderId) || 
    String(o.id) === String(orderId)
  )
, [orderId, foodOrders]);

const shipperInfo = order?.shipperId 
  ? users.find(u => String(u.id) === String(order.shipperId)) 
  : null;

const isAdmin = currentUser?.role === 'admin';
```

## ğŸ”„ LUá»’NG THá»°C THI

### 1. Load Order
```js
// useMemo Ä‘á»ƒ trÃ¡nh re-compute má»—i láº§n render
const order = useMemo(() => {
  return foodOrders.find(o => 
    String(o.orderId) === String(orderId) || 
    String(o.id) === String(orderId)
  );
}, [orderId, foodOrders]);

// Náº¿u khÃ´ng tÃ¬m tháº¥y â†’ Show error
if (!order) {
  return <Text>KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng</Text>;
}
```

### 2. Update Status (Admin Only)
```js
const updateStatus = async (newStatus, note, isReset = false) => {
  try {
    const orderRef = doc(db, 'foodOrders', order.id || order.orderId);
    
    // Táº¡o log entry
    const newLog = {
      content: note,
      status: newStatus,
      time: new Date().toISOString()
    };
    
    // Prepare update data
    const updateData = {
      status: newStatus,
      logs: arrayUnion(newLog)
    };
    
    // Náº¿u reset â†’ Gá»¡ shipper
    if (isReset) {
      updateData.shipperId = null;
    }
    
    await updateDoc(orderRef, updateData);
    
    // Alert success
    if (Platform.OS === 'web') {
      window.alert("ThÃ nh cÃ´ng: ÄÃ£ cáº­p nháº­t Ä‘Æ¡n hÃ ng");
    } else {
      Alert.alert("ThÃ nh cÃ´ng", "ÄÃ£ cáº­p nháº­t Ä‘Æ¡n hÃ ng");
    }
  } catch (error) {
    Alert.alert("Lá»—i", "KhÃ´ng thá»ƒ thá»±c hiá»‡n thao tÃ¡c");
  }
};
```

### 3. Reset Order
```js
// Reset vá» pending + gá»¡ shipper
updateStatus('pending', 'Admin Ä‘Ã£ reset Ä‘Æ¡n hÃ ng', true);
```

### 4. Cancel Order
```js
// Há»§y Ä‘Æ¡n
updateStatus('cancelled', 'Admin Ä‘Ã£ há»§y Ä‘Æ¡n hÃ ng');
```

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### Platform-Specific Alert
```js
const showAlert = (title, message, onPressOk) => {
  if (Platform.OS === 'web') {
    const confirm = window.confirm(`${title}: ${message}`);
    if (confirm) onPressOk();
  } else {
    Alert.alert(title, message, [
      { text: "Há»§y", style: "cancel" },
      { text: "Äá»“ng Ã½", onPress: onPressOk }
    ]);
  }
};
```

### Status Label Mapping
```js
const getStatusLabel = (status) => {
  switch (status) {
    case 'pending': return 'CHá»œ NHáº¬N';
    case 'processing': return 'ÄANG GIAO';
    case 'completed': return 'HOÃ€N THÃ€NH';
    case 'cancelled': return 'ÄÃƒ Há»¦Y';
    default: return status?.toUpperCase();
  }
};
```

### Price Display
```js
// All prices stored in "k" (thousands)
// Display: multiply by 1000 and format
(order.totalFood * 1000).toLocaleString() + 'Ä‘'
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button
  â”‚   â”œâ”€ Title: "Chi tiáº¿t Ä‘Æ¡n hÃ ng"
  â”‚   â””â”€ Spacer
  â”‚
  â””â”€ ScrollView
      â”œâ”€ Card: THÃ”NG TIN CHUNG & TRáº NG THÃI
      â”‚   â”œâ”€ Order ID + Status Label
      â”‚   â””â”€ Created Time
      â”‚
      â”œâ”€ Card: THÃ”NG TIN KHÃCH HÃ€NG
      â”‚   â”œâ”€ Icon + Name
      â”‚   â”œâ”€ Icon + Phone
      â”‚   â””â”€ Icon + Address
      â”‚
      â”œâ”€ Card: THÃ”NG TIN SHIPPER (náº¿u cÃ³ shipperId)
      â”‚   â”œâ”€ Icon + Shipper Name
      â”‚   â””â”€ Icon + Shipper Phone
      â”‚   (Green border left 4px)
      â”‚
      â”œâ”€ Card: DANH SÃCH MÃ“N
      â”‚   â””â”€ Food Items (map)
      â”‚       â”œâ”€ Image (45x45)
      â”‚       â”œâ”€ Name + Quantity
      â”‚       â””â”€ Price
      â”‚
      â”œâ”€ Card: CHI TIáº¾T THANH TOÃN
      â”‚   â”œâ”€ Tiá»n mÃ³n (totalFood)
      â”‚   â”œâ”€ PhÃ­ váº­n chuyá»ƒn gá»‘c (baseShip)
      â”‚   â”œâ”€ PhÃ­ thÃªm shop (extraStepFee) (náº¿u > 0)
      â”‚   â”œâ”€ Khuyáº¿n mÃ£i (discount) (náº¿u > 0, mÃ u Ä‘á»)
      â”‚   â”œâ”€ Divider
      â”‚   â””â”€ Tá»”NG Cá»˜NG (finalTotal, bold, mÃ u primary)
      â”‚
      â”œâ”€ Card: NHáº¬T KÃ Váº¬N HÃ€NH
      â”‚   â””â”€ Log Items (map)
      â”‚       â”œâ”€ Dot (primary color)
      â”‚       â”œâ”€ Content
      â”‚       â””â”€ Time
      â”‚
      â””â”€ Admin Actions (náº¿u isAdmin && status !== 'completed')
          â”œâ”€ RESET ÄÆ N button (náº¿u status !== 'pending' || cÃ³ shipperId)
          â””â”€ Há»¦Y ÄÆ N button (náº¿u status !== 'cancelled')
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

### Order ID Handling
1. **Flexible Matching:**
   - Find by `orderId` OR `id`
   - String comparison Ä‘á»ƒ trÃ¡nh type mismatch
   - useMemo Ä‘á»ƒ optimize

### Shipper Display
2. **Conditional Rendering:**
   - Chá»‰ show card náº¿u `order.shipperId` tá»“n táº¡i
   - Green border left Ä‘á»ƒ highlight
   - Fallback: Náº¿u khÃ´ng tÃ¬m tháº¥y shipper info â†’ Show ID

3. **Shipper Info:**
   ```js
   shipperInfo ? (
     <>
       <Text>{shipperInfo.name}</Text>
       <Text>{shipperInfo.phone}</Text>
     </>
   ) : (
     <Text>ID Shipper: #{order.shipperId}</Text>
   )
   ```

### Status Flow
4. **Status States:**
   - `pending`: Chá» shipper nháº­n
   - `processing`: Shipper Ä‘Ã£ nháº­n, Ä‘ang giao
   - `completed`: Giao thÃ nh cÃ´ng
   - `cancelled`: ÄÃ£ há»§y

5. **Status Colors:** (not in styles, but suggested)
   - pending: Orange
   - processing: Blue
   - completed: Green
   - cancelled: Red

### Price Breakdown
6. **TotalFood:**
   - Tá»•ng tiá»n mÃ³n Äƒn
   - KhÃ´ng bao gá»“m ship

7. **BaseShip:**
   - PhÃ­ ship cÆ¡ báº£n (1 shop)

8. **ExtraStepFee:**
   - PhÃ­ thÃªm khi Ä‘áº·t nhiá»u shop
   - Chá»‰ hiá»ƒn thá»‹ náº¿u > 0
   - Formula: `(shopIds.length - 1) * feePerShop`

9. **Discount:**
   - GiÃ¡ trá»‹ giáº£m tá»« promo code
   - Hiá»ƒn thá»‹ mÃ u Ä‘á»
   - Dáº¥u "-" phÃ­a trÆ°á»›c

10. **FinalTotal:**
    - = totalFood + baseShip + extraStepFee - discount
    - Bold, mÃ u primary, fontSize 20

### Logs Display
11. **Log Structure:**
    ```js
    {
      content: string,  // "Shipper Ä‘Ã£ nháº­n Ä‘Æ¡n"
      status: string,   // "processing"
      time: string      // ISO timestamp
    }
    ```

12. **Log UI:**
    - Dot indicator (8x8, primary color)
    - Content (fontSize 13)
    - Time (fontSize 11, gray, localized)

### Admin Actions
13. **Visibility:**
    - Chá»‰ show náº¿u `isAdmin = true`
    - áº¨n náº¿u `status = 'completed'`

14. **Reset Button:**
    - Show náº¿u:
      - `status !== 'pending'` OR
      - `order.shipperId` tá»“n táº¡i
    - Action:
      - Set status â†’ 'pending'
      - Set shipperId â†’ null
      - Add log: "Admin Ä‘Ã£ reset Ä‘Æ¡n hÃ ng"

15. **Cancel Button:**
    - Show náº¿u `status !== 'cancelled'`
    - Action:
      - Set status â†’ 'cancelled'
      - Add log: "Admin Ä‘Ã£ há»§y Ä‘Æ¡n hÃ ng"

### Platform Differences
16. **Web Alert:**
    - DÃ¹ng `window.confirm()`
    - Return true/false

17. **Mobile Alert:**
    - DÃ¹ng `Alert.alert()`
    - 2 buttons: Há»§y, Äá»“ng Ã½

## ğŸš€ USER JOURNEY

### Admin - Xem chi tiáº¿t Ä‘Æ¡n
1. Navigate to `/admin/order-detail?orderId=123`
2. Load order data tá»« store
3. Xem thÃ´ng tin:
   - KhÃ¡ch hÃ ng: TÃªn, SÄT, Äá»‹a chá»‰
   - Shipper: TÃªn, SÄT (náº¿u cÃ³)
   - Danh sÃ¡ch mÃ³n
   - Chi tiáº¿t thanh toÃ¡n
   - Nháº­t kÃ½ váº­n hÃ nh
4. Scroll Ä‘á»ƒ xem toÃ n bá»™

### Admin - Reset Ä‘Æ¡n vá» pending
1. ÄÆ¡n Ä‘ang processing hoáº·c completed
2. Shipper chÆ°a giao Ä‘Æ°á»£c â†’ Cáº§n assign shipper khÃ¡c
3. Nháº¥n "RESET ÄÆ N"
4. Confirm â†’ updateStatus('pending', ..., true)
5. Order status â†’ 'pending'
6. ShipperId â†’ null
7. Log má»›i: "Admin Ä‘Ã£ reset Ä‘Æ¡n hÃ ng"

### Admin - Há»§y Ä‘Æ¡n
1. ÄÆ¡n cÃ³ váº¥n Ä‘á» (customer request, khÃ´ng thá»ƒ giao, v.v.)
2. Nháº¥n "Há»¦Y ÄÆ N"
3. Confirm â†’ updateStatus('cancelled', ...)
4. Order status â†’ 'cancelled'
5. Log má»›i: "Admin Ä‘Ã£ há»§y Ä‘Æ¡n hÃ ng"

### Shipper - Xem Ä‘Æ¡n (not this file)
- Shipper cÃ³ trang riÃªng Ä‘á»ƒ xem orders
- Shipper cÃ³ thá»ƒ accept order (pending â†’ processing)
- Shipper cÃ³ thá»ƒ complete order (processing â†’ completed)

## ğŸ”— NAVIGATION

**Navigates TO:** KhÃ´ng

**Navigates FROM:**
- Admin Orders page â†’ Nháº¥n vÃ o order card
- Admin search â†’ Nháº¥n vÃ o result

**Back Navigation:**
- Back button (header left) â†’ `router.back()`

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

### Firestore Operations
1. **Collection:** `foodOrders`
2. **Document ID:** `order.id` hoáº·c `order.orderId`
3. **Update:** `updateDoc(orderRef, {...})`
4. **ArrayUnion:** Add log without overwriting existing logs

### Order Structure
```js
{
  id: string,
  orderId: string,         // Same as id (duplicate)
  userId: number,
  userName: string,
  userPhone: string,
  address: string,
  shipperId: number | null,
  status: 'pending' | 'processing' | 'completed' | 'cancelled',
  items: Array<{
    img: string,
    name: string,
    quantity: number,
    pricePromo: number
  }>,
  totalFood: number,       // NghÃ¬n Ä‘á»“ng
  baseShip: number,
  extraStepFee: number,
  discount: number,
  finalTotal: number,
  shopIds: number[],       // Array shop IDs trong order
  logs: Array<{
    content: string,
    status: string,
    time: string
  }>,
  createdAt: string        // ISO timestamp
}
```

### Status Management
5. **Status Flow:**
   ```
   pending â†’ processing â†’ completed
              â†“
           cancelled
   ```

6. **Reset Flow:**
   ```
   processing/completed â†’ pending (+ remove shipperId)
   ```

7. **Cannot Reset From:**
   - pending (without shipperId) â†’ Already in initial state

### Price Calculation
8. **All Prices in "k" (thousands):**
   - totalFood = 50 â†’ 50,000Ä‘
   - Display: `(value * 1000).toLocaleString() + 'Ä‘'`

9. **Extra Step Fee:**
   ```js
   // Example: 2 shops
   shopIds = [1, 5]
   extraStepFee = (2 - 1) * feePerShop
   ```

10. **Discount Application:**
    ```js
    // Promo code: 10%
    discount = (totalFood + baseShip + extraStepFee) * 0.1
    finalTotal = totalFood + baseShip + extraStepFee - discount
    ```

### Logs Array
11. **ArrayUnion:**
    - Append new log without overwriting
    - Firestore operation: `arrayUnion(newLog)`

12. **Log Order:**
    - Oldest to newest (chronological)
    - Display: Map through logs array

### UseMemo Optimization
13. **Order Lookup:**
    - useMemo Ä‘á»ƒ trÃ¡nh re-search má»—i render
    - Dependencies: [orderId, foodOrders]

14. **Shipper Lookup:**
    - useMemo hoáº·c direct find (simple)

### Role Check
15. **Admin Only Actions:**
    - Check `currentUser.role === 'admin'`
    - Hide buttons náº¿u khÃ´ng pháº£i admin

16. **Shipper Cannot:**
    - Shipper khÃ´ng vÃ o trang nÃ y
    - Shipper cÃ³ trang riÃªng (shipper order detail)

### Error Handling
17. **Order Not Found:**
    - Show error message
    - Header + centered text

18. **Update Failed:**
    - Alert "Lá»—i", "KhÃ´ng thá»ƒ thá»±c hiá»‡n thao tÃ¡c"
    - Log error (nÃªn thÃªm)

### ScrollView
19. **contentContainerStyle:** `{ padding: 15 }`
20. **Scroll:** Táº¥t cáº£ content scrollable

## ğŸ” LOG EXAMPLES

### Log Timeline
```js
[
  {
    content: "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c táº¡o",
    status: "pending",
    time: "2026-01-27T10:00:00.000Z"
  },
  {
    content: "Shipper #5 Ä‘Ã£ nháº­n Ä‘Æ¡n",
    status: "processing",
    time: "2026-01-27T10:15:00.000Z"
  },
  {
    content: "Shipper Ä‘ang giao hÃ ng",
    status: "processing",
    time: "2026-01-27T10:30:00.000Z"
  },
  {
    content: "Admin Ä‘Ã£ reset Ä‘Æ¡n hÃ ng",
    status: "pending",
    time: "2026-01-27T10:45:00.000Z"
  },
  {
    content: "Shipper #10 Ä‘Ã£ nháº­n Ä‘Æ¡n",
    status: "processing",
    time: "2026-01-27T11:00:00.000Z"
  },
  {
    content: "Giao hÃ ng thÃ nh cÃ´ng",
    status: "completed",
    time: "2026-01-27T11:30:00.000Z"
  }
]
```

## ğŸ¯ USE CASES

### 1. Shipper chÆ°a giao Ä‘Æ°á»£c
- Status: processing
- ShipperId: 5
- Problem: Shipper báº­n, khÃ´ng thá»ƒ giao
- Action: Admin reset â†’ pending
- Result: Order quay vá» pending, shipperId = null, shipper khÃ¡c cÃ³ thá»ƒ nháº­n

### 2. Customer há»§y Ä‘Æ¡n
- Status: pending hoáº·c processing
- Customer gá»i yÃªu cáº§u há»§y
- Action: Admin cancel
- Result: Order status = cancelled, khÃ´ng thá»ƒ giao ná»¯a

### 3. Xem lá»‹ch sá»­ Ä‘Æ¡n
- Admin cáº§n kiá»ƒm tra logs
- Xem timeline: Táº¡o â†’ Shipper nháº­n â†’ Giao thÃ nh cÃ´ng
- Verify thá»i gian giao hÃ ng

### 4. Multi-shop order
- Items tá»« 2 shops: shopIds = [1, 5]
- BaseShip: 15k
- ExtraStepFee: 5k (1 shop thÃªm)
- Total ship: 20k

### 5. Promo order
- Promo code: FREESHIP02 (giáº£m 10%)
- TotalFood + Ship: 100k
- Discount: 10k
- FinalTotal: 90k

## ğŸš¨ EDGE CASES

1. **Order Not Found:**
   - orderId khÃ´ng tá»“n táº¡i trong foodOrders
   - Show error view

2. **ShipperId Without Info:**
   - order.shipperId = 5
   - users khÃ´ng cÃ³ user vá»›i id=5 (user bá»‹ xÃ³a)
   - Fallback: "ID Shipper: #5"

3. **Empty Logs:**
   - Order má»›i táº¡o, logs = []
   - Nothing to display

4. **Completed Order:**
   - Admin buttons hidden
   - Cannot reset/cancel completed orders

5. **Web vs Mobile:**
   - Alert khÃ¡c nhau
   - window.confirm vs Alert.alert

6. **Multiple Shops:**
   - extraStepFee calculation
   - Show "+ X shop" text

7. **No Discount:**
   - discount = 0
   - Don't show discount row

8. **No ExtraStepFee:**
   - Single shop order
   - Don't show extraStepFee row

## ğŸ“ SUGGESTED IMPROVEMENTS

### 1. Status Color Badge
```js
const statusColors = {
  pending: '#FFA726',
  processing: '#42A5F5',
  completed: '#66BB6A',
  cancelled: '#EF5350'
};

<View style={[styles.statusBadge, { backgroundColor: statusColors[order.status] }]}>
  <Text style={styles.statusText}>{getStatusLabel(order.status)}</Text>
</View>
```

### 2. Copy Order ID
```js
<TouchableOpacity onPress={() => Clipboard.setString(order.orderId)}>
  <Text style={styles.orderIdText}>#{order.orderId}</Text>
</TouchableOpacity>
```

### 3. Call Customer/Shipper
```js
<TouchableOpacity onPress={() => Linking.openURL(`tel:${order.userPhone}`)}>
  <Ionicons name="call" size={18} color="#4CAF50" />
</TouchableOpacity>
```

### 4. Map Location
```js
<TouchableOpacity onPress={() => openMap(order.address)}>
  <Ionicons name="navigate" size={18} color="#2196F3" />
</TouchableOpacity>
```

### 5. Refresh Button
```js
<TouchableOpacity onPress={() => refetchOrder()}>
  <Ionicons name="refresh" size={24} />
</TouchableOpacity>
```

### 6. Assign Shipper (Admin)
```js
<TouchableOpacity onPress={() => showShipperPicker()}>
  <Text>Chá»n Shipper</Text>
</TouchableOpacity>
```

### 7. Order Timeline Visual
```js
// Progress bar: pending â†’ processing â†’ completed
<View style={styles.timeline}>
  <View style={[styles.step, order.status !== 'pending' && styles.stepComplete]}>
    <Text>Chá» nháº­n</Text>
  </View>
  <View style={styles.line} />
  <View style={[styles.step, order.status === 'completed' && styles.stepComplete]}>
    <Text>Äang giao</Text>
  </View>
  <View style={styles.line} />
  <View style={[styles.step, order.status === 'completed' && styles.stepComplete]}>
    <Text>HoÃ n thÃ nh</Text>
  </View>
</View>
```
