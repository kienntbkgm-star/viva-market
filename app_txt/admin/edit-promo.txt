# T√ìM T·∫ÆT LOGIC TRANG ADMIN/EDIT-PROMO.TSX

## üéØ M·ª§C ƒê√çCH
M√†n h√¨nh th√™m/s·ª≠a m√£ gi·∫£m gi√° (promo code):
- T·∫°o m√£ khuy·∫øn m√£i m·ªõi ho·∫∑c c·∫≠p nh·∫≠t m√£ c√≥ s·∫µn
- C·∫•u h√¨nh gi√° tr·ªã gi·∫£m (%), gi·ªõi h·∫°n s·ª≠ d·ª•ng
- Thi·∫øt l·∫≠p th·ªùi h·∫°n (durationDays)
- Theo d√µi ng∆∞·ªùi d√πng ƒë√£ s·ª≠ d·ª•ng (usedBy array)
- Hi·ªÉn th·ªã th√¥ng tin users ƒë√£ d√πng m√£

## üìä STATE & DATA

**Store:**
- `promos`: Danh s√°ch m√£ gi·∫£m gi√° (load ƒë·ªÉ edit)
- `users`: Danh s√°ch users (ƒë·ªÉ hi·ªÉn th·ªã usedBy info)

**Route Params:**
- `id`: ID promo (n·∫øu edit), undefined n·∫øu t·∫°o m·ªõi

**Local State:**
```js
loading: boolean
formData: {
  code: string,           // M√£ gi·∫£m gi√° (VD: "FREESHIP02")
  value: string,          // % gi·∫£m gi√° (VD: "10")
  limit: string,          // T·ªïng l∆∞·ª£t d√πng (VD: "100")
  maxPerUser: string,     // L∆∞·ª£t d√πng/ng∆∞·ªùi (VD: "1")
  durationDays: string,   // S·ªë ng√†y hi·ªáu l·ª±c (VD: "30")
  enable: boolean,        // Tr·∫°ng th√°i k√≠ch ho·∫°t
  used: number,           // S·ªë l∆∞·ª£t ƒë√£ d√πng (readonly)
  usedBy: number[],       // Array userId ƒë√£ d√πng (readonly)
  created: string         // ISO timestamp (readonly)
}
```

## üîÑ LU·ªíNG TH·ª∞C THI

### 1. Load Data (Edit Mode)
```js
useEffect(() => {
  if (id && promos) {
    const promo = promos.find(p => p.id === id);
    if (promo) {
      setFormData({
        ...promo,
        value: promo.value.toString(),
        limit: promo.limit.toString(),
        maxPerUser: promo.maxPerUser.toString(),
        durationDays: promo.durationDays.toString()
      });
    }
  }
}, [id, promos]);
```

### 2. Save to Firestore
```js
const handleSave = async () => {
  // Validation
  if (!formData.code || !formData.value || !formData.limit) {
    Alert.alert("L·ªói", "Vui l√≤ng nh·∫≠p M√£, Gi√° tr·ªã v√† Gi·ªõi h·∫°n");
    return;
  }
  
  setLoading(true);
  
  try {
    const promoId = id || Date.now().toString();
    const promoRef = doc(db, 'promos', promoId);
    
    const finalData = {
      ...formData,
      id: promoId,
      code: formData.code.toUpperCase().trim(), // Auto uppercase
      value: Number(formData.value),
      limit: Number(formData.limit),
      maxPerUser: Number(formData.maxPerUser),
      durationDays: Number(formData.durationDays),
      enable: Boolean(formData.enable),
      created: formData.created,
      used: Number(formData.used || 0),
      usedBy: formData.usedBy || []
    };
    
    if (id) {
      await updateDoc(promoRef, finalData);
    } else {
      await setDoc(promoRef, finalData);
    }
    
    Alert.alert("Th√†nh c√¥ng", "ƒê√£ l∆∞u m√£ khuy·∫øn m√£i");
    router.back();
  } catch (error) {
    Alert.alert("L·ªói", "Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu v√†o Firebase");
  } finally {
    setLoading(false);
  }
};
```

### 3. Display UsedBy Users
```js
const getUserInfo = (userId) => {
  return users.find(u => String(u.id) === String(userId));
};

// Render
{formData.usedBy.map((userId, index) => {
  const user = getUserInfo(userId);
  return (
    <View key={index} style={styles.userItem}>
      <View style={styles.userAvatar}>
        <Text>{user?.name?.charAt(0) || '?'}</Text>
      </View>
      <View>
        <Text>{user?.name || `User ID: ${userId}`}</Text>
        <Text>{user?.phone || 'Kh√¥ng c√≥ SƒêT'}</Text>
      </View>
    </View>
  );
})}
```

## üîß C√ÅC FUNCTION QUAN TR·ªåNG

### Auto Uppercase Code
```js
// Khi save ‚Üí Auto convert to uppercase
code: formData.code.toUpperCase().trim()

// Input field
autoCapitalize="characters" // User g√µ t·ª± ƒë·ªông uppercase
```

### Expiry Calculation
```js
// Backend logic (not in this file, but related)
const created = new Date(promo.created);
const expiry = new Date(created.getTime() + promo.durationDays * 24 * 60 * 60 * 1000);
const isExpired = Date.now() > expiry.getTime();
```

### UsedBy Tracking
```js
// Khi user d√πng m√£ (logic ·ªü cart/checkout)
await updateDoc(promoRef, {
  used: increment(1),
  usedBy: arrayUnion(userId)
});
```

## üé® UI C·∫§U TR√öC

```
SafeAreaView
  ‚îú‚îÄ Header
  ‚îÇ   ‚îú‚îÄ Back Button
  ‚îÇ   ‚îú‚îÄ Title: "C·∫≠p nh·∫≠t m√£" / "T·∫°o m√£ m·ªõi"
  ‚îÇ   ‚îÇ   ‚îî‚îÄ ID Subtitle (n·∫øu edit)
  ‚îÇ   ‚îî‚îÄ Save Button (v·ªõi loading state)
  ‚îÇ
  ‚îî‚îÄ KeyboardAvoidingView
      ‚îî‚îÄ ScrollView (Form Container)
          ‚îú‚îÄ M√£ gi·∫£m gi√° (Code) (TextInput, autoCapitalize)
          ‚îú‚îÄ Row 1:
          ‚îÇ   ‚îú‚îÄ Gi√° tr·ªã gi·∫£m (%)
          ‚îÇ   ‚îî‚îÄ T·ªïng l∆∞·ª£t d√πng (Limit)
          ‚îú‚îÄ Row 2:
          ‚îÇ   ‚îú‚îÄ S·ªë ng√†y hi·ªáu l·ª±c (durationDays)
          ‚îÇ   ‚îî‚îÄ L∆∞·ª£t d√πng/Ng∆∞·ªùi (maxPerUser)
          ‚îú‚îÄ Tr·∫°ng th√°i k√≠ch ho·∫°t (Switch enable)
          ‚îú‚îÄ Ng∆∞·ªùi d√πng ƒë√£ s·ª≠ d·ª•ng (usedBy Section)
          ‚îÇ   ‚îî‚îÄ User List
          ‚îÇ       ‚îî‚îÄ User Item (map)
          ‚îÇ           ‚îú‚îÄ Avatar (ch·ªØ c√°i ƒë·∫ßu)
          ‚îÇ           ‚îú‚îÄ Name
          ‚îÇ           ‚îî‚îÄ Phone
          ‚îî‚îÄ Ng√†y t·∫°o (Readonly text)
```

## ‚ö° ƒêI·ªÇM ƒê·∫∂C BI·ªÜT

### Promo Code Format
1. **Auto Uppercase:**
   - User nh·∫≠p "freeship02" ‚Üí Save th√†nh "FREESHIP02"
   - `autoCapitalize="characters"` trong TextInput

2. **Trim Whitespace:**
   - User nh·∫≠p " FREESHIP02 " ‚Üí Save th√†nh "FREESHIP02"

### Expiry Logic
3. **Duration Days:**
   - S·ªë ng√†y hi·ªáu l·ª±c k·ªÉ t·ª´ ng√†y t·∫°o
   - VD: created = 2026-01-01, durationDays = 30
   - ‚Üí Expiry = 2026-01-31

4. **Enable vs Expired:**
   - `enable = false`: Admin t·∫Øt m√£
   - `isExpired = true`: M√£ h·∫øt h·∫°n (backend check)
   - C·∫£ 2 ƒëi·ªÅu ki·ªán ƒë·ªÅu l√†m m√£ kh√¥ng d√πng ƒë∆∞·ª£c

### Usage Tracking
5. **Used Count:**
   - Increment m·ªói khi user apply m√£
   - Readonly trong edit form (kh√¥ng cho admin s·ª≠a)

6. **UsedBy Array:**
   - L∆∞u userId c·ªßa ng∆∞·ªùi ƒë√£ d√πng
   - D√πng ƒë·ªÉ:
     - Hi·ªÉn th·ªã danh s√°ch users ƒë√£ d√πng
     - Check maxPerUser (1 user d√πng bao nhi√™u l·∫ßn)

7. **Limit Check:**
   - `used >= limit` ‚Üí M√£ h·∫øt l∆∞·ª£t
   - Backend check khi apply

### User Display
8. **Avatar:**
   - Ch·ªØ c√°i ƒë·∫ßu t√™n user
   - Background: #F2F2F2
   - Text color: primary

9. **Fallback:**
   - Name kh√¥ng c√≥ ‚Üí Hi·ªÉn th·ªã "User ID: [userId]"
   - Phone kh√¥ng c√≥ ‚Üí "Kh√¥ng c√≥ SƒêT"
   - Avatar kh√¥ng c√≥ name ‚Üí "?"

10. **Empty State:**
    - `usedBy.length === 0` ‚Üí "Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o s·ª≠ d·ª•ng m√£ n√†y."
    - Style: italic, color #BBB

### Created Timestamp
11. **Display:**
    - Format: `new Date(formData.created).toLocaleString('vi-VN')`
    - VD: "27/01/2026, 10:30:15"
    - Color: #BBB, fontSize: 11

12. **Create Mode:**
    - Default: `new Date().toISOString()`

## üöÄ USER JOURNEY

### Admin - T·∫°o m√£ m·ªõi
1. Navigate to `/admin/edit-promo` (kh√¥ng c√≥ id param)
2. Nh·∫≠p m√£ code: "FREESHIP02"
3. Nh·∫≠p gi√° tr·ªã gi·∫£m: 10% (VD: gi·∫£m 10% t·ªïng ƒë∆°n)
4. Nh·∫≠p gi·ªõi h·∫°n: 100 l∆∞·ª£t
5. Nh·∫≠p s·ªë ng√†y hi·ªáu l·ª±c: 30 ng√†y
6. Nh·∫≠p l∆∞·ª£t d√πng/ng∆∞·ªùi: 1 (m·ªói user ch·ªâ d√πng 1 l·∫ßn)
7. B·∫≠t tr·∫°ng th√°i enable (Switch)
8. Nh·∫•n "L∆∞u" ‚Üí T·∫°o promo m·ªõi
9. Alert "Th√†nh c√¥ng" ‚Üí Back to promos list

### Admin - S·ª≠a m√£ c√≥ s·∫µn
1. Navigate to `/admin/edit-promo?id=123`
2. Load data: code, value, limit, maxPerUser, durationDays
3. Xem danh s√°ch users ƒë√£ d√πng (usedBy section)
4. S·ª≠a c√°c tr∆∞·ªùng c·∫ßn thi·∫øt (VD: tƒÉng limit, t·∫Øt enable)
5. ‚ö†Ô∏è Kh√¥ng s·ª≠a: used, usedBy, created (readonly)
6. Nh·∫•n "L∆∞u" ‚Üí Update promo
7. Alert "Th√†nh c√¥ng" ‚Üí Back to promos list

### User - S·ª≠ d·ª•ng m√£ (kh√¥ng c√≥ trong file n√†y)
1. User v√†o cart ‚Üí Nh·∫≠p m√£ "FREESHIP02"
2. Backend check:
   - M√£ t·ªìn t·∫°i?
   - enable = true?
   - Ch∆∞a h·∫øt h·∫°n? (created + durationDays)
   - used < limit?
   - User ƒë√£ d√πng < maxPerUser?
3. N·∫øu h·ª£p l·ªá:
   - Apply discount: totalPrice * (value / 100)
   - Increment used: used + 1
   - Add userId to usedBy: arrayUnion(userId)

## üîó NAVIGATION

**Navigates TO:** Kh√¥ng (modal-style screen)

**Navigates FROM:**
- Admin Promos page ‚Üí Nh·∫•n "S·ª≠a" tr√™n promo card
- Admin Promos page ‚Üí Nh·∫•n "Th√™m m√£ m·ªõi"

**Back Navigation:**
- Back button (header left)
- After save success ‚Üí `router.back()`

## üí° L∆ØU √ù K·ª∏ THU·∫¨T

### Firestore Operations
1. **Collection:** `promos`
2. **Document ID:**
   - Edit: Use existing `id`
   - Create: `Date.now().toString()` (timestamp string)
3. **Update vs SetDoc:**
   - Edit: `updateDoc(promoRef, finalData)`
   - Create: `setDoc(promoRef, finalData)`

### Promo Structure
```js
{
  id: string,
  code: string,          // "FREESHIP02" (uppercase)
  value: number,         // 10 (%)
  limit: number,         // 100 (t·ªïng l∆∞·ª£t d√πng)
  maxPerUser: number,    // 1 (l∆∞·ª£t d√πng/ng∆∞·ªùi)
  durationDays: number,  // 30 (s·ªë ng√†y hi·ªáu l·ª±c)
  enable: boolean,       // true/false
  used: number,          // 15 (s·ªë l∆∞·ª£t ƒë√£ d√πng)
  usedBy: number[],      // [1, 5, 10, ...] (userId array)
  created: string        // "2026-01-27T..." (ISO timestamp)
}
```

### Validation Rules
4. **Required Fields:**
   - ‚úÖ `code`: Kh√¥ng r·ªóng
   - ‚úÖ `value`: Kh√¥ng r·ªóng, ph·∫£i l√† s·ªë > 0
   - ‚úÖ `limit`: Kh√¥ng r·ªóng, ph·∫£i l√† s·ªë > 0

5. **Optional Fields:**
   - `maxPerUser`: Default "1"
   - `durationDays`: Default "30"
   - `enable`: Default true

6. **Readonly Fields:**
   - `used`: Kh√¥ng cho admin s·ª≠a (system update)
   - `usedBy`: Kh√¥ng cho admin s·ª≠a (system update)
   - `created`: Kh√¥ng cho admin s·ª≠a (immutable)

### No Validation (Suggested Improvements)
7. **Value Range:**
   - Kh√¥ng validate 0 < value <= 100
   - Admin c√≥ th·ªÉ nh·∫≠p 150% (kh√¥ng h·ª£p l√Ω)

8. **Duplicate Code:**
   - Kh√¥ng check code ƒë√£ t·ªìn t·∫°i
   - C√≥ th·ªÉ t·∫°o 2 m√£ gi·ªëng nhau

9. **Expiry Display:**
   - Kh√¥ng hi·ªÉn th·ªã ng√†y h·∫øt h·∫°n
   - Admin ph·∫£i t·ª± t√≠nh: created + durationDays

10. **Used/Limit Display:**
    - Kh√¥ng hi·ªÉn th·ªã progress: used/limit
    - VD: "15/100 l∆∞·ª£t ƒë√£ d√πng"

### KeyboardAvoidingView
11. **Behavior:**
    - iOS: `"padding"`
    - Android: `"height"`

### UsedBy Section Style
12. **Card Style:**
    - Background: #fff
    - borderRadius: 12
    - borderWidth: 1, borderColor: #F0F0F0
    - padding: 15

13. **User Item:**
    - flexDirection: row
    - Avatar 35x35, borderRadius 18
    - marginRight: 12
    - gap: 12 between items

## üéØ USE CASES

### 1. Freeship Code
```js
{
  code: "FREESHIP02",
  value: 10,           // Gi·∫£m 10% ph√≠ ship
  limit: 100,
  maxPerUser: 1,
  durationDays: 30,
  enable: true,
  used: 25,
  usedBy: [1, 5, 10, ...],
  created: "2026-01-01T00:00:00.000Z"
}
// Expiry: 2026-01-31
// C√≤n: 75 l∆∞·ª£t (100 - 25)
```

### 2. New User Welcome
```js
{
  code: "WELCOME",
  value: 20,           // Gi·∫£m 20% ƒë∆°n ƒë·∫ßu
  limit: 1000,
  maxPerUser: 1,       // Ch·ªâ d√πng 1 l·∫ßn/user
  durationDays: 365,   // Hi·ªáu l·ª±c 1 nƒÉm
  enable: true,
  used: 150,
  usedBy: [1, 2, 3, ...],
  created: "2026-01-01T00:00:00.000Z"
}
```

### 3. Flash Sale
```js
{
  code: "FLASH50",
  value: 50,           // Gi·∫£m 50%
  limit: 50,           // Gi·ªõi h·∫°n 50 l∆∞·ª£t
  maxPerUser: 1,
  durationDays: 1,     // Ch·ªâ 1 ng√†y
  enable: true,
  used: 50,            // H·∫øt l∆∞·ª£t
  usedBy: [1, 2, 3, ...],
  created: "2026-01-27T00:00:00.000Z"
}
// Expiry: 2026-01-28
// Status: H·∫øt l∆∞·ª£t (used >= limit)
```

### 4. VIP Member Code
```js
{
  code: "VIP100",
  value: 15,
  limit: 999999,       // Kh√¥ng gi·ªõi h·∫°n
  maxPerUser: 999999,  // D√πng kh√¥ng gi·ªõi h·∫°n
  durationDays: 365,
  enable: true,
  used: 5000,
  usedBy: [1, 5, 10, ...], // Nhi·ªÅu users tr√πng
  created: "2026-01-01T00:00:00.000Z"
}
```

## üîç PROMO CHECK LOGIC (Backend)

### Apply Promo Flow
```js
const applyPromo = async (code, userId, totalPrice) => {
  // 1. Find promo
  const promo = await getDoc(doc(db, 'promos', code));
  if (!promo.exists()) return { error: "M√£ kh√¥ng t·ªìn t·∫°i" };
  
  // 2. Check enable
  if (!promo.enable) return { error: "M√£ ƒë√£ b·ªã v√¥ hi·ªáu h√≥a" };
  
  // 3. Check expiry
  const created = new Date(promo.created);
  const expiry = new Date(created.getTime() + promo.durationDays * 24 * 60 * 60 * 1000);
  if (Date.now() > expiry.getTime()) return { error: "M√£ ƒë√£ h·∫øt h·∫°n" };
  
  // 4. Check limit
  if (promo.used >= promo.limit) return { error: "M√£ ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng" };
  
  // 5. Check maxPerUser
  const userUsageCount = promo.usedBy.filter(id => id === userId).length;
  if (userUsageCount >= promo.maxPerUser) return { error: "B·∫°n ƒë√£ s·ª≠ d·ª•ng m√£ n√†y" };
  
  // 6. Calculate discount
  const discount = totalPrice * (promo.value / 100);
  
  // 7. Update promo (increment used, add userId to usedBy)
  await updateDoc(promoRef, {
    used: increment(1),
    usedBy: arrayUnion(userId)
  });
  
  return { discount };
};
```

## üö® EDGE CASES

1. **UsedBy Array Duplicate:**
   - User d√πng m√£ nhi·ªÅu l·∫ßn ‚Üí usedBy c√≥ nhi·ªÅu userId gi·ªëng nhau
   - VD: usedBy = [1, 1, 1, 5, 5, 10]
   - Display: Hi·ªÉn th·ªã unique users (filter duplicate)

2. **User Deleted:**
   - userId trong usedBy nh∆∞ng user ƒë√£ b·ªã x√≥a
   - `getUserInfo(userId)` ‚Üí undefined
   - Fallback: "User ID: [userId]"

3. **Empty UsedBy:**
   - M√£ m·ªõi t·∫°o, ch∆∞a ai d√πng
   - usedBy = [] (empty array)
   - Display: "Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o s·ª≠ d·ª•ng m√£ n√†y."

4. **Large UsedBy:**
   - M√£ popular, usedBy = 10000 users
   - Performance: Render 10000 user items ‚Üí Slow
   - Solution: Pagination ho·∫∑c limit display (VD: ch·ªâ show 50 ƒë·∫ßu)

5. **Code Duplicate:**
   - Admin t·∫°o 2 m√£ c√πng code "FREESHIP02"
   - Firestore: Different document IDs
   - Problem: User apply m√£ ‚Üí L·∫•y m√£ n√†o?
   - Solution: Validate code unique khi save

6. **Value > 100:**
   - Admin nh·∫≠p value = 150%
   - Discount > totalPrice ‚Üí User ƒë∆∞·ª£c tr·∫£ ti·ªÅn?
   - Solution: Validate 0 < value <= 100

7. **Negative Value:**
   - Admin nh·∫≠p value = -10
   - TƒÉng gi√° thay v√¨ gi·∫£m?
   - Solution: Validate value > 0

8. **DurationDays = 0:**
   - M√£ h·∫øt h·∫°n ngay khi t·∫°o
   - Valid use case? (c√≥ th·ªÉ d√πng ƒë·ªÉ test)

## üìù SUGGESTED IMPROVEMENTS

### 1. Expiry Display
```js
const expiryDate = new Date(
  new Date(formData.created).getTime() + 
  Number(formData.durationDays) * 24 * 60 * 60 * 1000
);

<Text>H·∫øt h·∫°n: {expiryDate.toLocaleDateString('vi-VN')}</Text>
```

### 2. Progress Bar
```js
<View style={styles.progressContainer}>
  <Text>{formData.used} / {formData.limit} l∆∞·ª£t ƒë√£ d√πng</Text>
  <View style={styles.progressBar}>
    <View style={[styles.progressFill, { 
      width: `${(formData.used / formData.limit) * 100}%` 
    }]} />
  </View>
</View>
```

### 3. Unique Users Count
```js
const uniqueUsers = [...new Set(formData.usedBy)];
<Text>Ng∆∞·ªùi d√πng unique: {uniqueUsers.length}</Text>
```

### 4. Code Validation
```js
const handleSave = async () => {
  // Check duplicate code
  const existing = promos.find(p => 
    p.code === formData.code.toUpperCase() && p.id !== id
  );
  if (existing) {
    Alert.alert("L·ªói", "M√£ n√†y ƒë√£ t·ªìn t·∫°i");
    return;
  }
  
  // ... rest of save logic
};
```

### 5. Value Range Validation
```js
const value = Number(formData.value);
if (value <= 0 || value > 100) {
  Alert.alert("L·ªói", "Gi√° tr·ªã gi·∫£m ph·∫£i t·ª´ 1-100%");
  return;
}
```

### 6. MaxPerUser <= Limit
```js
const maxPerUser = Number(formData.maxPerUser);
const limit = Number(formData.limit);
if (maxPerUser > limit) {
  Alert.alert("L·ªói", "L∆∞·ª£t d√πng/ng∆∞·ªùi kh√¥ng th·ªÉ l·ªõn h∆°n t·ªïng l∆∞·ª£t");
  return;
}
```

### 7. UsedBy Pagination
```js
const [showAllUsers, setShowAllUsers] = useState(false);
const displayUsers = showAllUsers 
  ? formData.usedBy 
  : formData.usedBy.slice(0, 10);

<TouchableOpacity onPress={() => setShowAllUsers(!showAllUsers)}>
  <Text>{showAllUsers ? 'Thu g·ªçn' : `Xem t·∫•t c·∫£ (${formData.usedBy.length})`}</Text>
</TouchableOpacity>
```
