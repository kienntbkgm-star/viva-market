# TÃ“M Táº®T LOGIC TRANG ADMIN/FINANCE.TSX

## ğŸ¯ Má»¤C ÄÃCH
Quáº£n lÃ½ tÃ i chÃ­nh shipper - Xem cÃ´ng ná»£:
- Hiá»ƒn thá»‹ danh sÃ¡ch táº¥t cáº£ shipper
- TÃ­nh toÃ¡n sá»‘ dÆ° cÃ´ng ná»£ tá»« transactions
- Hiá»ƒn thá»‹ shipper ná»£ Admin (sá»‘ dÆ°Æ¡ng, mÃ u cam)
- Hiá»ƒn thá»‹ Admin ná»£ shipper (sá»‘ Ã¢m, mÃ u xanh)
- Navigate Ä‘áº¿n shipper-detail-finance Ä‘á»ƒ xem chi tiáº¿t

## ğŸ“Š STATE & DATA

**Store:**
- `users`: Danh sÃ¡ch ngÆ°á»i dÃ¹ng (filter role='shipper')

**Local State:**
- `allTransactions`: Danh sÃ¡ch giao dá»‹ch tá»« Firestore realtime

**Realtime Listener:**
- Query toÃ n bá»™ collection `transactions`
- onSnapshot Ä‘á»ƒ update real-time

## ğŸ”„ LUá»’NG THá»°C THI

### Load Data
1. Filter users â†’ Láº¥y chá»‰ `role === 'shipper'`
2. Query Firestore `transactions` collection
3. Setup realtime listener vá»›i `onSnapshot`
4. Má»—i láº§n cÃ³ transaction má»›i â†’ Update state

### Calculate Debt
```js
const rawDebt = allTransactions
  .filter(t => t.userId === shipperId)
  .reduce((sum, t) => sum + (t.amount || 0), 0);
```

Logic hiá»ƒn thá»‹:
- `rawDebt > 0` â†’ Shipper ná»£ Admin (mÃ u #E67E22 cam, dáº¥u +)
- `rawDebt < 0` â†’ Admin ná»£ shipper (mÃ u #27AE60 xanh, dáº¥u -)
- `rawDebt = 0` â†’ KhÃ´ng ná»£ (mÃ u xanh, 0Ä‘)

### Navigate Detail
1. Nháº¥n shipper card
2. Navigate to `/admin/shipper-detail-finance`
3. Pass params: `{ shipperId, name }`

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### Realtime Listener
```js
useEffect(() => {
  const q = query(collection(db, 'transactions'));
  const unsubscribe = onSnapshot(q, (snapshot) => {
    setAllTransactions(snapshot.docs.map(doc => doc.data()));
  });
  return () => unsubscribe();
}, []);
```

### Calculate Shipper List
```js
const shippers = users.filter(u => u.role === 'shipper').map(s => {
  const rawDebt = allTransactions
    .filter(t => t.userId === s.id)
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  return { ...s, currentDebt: rawDebt };
});
```

### Render Logic
```js
<Text style={[styles.money, { color: item.currentDebt >= 0 ? '#E67E22' : '#27AE60' }]}>
  {item.currentDebt > 0 ? '+' : ''}{(item.currentDebt * 1000).toLocaleString()}Ä‘
</Text>
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button
  â”‚   â”œâ”€ Title: "TÃ i chÃ­nh Shipper"
  â”‚   â””â”€ Spacer (width: 28)
  â”‚
  â””â”€ FlatList (Shipper Cards)
      â””â”€ renderShipper: Card
          â”œâ”€ Avatar (chá»¯ cÃ¡i Ä‘áº§u)
          â”œâ”€ Info
          â”‚   â”œâ”€ Name
          â”‚   â””â”€ Phone
          â””â”€ Right
              â”œâ”€ Money (mÃ u theo dÆ°Æ¡ng/Ã¢m)
              â””â”€ Chevron forward
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

1. **Realtime Update:** DÃ¹ng `onSnapshot` Ä‘á»ƒ auto update khi cÃ³ transaction má»›i
2. **Debt Logic:** 
   - `DEBT` type: amount dÆ°Æ¡ng (shipper ná»£ admin)
   - `PAYMENT` type: amount Ã¢m (admin ná»™p cho shipper)
   - Sum táº¥t cáº£ = sá»‘ dÆ° hiá»‡n táº¡i
3. **Color Coding:**
   - DÆ°Æ¡ng (>=0): #E67E22 (cam) - "Shipper ná»£ Admin"
   - Ã‚m (<0): #27AE60 (xanh) - "Admin ná»£ shipper"
4. **Plus Sign:** Hiá»ƒn thá»‹ `+` náº¿u sá»‘ dÆ°Æ¡ng
5. **Empty State:** "KhÃ´ng cÃ³ shipper nÃ o" náº¿u list rá»—ng
6. **Avatar:** Chá»¯ cÃ¡i Ä‘áº§u tÃªn, background primary
7. **Card Style:** elevation 2, borderRadius 15
8. **Money Display:** `(debt * 1000).toLocaleString() + 'Ä‘'`
9. **Navigate Params:** Pass cáº£ id vÃ  name Ä‘á»ƒ dá»… hiá»ƒn thá»‹
10. **Listener Cleanup:** Return unsubscribe trong useEffect

## ğŸš€ USER JOURNEY

**Admin:**
1. VÃ o Admin Finance tá»« dashboard
2. Xem danh sÃ¡ch shipper vá»›i sá»‘ dÆ° cÃ´ng ná»£
3. Nháº­n biáº¿t shipper nÃ o ná»£ (cam) hoáº·c Ä‘Æ°á»£c ná»£ (xanh)
4. Nháº¥n vÃ o shipper â†’ Xem chi tiáº¿t giao dá»‹ch
5. Trong detail page cÃ³ thá»ƒ thÃªm transaction má»›i (ná»™p tiá»n/bÃ¹ tiá»n)

## ğŸ”— NAVIGATION

**Navigates TO:**
- `/admin/shipper-detail-finance` (params: shipperId, name)

**Navigates FROM:**
- Admin dashboard menu "Quáº£n lÃ½ TÃ i chÃ­nh"

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

1. **Transaction Structure:**
   ```js
   {
     userId: shipperId,
     type: 'DEBT' | 'PAYMENT',
     amount: number (dÆ°Æ¡ng/Ã¢m),
     orderId: string,
     desc: string,
     createdAt: ISO string,
     performedBy: 'system' | 'admin'
   }
   ```
2. **Query All Transactions:** KhÃ´ng filter userId (cáº§n táº¥t cáº£ Ä‘á»ƒ tÃ­nh sum)
3. **Filter Per Shipper:** `.filter(t => t.userId === shipperId)`
4. **Reduce Sum:**
   ```js
   .reduce((sum, t) => sum + (t.amount || 0), 0)
   ```
5. **rawDebt Unit:** NghÃ¬n Ä‘á»“ng (k), nhÃ¢n 1000 khi display
6. **Fallback amount:** `|| 0` náº¿u transaction thiáº¿u amount
7. **Avatar Text:** `item.name ? item.name[0] : 'S'` (fallback 'S' náº¿u thiáº¿u name)
8. **FlatList keyExtractor:** `item.id.toString()`
9. **contentContainerStyle:** padding 15
10. **Empty Component:** Text vá»›i textAlign center, color #999
11. **Realtime Dependency:** `[]` (chá»‰ setup 1 láº§n)
12. **Snapshot Map:** `snapshot.docs.map(doc => doc.data())`
13. **Color Threshold:** `>= 0` (not just `>`) Ä‘á»ƒ 0 cÅ©ng mÃ u cam
14. **Plus Sign Logic:** `item.currentDebt > 0 ? '+' : ''` (0 khÃ´ng cÃ³ dáº¥u +)
15. **Phone Display:** fontSize 12, color #999

## ğŸ” TRANSACTION TYPES

### DEBT (Ná»£)
- **Khi nÃ o:** Shipper giao Ä‘Æ¡n COD xong
- **amount:** DÆ°Æ¡ng (VD: +5k)
- **NghÄ©a:** Shipper ná»£ admin sá»‘ tiá»n nÃ y
- **Táº¡o bá»Ÿi:** system (auto khi complete order)

### PAYMENT (Ná»™p tiá»n)
- **Khi nÃ o:** Admin ghi nháº­n shipper Ä‘Ã£ ná»™p tiá»n
- **amount:** Ã‚m (VD: -100k)
- **NghÄ©a:** Shipper Ä‘Ã£ tráº£ ná»£ cho admin
- **Táº¡o bá»Ÿi:** admin (manual trong detail page)

### REFUND (BÃ¹ tiá»n)
- **Khi nÃ o:** Admin bÃ¹ tiá»n cho shipper (discount lá»›n hÆ¡n adminShare)
- **amount:** Ã‚m (VD: -2k)
- **NghÄ©a:** Admin ná»£ shipper
- **Táº¡o bá»Ÿi:** system (auto khi discount > adminShare)

## ğŸ’° VÃ Dá»¤ TÃNH TOÃN

**Shipper A:**
- Transaction 1: +15k (DEBT - giao Ä‘Æ¡n 1)
- Transaction 2: +8k (DEBT - giao Ä‘Æ¡n 2)
- Transaction 3: -20k (PAYMENT - ná»™p tiá»n)
- Transaction 4: +5k (DEBT - giao Ä‘Æ¡n 3)
- **Tá»•ng:** 15 + 8 - 20 + 5 = **+8k**
- **Hiá»ƒn thá»‹:** "+8,000Ä‘" mÃ u cam (Shipper ná»£ Admin)

**Shipper B:**
- Transaction 1: +10k (DEBT)
- Transaction 2: -2k (REFUND - admin bÃ¹)
- Transaction 3: -15k (PAYMENT - ná»™p tiá»n)
- **Tá»•ng:** 10 - 2 - 15 = **-7k**
- **Hiá»ƒn thá»‹:** "-7,000Ä‘" mÃ u xanh (Admin ná»£ shipper)
