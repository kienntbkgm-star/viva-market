# TÃ“M Táº®T LOGIC TRANG ADMIN/ACTIVITY-TRACKING.TSX

## ğŸ¯ Má»¤C ÄÃCH
Dashboard phÃ¢n tÃ­ch hoáº¡t Ä‘á»™ng chi tiáº¿t:
- **Tab Shippers:** Theo dÃµi shipper online, ready, hiá»‡u suáº¥t, giá» lÃ m viá»‡c, crash detection
- **Tab All Users:** Thá»‘ng kÃª ngÆ°á»i dÃ¹ng online, session, thá»i gian hoáº¡t Ä‘á»™ng, Ä‘iá»ƒm Ä‘Ã¡nh giÃ¡
- Lá»c theo thá»i gian: HÃ´m nay, HÃ´m qua, Tuáº§n nÃ y, ThÃ¡ng nÃ y
- Cáº£nh bÃ¡o shipper ready nhÆ°ng offline
- PhÃ¡t hiá»‡n crash (shipper máº¥t tÃ­ch giá»¯a chá»«ng)

## ğŸ“Š STATE & DATA

**Store:**
- `users`: Táº¥t cáº£ ngÆ°á»i dÃ¹ng (filter theo role)
- `allOrders`: Táº¥t cáº£ Ä‘Æ¡n hÃ ng (lá»c theo date range)

**Local State:**
- `selectedTab`: 'shippers' | 'allUsers'
- `selectedDateRange`: 'today' | 'yesterday' | 'week' | 'month'
- `onlineLog`: Realtime log hoáº¡t Ä‘á»™ng tá»« Firestore

**Realtime Listener:**
- Query `onlineLog` collection vá»›i `onSnapshot`

## ğŸ”„ LUá»’NG THá»°C THI

### 1. Setup Realtime Listener
```js
useEffect(() => {
  const q = query(collection(db, 'onlineLog'));
  const unsubscribe = onSnapshot(q, (snapshot) => {
    setOnlineLog(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
  });
  return () => unsubscribe();
}, []);
```

### 2. Calculate Date Range
```js
const { startTime, endTime } = useMemo(() => {
  const now = new Date();
  let start: Date;
  
  switch(selectedDateRange) {
    case 'today':
      start = new Date(now.setHours(0, 0, 0, 0));
      break;
    case 'yesterday':
      start = new Date(now.setDate(now.getDate() - 1));
      start.setHours(0, 0, 0, 0);
      break;
    case 'week':
      start = new Date(now.setDate(now.getDate() - 7));
      break;
    case 'month':
      start = new Date(now.setDate(now.getDate() - 30));
      break;
  }
  
  return {
    startTime: start.getTime(),
    endTime: selectedDateRange === 'yesterday' 
      ? start.getTime() + 24*60*60*1000 
      : Date.now()
  };
}, [selectedDateRange]);
```

### 3. Filter Orders by Date
```js
const filteredOrders = allOrders.filter(order => {
  const orderTime = new Date(order.createdAt).getTime();
  return orderTime >= startTime && orderTime < endTime;
});
```

### 4. Calculate Shipper Stats
```js
const shipperStats = useMemo(() => {
  const shippers = users.filter(u => u.role === 'shipper');
  
  return shippers.map(shipper => {
    // 1. TÃ­nh Online Status (< 5 phÃºt)
    const lastLog = onlineLog.find(log => log.userId === shipper.id);
    const isOnline = lastLog && (Date.now() - lastLog.lastOnline < 5 * 60 * 1000);
    
    // 2. Parse Log Entries
    const logs = lastLog?.log || [];
    const sessions = logs.map(entry => {
      const [timestamp, duration] = entry.split('-').map(Number);
      return { timestamp, duration: duration || 0 };
    });
    
    // 3. Filter Sessions by Date Range
    const relevantSessions = sessions.filter(s => 
      s.timestamp >= startTime && s.timestamp < endTime
    );
    
    // 4. TÃ­nh Total Hours
    const totalMinutes = relevantSessions.reduce((sum, s) => sum + s.duration, 0);
    const totalHours = totalMinutes / 60;
    
    // 5. Äáº¿m Orders
    const ordersDelivered = filteredOrders.filter(o => 
      o.shipperId === shipper.id && o.status === 'completed'
    ).length;
    
    // 6. TÃ­nh Efficiency
    const efficiency = totalHours > 0 ? ordersDelivered / totalHours : 0;
    
    // 7. Crash Detection
    const hasCrash = relevantSessions.some(s => s.duration === 0);
    
    return {
      id: shipper.id,
      name: shipper.name,
      isReady: shipper.isReady,
      isOnline,
      totalHours: totalHours.toFixed(1),
      ordersDelivered,
      efficiency: efficiency.toFixed(2),
      hasCrash,
      lastOnline: lastLog?.lastOnline
    };
  });
}, [users, onlineLog, filteredOrders, startTime, endTime]);
```

### 5. Calculate User Stats
```js
const userStats = useMemo(() => {
  const allUsers = users.filter(u => u.role !== 'shipper');
  
  return allUsers.map(user => {
    const lastLog = onlineLog.find(log => log.userId === user.id);
    const isOnline = lastLog && (Date.now() - lastLog.lastOnline < 5 * 60 * 1000);
    
    const logs = lastLog?.log || [];
    const sessions = logs.map(entry => {
      const [timestamp, duration] = entry.split('-').map(Number);
      return { timestamp, duration: duration || 0 };
    }).filter(s => s.timestamp >= startTime && s.timestamp < endTime);
    
    const totalMinutes = sessions.reduce((sum, s) => sum + s.duration, 0);
    const totalHours = totalMinutes / 60;
    const avgSessionDuration = sessions.length > 0 
      ? totalMinutes / sessions.length 
      : 0;
    
    // Activity Score (0-100)
    const score = Math.min(100, Math.round((totalHours / 24) * 100));
    
    return {
      id: user.id,
      name: user.name,
      role: user.role,
      isOnline,
      sessions: sessions.length,
      totalHours: totalHours.toFixed(1),
      avgSessionDuration: avgSessionDuration.toFixed(0),
      score
    };
  });
}, [users, onlineLog, startTime, endTime]);
```

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### parseLogEntry
```js
// Log format: "timestamp-duration"
// VD: "1704124800000-45" = Logged at timestamp, stayed 45 minutes
const [timestamp, duration] = entry.split('-').map(Number);
return {
  timestamp,        // Thá»i Ä‘iá»ƒm báº¯t Ä‘áº§u session
  duration: duration || 0  // Thá»i lÆ°á»£ng (phÃºt), 0 = crash
};
```

### isOnline Detection
```js
const isOnline = (lastOnlineTimestamp) => {
  const TIMEOUT = 5 * 60 * 1000; // 5 minutes
  return Date.now() - lastOnlineTimestamp < TIMEOUT;
};
```

### Crash Detection
```js
// Duration = 0 nghÄ©a lÃ  app crash (khÃ´ng logout bÃ¬nh thÆ°á»ng)
const hasCrash = sessions.some(s => s.duration === 0);
```

### Activity Score Calculation
```js
// 0-100 dá»±a trÃªn tá»•ng giá» hoáº¡t Ä‘á»™ng / 24h
const score = Math.min(100, Math.round((totalHours / 24) * 100));
```

### Efficiency Calculation
```js
// Orders per hour
const efficiency = totalHours > 0 ? ordersDelivered / totalHours : 0;
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ Header
  â”‚   â”œâ”€ Back Button
  â”‚   â””â”€ Title: "Activity Tracking"
  â”‚
  â”œâ”€ Date Range Selector (Row of 4 buttons)
  â”‚   â”œâ”€ Today
  â”‚   â”œâ”€ Yesterday
  â”‚   â”œâ”€ Week
  â”‚   â””â”€ Month
  â”‚
  â”œâ”€ Tab Selector (SegmentedControl style)
  â”‚   â”œâ”€ Shippers
  â”‚   â””â”€ All Users
  â”‚
  â””â”€ ScrollView
      â”œâ”€ [IF selectedTab === 'shippers']
      â”‚   â”œâ”€ Summary Cards (Row)
      â”‚   â”‚   â”œâ”€ Ready & Online Count
      â”‚   â”‚   â”œâ”€ Total Orders
      â”‚   â”‚   â””â”€ Avg Hours
      â”‚   â”‚
      â”‚   â”œâ”€ Warning Cards (náº¿u cÃ³)
      â”‚   â”‚   â”œâ”€ Offline but Ready (cam)
      â”‚   â”‚   â””â”€ Crash Detected (Ä‘á»)
      â”‚   â”‚
      â”‚   â””â”€ Shipper List (Cards)
      â”‚       â””â”€ renderShipper: Card
      â”‚           â”œâ”€ Avatar + Online dot
      â”‚           â”œâ”€ Info
      â”‚           â”‚   â”œâ”€ Name + Ready badge
      â”‚           â”‚   â”œâ”€ Hours worked
      â”‚           â”‚   â”œâ”€ Orders delivered
      â”‚           â”‚   â””â”€ Efficiency
      â”‚           â””â”€ Crash icon (náº¿u cÃ³)
      â”‚
      â””â”€ [IF selectedTab === 'allUsers']
          â”œâ”€ Summary Cards
          â”‚   â”œâ”€ Online Count
          â”‚   â”œâ”€ Total Sessions
          â”‚   â””â”€ Avg Session Duration
          â”‚
          â””â”€ User List (Cards)
              â””â”€ renderUser: Card
                  â”œâ”€ Avatar + Online dot
                  â”œâ”€ Info
                  â”‚   â”œâ”€ Name + Role badge
                  â”‚   â”œâ”€ Sessions count
                  â”‚   â”œâ”€ Total hours
                  â”‚   â””â”€ Avg duration
                  â””â”€ Score Progress Bar
                      â””â”€ Score number (0-100)
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

### Shipper Tab
1. **Ready & Online Logic:**
   - isReady = true (shipper báº­t sáºµn sÃ ng)
   - isOnline = lastOnline < 5 phÃºt
   - LÃ½ tÆ°á»Ÿng: Ready + Online
   - Cáº£nh bÃ¡o: Ready nhÆ°ng Offline (táº¯t app/máº¥t máº¡ng)

2. **Crash Detection:**
   - Log entry vá»›i `duration = 0` = crash
   - Hiá»ƒn thá»‹ icon âš ï¸ mÃ u Ä‘á»
   - Warning card: "X shipper gáº·p sá»± cá»‘"

3. **Efficiency Metric:**
   - Orders / Hours
   - VD: 10 Ä‘Æ¡n / 5 giá» = 2.00 Ä‘Æ¡n/giá»
   - MÃ u xanh náº¿u >= 1.5

4. **Ready Badge:**
   - Background #4CAF50 náº¿u isReady
   - Text "Ready"
   - fontSize 10

### All Users Tab
5. **Session Tracking:**
   - Má»—i láº§n vÃ o app = 1 session
   - TÃ­nh avg duration per session
   - Hiá»ƒn thá»‹ sá»‘ sessions trong date range

6. **Activity Score:**
   - 0-100 dá»±a trÃªn totalHours / 24h * 100
   - Progress bar mÃ u gradient
   - Text mÃ u dá»±a trÃªn Ä‘iá»ƒm:
     - >= 80: #4CAF50 (xanh)
     - >= 50: #FFA726 (cam)
     - < 50: #EF5350 (Ä‘á»)

7. **Role Badge:**
   - admin: #E91E63 (há»“ng)
   - shop: #9C27B0 (tÃ­m)
   - user: #2196F3 (xanh dÆ°Æ¡ng)

### General
8. **Online Dot:**
   - MÃ u xanh (#4CAF50) náº¿u online
   - MÃ u xÃ¡m (#BDBDBD) náº¿u offline
   - Position absolute, top: 0, right: 0

9. **Date Range Logic:**
   - Today: 0h Ä‘áº¿n now
   - Yesterday: 0h hÃ´m qua Ä‘áº¿n 0h hÃ´m nay
   - Week: 7 ngÃ y trÆ°á»›c Ä‘áº¿n now
   - Month: 30 ngÃ y trÆ°á»›c Ä‘áº¿n now

10. **Realtime Update:**
    - onlineLog listener auto update
    - isOnline recalculate má»—i 1s? (khÃ´ng cÃ³ interval, chá»‰ re-render khi onlineLog change)

11. **Empty State:**
    - "KhÃ´ng cÃ³ shipper nÃ o" / "KhÃ´ng cÃ³ ngÆ°á»i dÃ¹ng nÃ o"
    - textAlign center, color #999

12. **Summary Cards:**
    - Background #F5F5F5
    - borderRadius 10
    - padding 15
    - elevation 1

13. **Warning Cards:**
    - Background #FFF3E0 (cam nháº¡t) cho offline-ready
    - Background #FFEBEE (Ä‘á» nháº¡t) cho crash
    - borderLeft 4px solid color chá»§ Ä‘áº¡o

14. **useMemo Dependencies:**
    - shipperStats: [users, onlineLog, filteredOrders, startTime, endTime]
    - userStats: [users, onlineLog, startTime, endTime]
    - Optimize Ä‘á»ƒ khÃ´ng recalc khi khÃ´ng cáº§n

15. **Avatar Fallback:**
    - Chá»¯ cÃ¡i Ä‘áº§u name
    - Background primary
    - Circular vá»›i borderRadius 25

## ğŸš€ USER JOURNEY

### Admin - Shipper Tracking
1. VÃ o Activity Tracking tá»« admin dashboard
2. Chá»n date range (Today/Yesterday/Week/Month)
3. Tab "Shippers" Ä‘Æ°á»£c chá»n máº·c Ä‘á»‹nh
4. Xem summary: Bao nhiÃªu ready+online, tá»•ng orders, avg hours
5. Xem warning cards (náº¿u cÃ³):
   - Shipper ready nhÆ°ng offline â†’ Cáº§n liÃªn há»‡
   - Shipper crash â†’ Cáº§n kiá»ƒm tra lá»—i app
6. Scroll danh sÃ¡ch shipper:
   - Xem tá»«ng shipper: giá» lÃ m, orders, efficiency
   - Nháº­n biáº¿t crash (icon âš ï¸ Ä‘á»)
7. ÄÃ¡nh giÃ¡ hiá»‡u suáº¥t shipper dá»±a trÃªn efficiency

### Admin - User Tracking
1. Switch sang tab "All Users"
2. Xem summary: Sá»‘ users online, tá»•ng sessions, avg duration
3. Scroll danh sÃ¡ch users:
   - Xem ai online (dot xanh)
   - Xem role badge
   - Xem activity score (progress bar)
4. ÄÃ¡nh giÃ¡ engagement cá»§a users:
   - Score cao = active user
   - Score tháº¥p = inactive user

## ğŸ”— NAVIGATION

**Navigates TO:** KhÃ´ng (read-only dashboard)

**Navigates FROM:**
- Admin dashboard menu "Activity Tracking"

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

### OnlineLog Structure
```js
{
  id: string,           // Document ID (userId)
  userId: string,       // User ID (duplicate)
  lastOnline: number,   // Timestamp cuá»‘i cÃ¹ng online
  log: string[],        // Array of "timestamp-duration"
}
```

### Log Entry Format
```
"1704124800000-45"
  â”œâ”€ 1704124800000: Timestamp báº¯t Ä‘áº§u session (ms)
  â””â”€ 45: Duration (minutes)

"1704128400000-0"
  â”œâ”€ 1704128400000: Timestamp crash
  â””â”€ 0: Duration = 0 (app bá»‹ crash, khÃ´ng logout bÃ¬nh thÆ°á»ng)
```

### Online Detection Algorithm
```js
const ONLINE_TIMEOUT = 5 * 60 * 1000; // 5 minutes
const isOnline = (lastOnlineTimestamp) => {
  return Date.now() - lastOnlineTimestamp < ONLINE_TIMEOUT;
};
```

Logic:
- Má»—i khi app active â†’ Update `lastOnline`
- Náº¿u `Date.now() - lastOnline < 5 phÃºt` â†’ Online
- Náº¿u `>= 5 phÃºt` â†’ Offline

### Crash Detection Logic
```js
// Duration = 0 nghÄ©a lÃ :
// 1. App bá»‹ crash/force close
// 2. Máº¥t máº¡ng Ä‘á»™t ngá»™t
// 3. Device táº¯t nguá»“n
// â†’ KhÃ´ng ká»‹p gá»i logout API Ä‘á»ƒ ghi duration

const hasCrash = sessions.some(session => session.duration === 0);
```

### Date Range Edge Cases
1. **Yesterday:**
   - startTime: yesterday 0h
   - endTime: today 0h
   - KhÃ´ng bao gá»“m today data

2. **Today:**
   - startTime: today 0h
   - endTime: Date.now()
   - Bao gá»“m cáº£ data Ä‘ang cháº¡y

3. **Week/Month:**
   - startTime: now - 7/30 days
   - endTime: now
   - Rolling window (khÃ´ng theo tuáº§n lá»‹ch)

### Performance Optimization
1. **useMemo for Stats:**
   - Chá»‰ recalc khi dependencies thay Ä‘á»•i
   - TrÃ¡nh recalc má»—i láº§n render

2. **Filter Early:**
   - Filter orders by date trÆ°á»›c
   - Giáº£m sá»‘ láº§n loop trong map

3. **Realtime Listener:**
   - Chá»‰ setup 1 láº§n trong useEffect
   - Cleanup báº±ng unsubscribe

### Efficiency Thresholds
```js
// Efficiency = orders / hours
const getEfficiencyColor = (efficiency) => {
  if (efficiency >= 2.0) return '#4CAF50';  // Xuáº¥t sáº¯c
  if (efficiency >= 1.5) return '#FFA726';  // Tá»‘t
  if (efficiency >= 1.0) return '#FF9800';  // Trung bÃ¬nh
  return '#EF5350';                          // Cáº§n cáº£i thiá»‡n
};
```

### Score Calculation
```js
// Activity Score for All Users
const calculateScore = (totalHours) => {
  // Max 24h trong 1 ngÃ y = 100 Ä‘iá»ƒm
  const score = (totalHours / 24) * 100;
  return Math.min(100, Math.round(score));
};
```

### Role Color Map
```js
const roleColors = {
  admin: '#E91E63',    // Pink
  shop: '#9C27B0',     // Purple
  shipper: '#FF9800',  // Orange (nhÆ°ng tab riÃªng)
  user: '#2196F3',     // Blue
};
```

### Warning Thresholds
1. **Offline but Ready:**
   - `isReady === true && isOnline === false`
   - Shipper bÃ¡o sáºµn sÃ ng nhÆ°ng app offline
   - CÃ³ thá»ƒ do: táº¯t app, máº¥t máº¡ng, crash

2. **Crash Detected:**
   - `hasCrash === true`
   - Ãt nháº¥t 1 session cÃ³ duration = 0
   - Cáº§n Ä‘iá»u tra lá»—i app

### Summary Card Calculations
```js
// Shippers Tab
const readyAndOnlineCount = shipperStats.filter(s => s.isReady && s.isOnline).length;
const totalOrders = shipperStats.reduce((sum, s) => sum + s.ordersDelivered, 0);
const avgHours = (shipperStats.reduce((sum, s) => sum + parseFloat(s.totalHours), 0) / shipperStats.length).toFixed(1);

// All Users Tab
const onlineCount = userStats.filter(u => u.isOnline).length;
const totalSessions = userStats.reduce((sum, u) => sum + u.sessions, 0);
const avgSessionDuration = (userStats.reduce((sum, u) => sum + parseFloat(u.avgSessionDuration), 0) / userStats.length).toFixed(0);
```

## ğŸ“Š METRIC DEFINITIONS

### Shipper Metrics
| Metric | Formula | Ã nghÄ©a |
|--------|---------|---------|
| **Total Hours** | Î£(duration) / 60 | Tá»•ng giá» lÃ m viá»‡c trong date range |
| **Orders Delivered** | Count(orders where status='completed' && shipperId=X) | Sá»‘ Ä‘Æ¡n giao thÃ nh cÃ´ng |
| **Efficiency** | Orders Delivered / Total Hours | ÄÆ¡n/giá», Ä‘Ã¡nh giÃ¡ hiá»‡u suáº¥t |
| **Crash Count** | Count(sessions where duration=0) | Sá»‘ láº§n crash trong date range |
| **Ready & Online** | isReady=true && isOnline=true | Shipper sáºµn sÃ ng vÃ  Ä‘ang online |

### User Metrics
| Metric | Formula | Ã nghÄ©a |
|--------|---------|---------|
| **Sessions** | Count(log entries in date range) | Sá»‘ láº§n vÃ o app |
| **Total Hours** | Î£(duration) / 60 | Tá»•ng giá» sá»­ dá»¥ng app |
| **Avg Session Duration** | Total Hours / Sessions | Thá»i gian trung bÃ¬nh má»—i session |
| **Activity Score** | (Total Hours / 24) * 100 | Äiá»ƒm hoáº¡t Ä‘á»™ng (0-100) |
| **Online Status** | lastOnline < 5min | Äang online hay khÃ´ng |

## ğŸ¯ USE CASES

### 1. PhÃ¡t hiá»‡n Shipper khÃ´ng hoáº¡t Ä‘á»™ng
- Shipper isReady=true nhÆ°ng isOnline=false
- Admin liÃªn há»‡ kiá»ƒm tra

### 2. ÄÃ¡nh giÃ¡ Hiá»‡u suáº¥t Shipper
- Efficiency cao (>= 2.0) â†’ Shipper giá»i
- Efficiency tháº¥p (< 1.0) â†’ Cáº§n training

### 3. PhÃ¡t hiá»‡n Crash App
- hasCrash=true â†’ Dev team Ä‘iá»u tra lá»—i
- Log crash shipper/device Ä‘á»ƒ debug

### 4. Theo dÃµi Engagement User
- Activity Score cao â†’ Active user
- Activity Score tháº¥p â†’ Cáº§n chiáº¿n dá»‹ch marketing

### 5. So sÃ¡nh Date Range
- Today vs Yesterday: TÄƒng/giáº£m hoáº¡t Ä‘á»™ng
- Week vs Month: Xu hÆ°á»›ng dÃ i háº¡n

## ğŸš¨ Cáº¢NH BÃO & EDGE CASES

1. **No Log Data:**
   - User chÆ°a bao giá» online â†’ onlineLog undefined
   - Fallback: `log = []`, totalHours = 0

2. **Division by Zero:**
   - totalHours = 0 â†’ efficiency = 0 (khÃ´ng chia)
   - userStats.length = 0 â†’ avgHours = NaN (cáº§n check)

3. **Future Timestamps:**
   - Device clock sai â†’ timestamp > Date.now()
   - Cáº§n validate timestamp khi log

4. **Negative Duration:**
   - Logout timestamp < Login timestamp
   - Cáº§n validate duration >= 0

5. **Very Long Session:**
   - User quÃªn logout, duration = 1000 phÃºt
   - Cáº§n cap duration max (VD: 480 phÃºt = 8h)

6. **Realtime Lag:**
   - onSnapshot cÃ³ thá»ƒ delay vÃ i giÃ¢y
   - isOnline status cÃ³ thá»ƒ khÃ´ng realtime 100%

7. **Multiple Devices:**
   - User login nhiá»u device cÃ¹ng lÃºc
   - Log sáº½ cÃ³ nhiá»u sessions overlap
   - Calculation váº«n Ä‘Ãºng (sum all)
