# TÃ“M Táº®T LOGIC TRANG ADMIN/EDIT-FOOD.TSX

## ğŸ¯ Má»¤C ÄÃCH
MÃ n hÃ¬nh thÃªm/sá»­a mÃ³n Äƒn vá»›i Ä‘áº§y Ä‘á»§ tÃ­nh nÄƒng:
- ThÃªm mÃ³n má»›i hoáº·c cáº­p nháº­t mÃ³n cÃ³ sáºµn
- Upload áº£nh lÃªn ImgBB
- Quáº£n lÃ½ tÃ¹y chá»n thÃªm (options): Size, Topping, v.v.
- Cáº¥u hÃ¬nh giÃ¡, giá» bÃ¡n, shop, tráº¡ng thÃ¡i
- Thiáº¿t láº­p option máº·c Ä‘á»‹nh (isDefault)

## ğŸ“Š STATE & DATA

**Store:**
- `foods`: Danh sÃ¡ch mÃ³n Äƒn (load Ä‘á»ƒ edit)

**Route Params:**
- `id`: ID mÃ³n Äƒn (náº¿u edit), undefined náº¿u táº¡o má»›i

**Local State:**
```js
formData: {
  id, name, img, priceNormal, pricePromo, shopId,
  index, status, timeStart, timeEnd, type, note
}
options: Array<{name, price, status, isDefault, index}>
optionForm: {name, price, status, isDefault} // Form thÃªm/sá»­a option
editingOption: number | null // Index cá»§a option Ä‘ang edit
uploading: boolean // Tráº¡ng thÃ¡i upload áº£nh
```

## ğŸ”„ LUá»’NG THá»°C THI

### 1. Load Data (Edit Mode)
```js
useEffect(() => {
  if (id) {
    const food = foods.find(x => x.id === id);
    setFormData(food); // Load thÃ´ng tin mÃ³n
    setOptions(food.option || []); // Load options
  }
}, [id, foods]);
```

### 2. Upload áº¢nh ImgBB
```js
const handlePickAndUpload = async () => {
  // 1. Pick image tá»« gallery
  const result = await ImagePicker.launchImageLibraryAsync({
    aspect: [1, 1],
    quality: 0.5,
    base64: true
  });
  
  // 2. Upload to ImgBB
  const formData = new FormData();
  formData.append('image', asset.base64);
  const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`);
  
  // 3. Update form vá»›i URL
  setFormData(prev => ({ ...prev, img: data.data.url }));
};
```

### 3. Quáº£n lÃ½ Options
**Add Option:**
```js
const handleAddOption = () => {
  // Validate
  if (!optionForm.name || !optionForm.price) return;
  
  const newOption = {
    name: optionForm.name,
    price: parseFloat(optionForm.price),
    status: optionForm.status,
    isDefault: optionForm.isDefault,
    index: options.length + 1
  };
  
  if (editingOption !== null) {
    // Edit mode
    options[editingOption] = newOption;
  } else {
    // Add mode
    setOptions([...options, newOption]);
  }
  
  // Reset form
  setOptionForm({ name: '', price: '', status: true, isDefault: false });
};
```

**Edit Option:**
```js
const handleEditOption = (index) => {
  const option = options[index];
  setOptionForm(option); // Load vÃ o form
  setEditingOption(index); // Mark Ä‘ang edit
};
```

**Delete Option:**
```js
const handleDeleteOption = (index) => {
  Alert.alert("XÃ¡c nháº­n xoÃ¡", "...", [
    { text: "XoÃ¡", onPress: () => {
      const updated = options.filter((_, i) => i !== index);
      // Re-index
      setOptions(updated.map((opt, idx) => ({ ...opt, index: idx + 1 })));
    }}
  ]);
};
```

**Toggle isDefault:**
```js
const handleToggleIsDefault = (value) => {
  if (value) {
    // Chá»‰ 1 option cÃ³ isDefault=true
    const updated = options.map(opt => ({ ...opt, isDefault: false }));
    setOptions(updated);
  }
  setOptionForm({...optionForm, isDefault: value});
};
```

### 4. Save to Firestore
```js
const handleSave = async () => {
  // Validate
  if (!formData.name || !formData.shopId || !formData.priceNormal) {
    Alert.alert("Thiáº¿u thÃ´ng tin");
    return;
  }
  
  // Validate time
  const start = parseInt(formData.timeStart);
  const end = parseInt(formData.timeEnd);
  if (start >= end) {
    Alert.alert("Lá»—i thá»i gian", "Giá» má»Ÿ cá»­a pháº£i nhá» hÆ¡n giá» Ä‘Ã³ng cá»­a");
    return;
  }
  
  // Prepare payload
  const payload = {
    id: id || Date.now(),
    ...formData,
    priceNormal: Number(formData.priceNormal),
    pricePromo: Number(formData.pricePromo || formData.priceNormal),
    shopId: Number(formData.shopId),
    timeStart: start < 10 ? `0${start}` : `${start}`,
    timeEnd: end < 10 ? `0${end}` : `${end}`,
    option: options, // Bao gá»“m isDefault
    image: formData.img ? [formData.img, formData.img, formData.img] : [],
    log: [],
    orderCount: existingOrderCount || 0,
    isOutOfTime: false,
    effectiveStatus: formData.status
  };
  
  // Save to Firestore
  const docRef = doc(db, 'foods', payload.id.toString());
  if (id) await updateDoc(docRef, payload);
  else await setDoc(docRef, payload);
  
  Alert.alert("ThÃ nh cÃ´ng", "ÄÃ£ lÆ°u mÃ³n Äƒn");
  router.back();
};
```

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### ImgBB Upload
```js
const IMGBB_API_KEY = '4be67bc1f9e424d0e25f23a35ab95c03';

// Upload base64 image
const formDataUpload = new FormData();
formDataUpload.append('image', asset.base64);

const response = await fetch(
  `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,
  { method: 'POST', body: formDataUpload }
);

const data = await response.json();
if (data.success) {
  return data.data.url; // URL áº£nh upload
}
```

### Time Validation
```js
const validateTime = (start, end) => {
  if (isNaN(start) || isNaN(end)) return false;
  if (start < 0 || start > 24 || end < 0 || end > 24) return false;
  if (start >= end) return false;
  return true;
};
```

### Format Time
```js
// Ensure 2 digits: 8 â†’ "08"
const formatTime = (hour) => {
  const h = parseInt(hour);
  return h < 10 ? `0${h}` : `${h}`;
};
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â”œâ”€ KeyboardAvoidingView
  â”‚   â”œâ”€ Header
  â”‚   â”‚   â”œâ”€ Close Button
  â”‚   â”‚   â”œâ”€ Title: "Sá»­a mÃ³n Äƒn" / "ThÃªm mÃ³n má»›i"
  â”‚   â”‚   â””â”€ Save Button
  â”‚   â”‚
  â”‚   â””â”€ ScrollView
  â”‚       â”œâ”€ Card: THÃ”NG TIN HIá»‚N THá»Š
  â”‚       â”‚   â”œâ”€ TÃªn mÃ³n Äƒn
  â”‚       â”‚   â”œâ”€ Link áº£nh (vá»›i upload button)
  â”‚       â”‚   â””â”€ MÃ´ táº£/Ghi chÃº
  â”‚       â”‚
  â”‚       â”œâ”€ Card: TÃ€I CHÃNH & QUÃN
  â”‚       â”‚   â”œâ”€ GiÃ¡ gá»‘c | GiÃ¡ giáº£m
  â”‚       â”‚   â””â”€ ShopID
  â”‚       â”‚
  â”‚       â”œâ”€ Card: Váº¬N HÃ€NH & GIá»œ BÃN
  â”‚       â”‚   â”œâ”€ Giá» má»Ÿ | Giá» Ä‘Ã³ng
  â”‚       â”‚   â”œâ”€ Index | PhÃ¢n loáº¡i (Ä‘á»“ Äƒn/Ä‘á»“ uá»‘ng)
  â”‚       â”‚   â””â”€ Tráº¡ng thÃ¡i (Switch enable/disable)
  â”‚       â”‚
  â”‚       â””â”€ Card: TÃ™Y CHá»ŒN THÃŠM (OPTIONS)
  â”‚           â”œâ”€ Option Form
  â”‚           â”‚   â”œâ”€ TÃªn tÃ¹y chá»n
  â”‚           â”‚   â”œâ”€ GiÃ¡ thÃªm
  â”‚           â”‚   â”œâ”€ Hiá»ƒn thá»‹ (Switch)
  â”‚           â”‚   â”œâ”€ Máº·c Ä‘á»‹nh (Switch)
  â”‚           â”‚   â””â”€ Buttons: ThÃªm/Cáº­p nháº­t/Há»§y
  â”‚           â”‚
  â”‚           â””â”€ Options List
  â”‚               â””â”€ Option Item (map)
  â”‚                   â”œâ”€ Name + Default Badge (náº¿u cÃ³)
  â”‚                   â”œâ”€ Price
  â”‚                   â”œâ”€ Status Badge (Hiá»‡n/áº¨n)
  â”‚                   â””â”€ Actions: Edit | Delete
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

### Options Management
1. **Add/Edit Mode:**
   - `editingOption = null` â†’ Add mode
   - `editingOption = index` â†’ Edit mode
   - Reuse form `optionForm` cho cáº£ 2 cháº¿ Ä‘á»™

2. **isDefault Logic:**
   - Chá»‰ 1 option cÃ³ thá»ƒ isDefault=true
   - Khi toggle isDefault=true â†’ Reset táº¥t cáº£ options khÃ¡c vá» false
   - Hiá»ƒn thá»‹ badge "Máº·c Ä‘á»‹nh" vá»›i icon â­

3. **Status Toggle:**
   - `status: true` â†’ Hiá»‡n (badge xanh)
   - `status: false` â†’ áº¨n (badge Ä‘á»)

4. **Re-indexing:**
   - Má»—i khi delete option â†’ Re-index tá»« 1
   - `index: 1, 2, 3, ...`

5. **Validation:**
   - Name khÃ´ng rá»—ng
   - Price pháº£i lÃ  sá»‘ há»£p lá»‡

### Image Upload
6. **ImgBB Integration:**
   - API Key: `4be67bc1f9e424d0e25f23a35ab95c03`
   - Upload base64 image
   - Return URL: `data.data.url`

7. **Loading State:**
   - `uploading = true` â†’ Show ActivityIndicator
   - Disable upload button khi Ä‘ang upload

8. **Image Aspect:**
   - Aspect ratio: [1, 1] (square)
   - Quality: 0.5 (optimize size)

### Time Configuration
9. **Time Range:**
   - `timeStart`: 0-24 (giá» má»Ÿ cá»­a)
   - `timeEnd`: 0-24 (giá» Ä‘Ã³ng cá»­a)
   - Validation: start < end

10. **Time Format:**
    - Store as string: "08", "23"
    - Display: 8 â†’ "08" (leading zero)

### Type Selection
11. **Food Type:**
    - "Ä‘á»“ Äƒn" (default)
    - "Ä‘á»“ uá»‘ng"
    - Toggle buttons style

### Status Management
12. **Status Values:**
    - "enable" â†’ KÃ­ch hoáº¡t (mÃ u xanh)
    - "disable" â†’ Táº¡m khÃ³a (mÃ u Ä‘á»)
    - Switch component

### Payload Structure
13. **Image Array:**
    - `image: [img, img, img]` (duplicate 3 times)
    - Legacy structure from old version

14. **Additional Fields:**
    - `log: []` (empty array for new food)
    - `orderCount: 0` (preserve existing count)
    - `isOutOfTime: false` (initial state)
    - `effectiveStatus: status` (copy from status)

15. **Price Fallback:**
    - If `pricePromo` empty â†’ Use `priceNormal`
    - Ensure pricePromo always has value

## ğŸš€ USER JOURNEY

### Admin - ThÃªm mÃ³n má»›i
1. Navigate to `/admin/edit-food` (khÃ´ng cÃ³ id param)
2. Nháº­p thÃ´ng tin cÆ¡ báº£n: TÃªn, ShopID, GiÃ¡
3. Upload áº£nh tá»« gallery â†’ ImgBB
4. Chá»n loáº¡i: Ä‘á»“ Äƒn/Ä‘á»“ uá»‘ng
5. Cáº¥u hÃ¬nh giá» bÃ¡n: timeStart, timeEnd
6. ThÃªm options (náº¿u cÃ³):
   - Nháº­p name, price
   - Toggle status, isDefault
   - Nháº¥n "ThÃªm tÃ¹y chá»n"
7. Báº­t/táº¯t tráº¡ng thÃ¡i (Switch enable/disable)
8. Nháº¥n "LÆ°u" â†’ Táº¡o document má»›i trong Firestore

### Admin - Sá»­a mÃ³n cÃ³ sáºµn
1. Navigate to `/admin/edit-food?id=123`
2. Load data tá»« `foods.find(x => x.id === id)`
3. Populate formData vÃ  options
4. Sá»­a cÃ¡c trÆ°á»ng cáº§n thiáº¿t
5. Edit options:
   - Nháº¥n Edit icon â†’ Load vÃ o form
   - Sá»­a thÃ´ng tin
   - Nháº¥n "Cáº­p nháº­t"
6. Delete options:
   - Nháº¥n Delete icon â†’ Confirm â†’ XÃ³a vÃ  re-index
7. Nháº¥n "LÆ°u" â†’ Update document trong Firestore

## ğŸ”— NAVIGATION

**Navigates TO:** KhÃ´ng (modal-style screen)

**Navigates FROM:**
- Admin Products page â†’ Nháº¥n "Sá»­a" trÃªn food card
- Admin Products page â†’ Nháº¥n "ThÃªm mÃ³n má»›i"

**Back Navigation:**
- Close icon (header left)
- After save success â†’ `router.back()`

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

### Firestore Operations
1. **Document ID:**
   - Edit mode: Use existing `id`
   - Create mode: `Date.now()` (timestamp)

2. **Update vs SetDoc:**
   - Edit: `updateDoc(docRef, payload)`
   - Create: `setDoc(docRef, payload)`

3. **Collection:** `foods`

### Option Structure
```js
{
  name: string,        // "Size L", "ThÃªm trÃ¢n chÃ¢u"
  price: number,       // 8, 5 (nghÃ¬n Ä‘á»“ng)
  status: boolean,     // true=Hiá»‡n, false=áº¨n
  isDefault: boolean,  // true=Máº·c Ä‘á»‹nh, false=KhÃ´ng
  index: number        // 1, 2, 3, ... (thá»© tá»±)
}
```

### ImgBB Response
```js
{
  success: true,
  data: {
    url: "https://i.ibb.co/xxx/image.jpg",
    delete_url: "...",
    ...
  }
}
```

### Time Handling
4. **Input Type:** `numeric` keyboard
5. **MaxLength:** 2 characters (0-24)
6. **Parse:** `parseInt()` before validation
7. **Format:** Leading zero for single digit (8 â†’ "08")

### Price Handling
8. **Input:** String ("50", "45")
9. **Parse:** `Number()` before save
10. **Display:** User nháº­p nghÃ¬n Ä‘á»“ng (k)
11. **Store:** Sá»‘ nguyÃªn (50 = 50k)

### KeyboardAvoidingView
12. **Behavior:**
    - iOS: `"padding"`
    - Android: `null` (khÃ´ng cáº§n, keyboard push tá»± Ä‘á»™ng)

### Platform-Specific
13. **Image Picker:**
    - `mediaTypes`: Images only
    - `allowsEditing`: true
    - `base64`: true (for ImgBB)

14. **Alert:**
    - Delete option â†’ Destructive style
    - Save success â†’ Normal style

### State Management
15. **Local State Only:**
    - KhÃ´ng update Zustand store
    - Chá»‰ save vÃ o Firestore
    - Store auto-update qua listener

16. **Form Reset:**
    - After add option â†’ Reset optionForm
    - After cancel edit â†’ Reset optionForm + editingOption

17. **Validation Timing:**
    - On save button press (khÃ´ng realtime)
    - Show Alert náº¿u validation fail

### UI/UX Details
18. **Card Layout:**
    - Grouped by function (Hiá»ƒn thá»‹, TÃ i chÃ­nh, Váº­n hÃ nh, Options)
    - elevation: 2 (shadow effect)
    - borderRadius: 15

19. **Option Item Highlight:**
    - Default option: Border red, background pink
    - Normal option: Border gray, background white

20. **Empty State:**
    - Icon "options-outline" size 40
    - Text "ChÆ°a cÃ³ tÃ¹y chá»n nÃ o"

21. **Button States:**
    - Add mode: "ThÃªm tÃ¹y chá»n" + add icon
    - Edit mode: "Cáº­p nháº­t" + checkmark icon
    - Edit mode: Show "Há»§y" button

## ğŸ¯ OPTION USE CASES

### 1. Size Options
```js
[
  { name: "Size S", price: 0, status: true, isDefault: true },
  { name: "Size M", price: 5, status: true, isDefault: false },
  { name: "Size L", price: 8, status: true, isDefault: false }
]
```
- User order â†’ Default select "Size S" (price +0k)
- Switch to "Size L" â†’ Price +8k

### 2. Topping Options
```js
[
  { name: "ThÃªm trÃ¢n chÃ¢u", price: 5, status: true, isDefault: false },
  { name: "ThÃªm tháº¡ch", price: 3, status: true, isDefault: false },
  { name: "ÄÃ¡ riÃªng", price: 0, status: false, isDefault: false }
]
```
- User order â†’ Choose toppings (multiple select)
- "ÄÃ¡ riÃªng" status=false â†’ KhÃ´ng hiá»ƒn thá»‹ cho user

### 3. Spicy Level
```js
[
  { name: "KhÃ´ng cay", price: 0, status: true, isDefault: true },
  { name: "Cay vá»«a", price: 0, status: true, isDefault: false },
  { name: "Cay ná»“ng", price: 0, status: true, isDefault: false }
]
```
- All options free (price=0)
- Default: "KhÃ´ng cay"

## ğŸ” VALIDATION RULES

### Required Fields
- âœ… `name`: KhÃ´ng rá»—ng
- âœ… `shopId`: KhÃ´ng rá»—ng, pháº£i lÃ  sá»‘
- âœ… `priceNormal`: KhÃ´ng rá»—ng, pháº£i lÃ  sá»‘ > 0

### Optional Fields
- `pricePromo`: Náº¿u rá»—ng â†’ Copy tá»« priceNormal
- `img`: CÃ³ thá»ƒ rá»—ng (placeholder image)
- `note`: CÃ³ thá»ƒ rá»—ng
- `options`: CÃ³ thá»ƒ rá»—ng (khÃ´ng báº¯t buá»™c cÃ³ option)

### Time Rules
- âœ… `timeStart` vÃ  `timeEnd`: 0-24
- âœ… `timeStart < timeEnd`
- âœ… Cáº£ 2 pháº£i lÃ  sá»‘ nguyÃªn

### Option Rules (khi thÃªm option)
- âœ… `name`: KhÃ´ng rá»—ng
- âœ… `price`: Pháº£i lÃ  sá»‘ (cÃ³ thá»ƒ = 0)
- âš ï¸ KhÃ´ng validate duplicate name (cÃ³ thá»ƒ trÃ¹ng)

## ğŸš¨ EDGE CASES

1. **Upload Fail:**
   - Network error â†’ Alert "Lá»—i Máº¡ng"
   - ImgBB reject â†’ Alert "Lá»—i Upload"
   - Image quÃ¡ lá»›n â†’ Quality 0.5 giáº£m size

2. **Delete Last Option:**
   - Options length = 0 â†’ Show empty state
   - No error

3. **Edit Option While Editing:**
   - Cancel current edit â†’ Reset editingOption
   - Load new option vÃ o form

4. **Toggle Default While Editing:**
   - Update all existing options â†’ isDefault=false
   - Current optionForm â†’ isDefault=true

5. **Save Without Options:**
   - Valid â†’ option=[] (empty array)
   - Food váº«n táº¡o Ä‘Æ°á»£c

6. **Duplicate Food Name:**
   - KhÃ´ng validate (cho phÃ©p trÃ¹ng)
   - ID unique nÃªn khÃ´ng conflict

7. **Invalid ShopID:**
   - User nháº­p shopId khÃ´ng tá»“n táº¡i
   - Food váº«n lÆ°u Ä‘Æ°á»£c (khÃ´ng validate foreign key)
   - Shop filter sáº½ khÃ´ng hiá»ƒn thá»‹ food nÃ y
