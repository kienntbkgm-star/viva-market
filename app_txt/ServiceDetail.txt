# TÃ“M Táº®T LOGIC TRANG SERVICEDETAIL.TSX

## ğŸ¯ Má»¤C ÄÃCH
Trang **chi tiáº¿t dá»‹ch vá»¥** - hiá»ƒn thá»‹ thÃ´ng tin dá»‹ch vá»¥, cho phÃ©p Ä‘áº·t dá»‹ch vá»¥ (cáº£ user vÃ  guest)

## ğŸ“Š STATE & DATA

**Props tá»« params:**
- `item`: JSON string cá»§a dá»‹ch vá»¥ (parse thÃ nh object)

**State local:**
- `note`: Ghi chÃº cho dá»‹ch vá»¥
- `isSubmitting`: Tráº¡ng thÃ¡i Ä‘ang submit order
- `gName`, `gPhone`, `gAddress`: ThÃ´ng tin guest (náº¿u lÃ  guest)

**Data tá»« Store:**
- `users`: Danh sÃ¡ch user (Ä‘á»ƒ tÃ¬m shop owner)
- `currentUser`: User hiá»‡n táº¡i

**Computed:**
- `isGuestUser`: `currentUser && !currentUser.password`
- `price`: Æ¯u tiÃªn pricePromo, khÃ´ng cÃ³ thÃ¬ priceNormal
- `displayImage`: service.img hoáº·c service.image
- `shopData`: ThÃ´ng tin shop tá»« users array

## ğŸ”„ LUá»’NG THá»°C THI

### **1. Load Trang:**
```
Parse service tá»« params
  â†“
Check isGuestUser
  â†“
TÃ­nh price (promo hoáº·c normal)
  â†“
TÃ¬m shopData tá»« users array
  â†“
Render UI:
  - Náº¿u guest â†’ Hiá»ƒn thá»‹ form nháº­p thÃ´ng tin
  - Náº¿u user â†’ KhÃ´ng hiá»ƒn thá»‹ form
```

### **2. Äáº·t Dá»‹ch Vá»¥:**
```
User nháº¥n "Äáº¶T Dá»ŠCH Vá»¤ NGAY"
  â†“
handleCreateServiceOrder() Ä‘Æ°á»£c gá»i
  â†“
Kiá»ƒm tra Ä‘Äƒng nháº­p:
  - ChÆ°a login â†’ Alert â†’ Chuyá»ƒn /login
  â†“
Validate thÃ´ng tin:
  Guest:
    - Check gName, gPhone, gAddress khÃ´ng rá»—ng
    - Validate SÄT format VN
  User:
    - Check currentUser.phone vÃ  address Ä‘Ã£ cÃ³ chÆ°a
  â†“
Táº¡o orderPayload vá»›i 16 trÆ°á»ng
  â†“
addDoc vÃ o Firestore collection 'serviceOrders'
  â†“
Alert "ThÃ nh cÃ´ng"
  â†“
router.back()
```

## ğŸ”§ CÃC FUNCTION QUAN TRá»ŒNG

### `validatePhoneNumber(phone)`
**Má»¥c Ä‘Ã­ch:** Validate sá»‘ Ä‘iá»‡n thoáº¡i Viá»‡t Nam

**Logic:**
```javascript
const vnf_regex = /((09|03|07|08|05)+([0-9]{8})\b)/g;
return vnf_regex.test(phone.trim());
```

**Äáº§u sá»‘ há»£p lá»‡:** 09, 03, 07, 08, 05 + 8 sá»‘

### `handleCreateServiceOrder()`
**Validation:**

**Náº¿u khÃ´ng login:**
```javascript
if (!currentUser) {
  Alert â†’ router.push('/login')
  return;
}
```

**Náº¿u lÃ  guest:**
```javascript
if (isGuestUser) {
  if (!gName || !gPhone || !gAddress) {
    Alert "Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin"
    return;
  }
  if (!validatePhoneNumber(gPhone)) {
    Alert "SÄT khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng VN"
    return;
  }
}
```

**Náº¿u lÃ  user:**
```javascript
if (!currentUser.address || !currentUser.phone) {
  Alert "Vui lÃ²ng cáº­p nháº­t SÄT vÃ  Äá»‹a chá»‰ trong há»“ sÆ¡"
  return;
}
```

**Táº¡o Order:**
```javascript
const orderPayload = {
  orderId: `SV-${Date.now()}`,        // Format Ä‘áº·c biá»‡t cho service
  serviceId: service.id,
  serviceName: service.name,
  shopId: service.shopId,
  shopName: shopData.name,
  userId: currentUser.id,
  userName: isGuestUser ? gName : currentUser.name,
  userPhone: isGuestUser ? gPhone : currentUser.phone,
  userAddress: isGuestUser ? gAddress : currentUser.address,
  price: price,
  note: note.trim(),
  status: 'pending',
  isGuest: isGuestUser,
  paymentMethod: 'COD',
  createdAt: new Date().toISOString(),
  logs: [{
    time: new Date().toISOString(),
    content: `YÃªu cáº§u dá»‹ch vá»¥ "${service.name}" Ä‘Ã£ Ä‘Æ°á»£c táº¡o bá»Ÿi ${userName}.`,
    status: 'pending'
  }]
};

await addDoc(collection(db, 'serviceOrders'), orderPayload);
```

## ğŸ’° TÃNH GIÃ

```javascript
price = useMemo(() => {
  const promo = Number(service.pricePromo || 0) * 1000;
  const normal = Number(service.priceNormal || 0) * 1000;
  return promo > 0 ? promo : normal;
}, [service.pricePromo, service.priceNormal]);
```

**Logic:**
- Æ¯u tiÃªn giÃ¡ khuyáº¿n mÃ£i (pricePromo)
- Náº¿u promo = 0 â†’ DÃ¹ng giÃ¡ thÆ°á»ng (priceNormal)
- NhÃ¢n 1000 Ä‘á»ƒ Ä‘á»•i tá»« nghÃ¬n Ä‘á»“ng sang Ä‘á»“ng

**Hiá»ƒn thá»‹ giáº£m giÃ¡:**
```javascript
if (priceNormal * 1000 > price) {
  Hiá»ƒn thá»‹: "Báº¡n Ä‘Æ°á»£c giáº£m {sá»‘ tiá»n}Ä‘ cho dá»‹ch vá»¥ nÃ y!"
}
```

## ğŸ¨ UI Cáº¤U TRÃšC

```
SafeAreaView
  â†“
ScrollView
  â”œâ”€â”€ NÃºt back (arrow)
  â”œâ”€â”€ Image banner (dá»‹ch vá»¥)
  â”œâ”€â”€ Shop info:
  â”‚   â”œâ”€â”€ Icon build
  â”‚   â”œâ”€â”€ TÃªn shop + Äá»‹a chá»‰
  â”‚   â””â”€â”€ Badge "Dá»‹ch vá»¥"
  â”œâ”€â”€ TÃªn dá»‹ch vá»¥
  â”œâ”€â”€ MÃ´ táº£
  â”œâ”€â”€ Discount note (náº¿u cÃ³ giáº£m giÃ¡)
  â”œâ”€â”€ Form guest info (náº¿u isGuestUser):
  â”‚   â”œâ”€â”€ Input: Há» vÃ  tÃªn
  â”‚   â”œâ”€â”€ Input: SÄT
  â”‚   â””â”€â”€ Input: Äá»‹a chá»‰
  â”œâ”€â”€ Section: Ghi chÃº
  â””â”€â”€ Footer:
      â”œâ”€â”€ GiÃ¡ (Ä‘Ã£ giáº£m hoáº·c giÃ¡ thÆ°á»ng)
      â””â”€â”€ NÃºt "Äáº¶T Dá»ŠCH Vá»¤ NGAY"
```

## ğŸ‘¥ GUEST VS USER

### **Guest User:**
```
isGuestUser = true
  â†“
Hiá»ƒn thá»‹ form nháº­p thÃ´ng tin:
  - Há» vÃ  tÃªn *
  - Sá»‘ Ä‘iá»‡n thoáº¡i *
  - Äá»‹a chá»‰ nháº­n dá»‹ch vá»¥ *
  â†“
Validate khi submit:
  - KhÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng
  - SÄT Ä‘Ãºng format VN
  â†“
Táº¡o order vá»›i thÃ´ng tin tá»« form
```

### **Registered User:**
```
isGuestUser = false
  â†“
KHÃ”NG hiá»ƒn thá»‹ form nháº­p thÃ´ng tin
  â†“
Validate khi submit:
  - currentUser.phone pháº£i cÃ³
  - currentUser.address pháº£i cÃ³
  â†“
Táº¡o order vá»›i thÃ´ng tin tá»« currentUser
```

## ğŸ“‹ ORDER PAYLOAD (16 TRÆ¯á»œNG)

```javascript
{
  orderId: "SV-1738012345678",           // String vá»›i prefix SV-
  serviceId: "sv001",                    // ID dá»‹ch vá»¥
  serviceName: "Sá»­a chá»¯a Ä‘iá»‡n nÆ°á»›c",     // TÃªn dá»‹ch vá»¥
  shopId: "shop123",                     // ID shop
  shopName: "Dá»‹ch vá»¥ Minh Anh",          // TÃªn shop
  userId: "user456",                     // ID user/guest
  userName: "Nguyá»…n VÄƒn A",              // TÃªn
  userPhone: "0901234567",               // SÄT
  userAddress: "123 Nguyá»…n TrÃ£i...",     // Äá»‹a chá»‰
  price: 250000,                         // GiÃ¡ (sá»‘)
  note: "Cáº§n sá»­a vÃ o chiá»u",             // Ghi chÃº
  status: "pending",                     // Tráº¡ng thÃ¡i
  isGuest: false,                        // Guest hay khÃ´ng
  paymentMethod: "COD",                  // PhÆ°Æ¡ng thá»©c thanh toÃ¡n
  createdAt: "2026-01-27T...",           // ISO string
  logs: [{                               // Máº£ng lá»‹ch sá»­
    time: "2026-01-27T...",
    content: "YÃªu cáº§u dá»‹ch vá»¥...",
    status: "pending"
  }]
}
```

## âš¡ ÄIá»‚M Äáº¶C BIá»†T

âœ… **Há»— trá»£ guest Ä‘áº·t dá»‹ch vá»¥** - Guest nháº­p thÃ´ng tin táº¡m má»—i láº§n Ä‘áº·t
âœ… **Validate SÄT VN** - Regex check Ä‘Ãºng format Viá»‡t Nam
âœ… **OrderID format Ä‘áº·c biá»‡t** - `SV-{timestamp}` Ä‘á»ƒ phÃ¢n biá»‡t vá»›i food orders
âœ… **Logs tracking** - Máº£ng logs Ä‘á»ƒ theo dÃµi lá»‹ch sá»­ thay Ä‘á»•i tráº¡ng thÃ¡i
âœ… **Shop info dynamic** - Láº¥y tÃªn shop, Ä‘á»‹a chá»‰ tá»« users array
âœ… **Price logic thÃ´ng minh** - Æ¯u tiÃªn giÃ¡ khuyáº¿n mÃ£i, hiá»ƒn thá»‹ sá»‘ tiá»n giáº£m
âœ… **Loading state** - Disable nÃºt + text "ÄANG Xá»¬ LÃ..." khi Ä‘ang submit

## ğŸš€ USER JOURNEY

### **Guest User:**
```
Xem danh sÃ¡ch dá»‹ch vá»¥ â†’ Click dá»‹ch vá»¥
  â†“
VÃ o ServiceDetail
  â†“
Xem thÃ´ng tin: tÃªn, giÃ¡, mÃ´ táº£, shop
  â†“
Nháº­p thÃ´ng tin liÃªn há»‡:
  - Há» tÃªn
  - SÄT
  - Äá»‹a chá»‰
  â†“
Nháº­p ghi chÃº (optional)
  â†“
Nháº¥n "Äáº¶T Dá»ŠCH Vá»¤ NGAY"
  â†“
Validate pass â†’ Táº¡o order
  â†“
Alert thÃ nh cÃ´ng â†’ Quay vá»
```

### **Registered User:**
```
Xem danh sÃ¡ch dá»‹ch vá»¥ â†’ Click dá»‹ch vá»¥
  â†“
VÃ o ServiceDetail
  â†“
Xem thÃ´ng tin (khÃ´ng cáº§n nháº­p info)
  â†“
Nháº­p ghi chÃº (optional)
  â†“
Nháº¥n "Äáº¶T Dá»ŠCH Vá»¤ NGAY"
  â†“
Check profile cÃ³ SÄT + Ä‘á»‹a chá»‰ chÆ°a
  â†“
CÃ³ â†’ Táº¡o order
KhÃ´ng â†’ Alert yÃªu cáº§u cáº­p nháº­t profile
```

## ğŸ”— NAVIGATION

**VÃ o ServiceDetail tá»«:**
- âœ… Services tab: Click vÃ o service card

**Tá»« ServiceDetail Ä‘i Ä‘áº¿n:**
- âœ… Login: Náº¿u chÆ°a login (click Ä‘áº·t dá»‹ch vá»¥)
- âœ… Quay vá»: router.back() sau khi Ä‘áº·t thÃ nh cÃ´ng

## ğŸ’¡ LÆ¯U Ã Ká»¸ THUáº¬T

**Parse Service:**
```javascript
const service = useMemo(() => {
  try {
    const parsed = JSON.parse(params.item || '{}');
    return parsed.service ? parsed.service : parsed;
  } catch {
    return {};
  }
}, [params.item]);
```
- Há»— trá»£ 2 format: `{service: {...}}` hoáº·c `{...}`

**Shop Info Fallback:**
```javascript
shopData = {
  name: owner?.shopName || owner?.name || `ÄÆ¡n vá»‹ #${shopId}`,
  address: owner?.address || 'Äang cáº­p nháº­t Ä‘á»‹a chá»‰'
}
```
- Æ¯u tiÃªn shopName, khÃ´ng cÃ³ thÃ¬ dÃ¹ng name
- Fallback: "ÄÆ¡n vá»‹ #123" náº¿u khÃ´ng tÃ¬m tháº¥y

**Loading State:**
```javascript
isSubmitting:
  - true â†’ Disable nÃºt + Text "ÄANG Xá»¬ LÃ..."
  - false â†’ Enable nÃºt + Text "Äáº¶T Dá»ŠCH Vá»¤ NGAY"
```

**Error Handling:**
```javascript
try {
  await addDoc(...)
  Alert thÃ nh cÃ´ng
} catch (error) {
  console.error(error)
  Alert lá»—i
} finally {
  setIsSubmitting(false)  // LuÃ´n reset state
}
```

===============================================================================
Cáº¬P NHáº¬T: 27/01/2026
===============================================================================
