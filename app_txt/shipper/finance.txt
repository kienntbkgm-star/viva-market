# T√ìM T·∫ÆT LOGIC TRANG SHIPPER/FINANCE.TSX

## üéØ M·ª§C ƒê√çCH
M√†n h√¨nh qu·∫£n l√Ω t√†i ch√≠nh C√Å NH√ÇN c·ªßa shipper (shipper view):
- Xem s·ªë d∆∞ n·ª£ c·ªßa b·∫£n th√¢n (v·ªõi admin)
- Xem l·ªãch s·ª≠ giao d·ªãch (transactions) c·ªßa m√¨nh
- Display logic ƒë·∫£o ng∆∞·ª£c so v·ªõi admin view (user-friendly)
- Kh√¥ng c√≥ function thu/tr·∫£ ti·ªÅn (ch·ªâ xem)

## üìä STATE & DATA

**User Context:**
```js
const { currentUser } = useAppStore(); // Shipper ƒëang ƒëƒÉng nh·∫≠p
```

**Local State:**
```js
transactions: Array<Transaction> // Danh s√°ch giao d·ªãch c·ªßa shipper
loading: boolean // Tr·∫°ng th√°i loading
```

**Computed Data:**
```js
// RAW balance t·ª´ Firestore (gi·ªëng admin view)
const rawBalance = transactions.reduce(
  (sum, t) => sum + (t.amount || 0), 
  0
);

// DISPLAY balance (ƒë·∫£o d·∫•u ƒë·ªÉ user-friendly)
const displayBalance = rawBalance * -1;

/**
 * WHY FLIP SIGN?
 * - Firestore data: Positive = Shipper owes admin (bad for shipper)
 * - User-friendly: Negative = Shipper owes admin (red color, bad)
 * - So we flip: displayBalance = -rawBalance
 * 
 * Example:
 * - Firestore: +50k (shipper owes) ‚Üí Display: -50k (red, bad)
 * - Firestore: -20k (admin owes) ‚Üí Display: +20k (green, good)
 */
```

**Realtime Listener:**
- Query `transactions` collection
- Filter by `userId === currentUser.id`
- OrderBy `createdAt` desc (Firestore orderBy, C√ì index)

## üîÑ LU·ªíNG TH·ª∞C THI

### 1. Load Transactions
```js
useEffect(() => {
  if (!currentUser || currentUser.role !== 'shipper') {
    router.replace('/(tabs)/home');
    return;
  }
  
  setLoading(true);
  
  // Query WITH orderBy (c√≥ index trong Firestore)
  const q = query(
    collection(db, 'transactions'),
    where('userId', '==', Number(currentUser.id)),
    orderBy('createdAt', 'desc') // Sort by Firestore
  );
  
  const unsubscribe = onSnapshot(q, (snapshot) => {
    const data = snapshot.docs.map(doc => ({ 
      id: doc.id, 
      ...doc.data() 
    }));
    
    setTransactions(data);
    setLoading(false);
  });
  
  return () => unsubscribe();
}, [currentUser]);
```

### 2. Calculate Display Balance
```js
// Step 1: Sum all amounts (same as admin view)
const rawBalance = transactions.reduce(
  (sum, t) => sum + (t.amount || 0), 
  0
);

// Step 2: Flip sign for display
const displayBalance = rawBalance * -1;

// Step 3: Determine status
const isDebtToAdmin = displayBalance < 0; // Red card
const isAdminOwes = displayBalance > 0; // Green card
const statusText = isDebtToAdmin 
  ? "B·∫†N ƒêANG N·ª¢ ADMIN"
  : "ADMIN ƒêANG N·ª¢ B·∫†N";
```

### 3. Display Transactions (Flipped)
```js
const renderItem = ({ item }) => {
  // Flip amount for display
  const displayAmount = (item.amount || 0) * -1;
  
  // Determine color (opposite of admin view)
  const amountColor = displayAmount < 0 ? '#E67E22' : '#27AE60';
  
  // Show icon based on status
  const icon = isDebtToAdmin ? 'receipt' : 'cash-check';
  
  return (
    <View style={styles.transactionItem}>
      <Icon name={icon} size={24} color={amountColor} />
      <View style={styles.transactionContent}>
        <Text style={styles.transactionDesc}>{item.desc}</Text>
        <Text style={styles.transactionDate}>
          {formatDate(item.createdAt)}
        </Text>
      </View>
      <Text style={[styles.transactionAmount, { color: amountColor }]}>
        {displayAmount >= 0 ? '+' : ''}{(displayAmount * 1000).toLocaleString()}ƒë
      </Text>
    </View>
  );
};
```

## üîß C√ÅC FUNCTION QUAN TR·ªåNG

### Balance Flip Logic
```js
// Magic formula:
const displayBalance = rawBalance * -1;

// Example 1: Shipper owes 50k
// - Firestore: +50k (positive, shipper debt)
// - Display: -50k (negative, red, bad for shipper)

// Example 2: Admin owes 20k
// - Firestore: -20k (negative, admin owes)
// - Display: +20k (positive, green, good for shipper)
```

### Transaction Flip Logic
```js
// Each transaction also flipped
const displayAmount = (item.amount || 0) * -1;

// Example:
// - Firestore: +15k (debt increased) ‚Üí Display: -15k (red)
// - Firestore: -10k (payment received) ‚Üí Display: +10k (green)
```

### Status Text
```js
const isDebtToAdmin = displayBalance < 0;
const statusText = isDebtToAdmin 
  ? "B·∫†N ƒêANG N·ª¢ ADMIN"
  : "ADMIN ƒêANG N·ª¢ B·∫†N";

// Color:
const statusColor = isDebtToAdmin ? '#E67E22' : '#27AE60';
```

### Icon Logic
```js
const icon = isDebtToAdmin ? 'receipt' : 'cash-check';

// receipt: Shipper owes (bill icon)
// cash-check: Admin owes (money icon)
```

### Date Formatting
```js
const formatDate = (isoString) => {
  const date = new Date(isoString);
  return date.toLocaleString('vi-VN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
};

// Output: "27/01/2026, 10:30:15"
```

## üé® UI C·∫§U TR√öC

```
SafeAreaView
  ‚îú‚îÄ Header
  ‚îÇ   ‚îú‚îÄ Back Button
  ‚îÇ   ‚îú‚îÄ Title: "T√†i ch√≠nh c·ªßa t√¥i"
  ‚îÇ   ‚îî‚îÄ Spacer
  ‚îÇ
  ‚îú‚îÄ Balance Card (Top)
  ‚îÇ   ‚îú‚îÄ Background color: Orange (debt) / Green (admin owes)
  ‚îÇ   ‚îú‚îÄ Icon: receipt / cash-check
  ‚îÇ   ‚îú‚îÄ Status Badge: "B·∫†N ƒêANG N·ª¢ ADMIN" / "ADMIN ƒêANG N·ª¢ B·∫†N"
  ‚îÇ   ‚îú‚îÄ Label: "S·ªë d∆∞ hi·ªán t·∫°i"
  ‚îÇ   ‚îî‚îÄ Amount: [displayBalance]ƒë (fontSize 32, bold, white)
  ‚îÇ
  ‚îú‚îÄ Section Title: "L·ªãch s·ª≠ giao d·ªãch"
  ‚îÇ
  ‚îî‚îÄ FlatList: Transaction Items
      ‚îî‚îÄ renderItem: Transaction Row
          ‚îú‚îÄ Icon (left): receipt / cash-check
          ‚îú‚îÄ Content (middle):
          ‚îÇ   ‚îú‚îÄ Desc (bold)
          ‚îÇ   ‚îî‚îÄ Date (gray, small)
          ‚îî‚îÄ Amount (right): ¬±XXXƒë (color-coded)
```

## ‚ö° ƒêI·ªÇM ƒê·∫∂C BI·ªÜT

### Dual Perspective Display
1. **Admin View (shipper-detail-finance.tsx):**
   - rawBalance = +50k ‚Üí Display: +50k (orange, "Shipper n·ª£")
   - rawBalance = -20k ‚Üí Display: -20k (green, "Admin n·ª£")

2. **Shipper View (shipper/finance.tsx):**
   - rawBalance = +50k ‚Üí Display: -50k (red, "B·∫°n ƒëang n·ª£ Admin")
   - rawBalance = -20k ‚Üí Display: +20k (green, "Admin ƒëang n·ª£ b·∫°n")

3. **Why Flip?**
   - User psychology: Negative = bad, positive = good
   - Firestore data perspective: Admin-centric (positive = shipper owes)
   - Shipper perspective: User-centric (negative = I owe, positive = They owe me)

### Color Coding (Opposite of Admin)
4. **Admin View:**
   - Amount >= 0: Orange (shipper debt)
   - Amount < 0: Green (admin owes)

5. **Shipper View (After Flip):**
   - displayAmount < 0: Orange (I owe, bad)
   - displayAmount >= 0: Green (They owe me, good)

6. **Balance Card Background:**
   - `isDebtToAdmin` (displayBalance < 0): Orange background
   - `isAdminOwes` (displayBalance > 0): Green background
   - Zero: Neutral (orange default)

### Read-Only View
7. **No Input:**
   - Shipper cannot add transactions manually
   - No "Thu ti·ªÅn" or "Tr·∫£ ti·ªÅn" button

8. **Realtime Sync:**
   - Auto update when:
     - Admin thu ti·ªÅn (PAYMENT)
     - Shipper giao ƒë∆°n COD (DEBT)
     - System create refund (REFUND)

### Icon Indicators
9. **receipt icon:**
   - Show when shipper owes admin
   - Orange color
   - Represents debt/bill

10. **cash-check icon:**
    - Show when admin owes shipper
    - Green color
    - Represents money owed to shipper

### Firestore Index
11. **Query Uses orderBy:**
    - `orderBy('createdAt', 'desc')`
    - Requires Firestore composite index
    - Index exists: `(userId, createdAt DESC)`

12. **Admin View Difference:**
    - Admin view: Sort in JavaScript (no orderBy)
    - Shipper view: Sort in Firestore (has orderBy)
    - Reason: Admin view may have been created first before index

### Role Check
13. **Auth Guard:**
    ```js
    if (!currentUser || currentUser.role !== 'shipper') {
      router.replace('/(tabs)/home');
      return;
    }
    ```
    - Only shipper can access
    - Redirect to home if not shipper

### Loading State
14. **Show Loading:**
    - `loading === true` during initial fetch
    - Show spinner or "ƒêang t·∫£i..."

15. **Hide Loading:**
    - After onSnapshot first callback
    - Even if transactions empty

## üöÄ USER JOURNEY

### Shipper - Xem s·ªë d∆∞
1. Navigate: Shipper tab ‚Üí Nh·∫•n "T√†i ch√≠nh"
2. Route: `/shipper/finance`
3. Load transactions of current shipper
4. Display:
   - Balance card: -50,000ƒë (orange, "B·∫†N ƒêANG N·ª¢ ADMIN")
   - Transaction list:
     - Giao ƒë∆°n #123: -15,000ƒë (orange, debt)
     - Giao ƒë∆°n #124: -8,000ƒë (orange, debt)
     - Admin thu ti·ªÅn: +20,000ƒë (green, payment)
     - Giao ƒë∆°n #125: -10,000ƒë (orange, debt)
     - ...

### Shipper - Sau khi giao ƒë∆°n
1. Shipper complete order #126 (COD 12k)
2. System auto create DEBT transaction:
   - Firestore: +12k (increase debt)
3. Realtime listener trigger
4. Shipper screen update:
   - Balance: -50k ‚Üí -62k (worse)
   - New transaction: -12,000ƒë (orange)
   - Status: "B·∫†N ƒêANG N·ª¢ ADMIN"

### Shipper - Sau khi admin thu ti·ªÅn
1. Shipper give 30k cash to admin
2. Admin nh·∫≠p 30000 ‚Üí Thu n·ª£
3. System create PAYMENT transaction:
   - Firestore: -30k (decrease debt)
4. Realtime listener trigger
5. Shipper screen update:
   - Balance: -62k ‚Üí -32k (better)
   - New transaction: +30,000ƒë (green)
   - Status: "B·∫†N ƒêANG N·ª¢ ADMIN"

### Shipper - S·ªë d∆∞ d∆∞∆°ng
1. Shipper giao nhi·ªÅu ƒë∆°n c√≥ discount cao
2. Multiple REFUND transactions:
   - Firestore: -5k, -3k, -2k (admin owes)
3. Balance: +10k (admin owes shipper)
4. Shipper screen:
   - Balance card: +10,000ƒë (green background)
   - Status: "ADMIN ƒêANG N·ª¢ B·∫†N"
   - Icon: cash-check
   - Shipper wait for admin to pay back

## üîó NAVIGATION

**Navigates TO:** Kh√¥ng

**Navigates FROM:**
- Shipper tab screen
- Route: `/shipper/finance`

**Back Navigation:**
- Back button (header left) ‚Üí `router.back()`

**Redirect:**
- If not shipper role ‚Üí `router.replace('/(tabs)/home')`

## üí° L∆ØU √ù K·ª∏ THU·∫¨T

### Firestore Query
1. **Collection:** `transactions`
2. **Query:**
   ```js
   query(
     collection(db, 'transactions'),
     where('userId', '==', Number(currentUser.id)),
     orderBy('createdAt', 'desc')
   )
   ```
3. **Index Required:** Yes
   - Index fields: `(userId, createdAt DESC)`
   - Create in Firestore console

### Transaction Structure (Same as Admin)
```js
{
  id: string,
  userId: number,           // Shipper ID
  userName: string,         // Shipper name
  type: 'DEBT' | 'PAYMENT' | 'REFUND',
  amount: number,           // Ngh√¨n ƒë·ªìng (k), BEFORE flip
  desc: string,
  orderId?: string,
  customerName?: string,
  createdAt: string,        // ISO timestamp
  performedBy: 'system' | 'admin'
}
```

### Display Amount Calculation
4. **Firestore Data:**
   - DEBT: +15k (shipper owes more)
   - PAYMENT: -10k (shipper owes less)
   - REFUND: -2k (admin owes shipper)

5. **Display Data (After Flip):**
   - DEBT: -15k (red, bad)
   - PAYMENT: +10k (green, good)
   - REFUND: +2k (green, good)

### Color Logic
6. **Admin View:**
   - amount >= 0: Orange
   - amount < 0: Green

7. **Shipper View:**
   - displayAmount < 0: Orange
   - displayAmount >= 0: Green

8. **Result:** Same visual meaning, opposite data sign

### Balance Display
9. **Format:**
   - `(displayBalance * 1000).toLocaleString()`
   - Add 'ƒë' suffix
   - Example: "50,000ƒë"

10. **Sign Display:**
    - Positive: No '+' sign (implicit good)
    - Negative: Show '-' sign (explicit bad)

### Transaction Amount Display
11. **Format:**
    - `(displayAmount * 1000).toLocaleString()`
    - Add 'ƒë' suffix

12. **Sign Display:**
    - Positive: Add '+' prefix (money in)
    - Negative: Show '-' prefix (money out)

### Date Display
13. **Format:** `toLocaleString('vi-VN', {...})`
14. **Output:** "27/01/2026, 10:30:15"

### Icon Library
15. **Import:** `MaterialCommunityIcons`
16. **Icons:**
    - `receipt`: Bill/debt icon
    - `cash-check`: Money/payment icon

### Loading State
17. **Initial:** `loading = true`
18. **After Fetch:** `loading = false`
19. **Show:** Loading spinner or text

### Role-Based Access
20. **Check:** `currentUser.role === 'shipper'`
21. **Redirect:** If not shipper ‚Üí home

## üîç TRANSACTION DISPLAY EXAMPLES

### Example 1: Shipper giao ƒë∆°n COD
**Firestore Data:**
```js
{
  type: "DEBT",
  amount: 15, // +15k
  desc: "ƒê∆°n COD #order_123",
  orderId: "order_abc123xyz",
  customerName: "Nguy·ªÖn VƒÉn B"
}
```

**Shipper Screen Display:**
```
Icon: receipt (orange)
Desc: "ƒê∆°n COD #order_123"
Date: "27/01/2026, 10:00:00"
Amount: -15,000ƒë (orange)
```

### Example 2: Admin thu ti·ªÅn
**Firestore Data:**
```js
{
  type: "PAYMENT",
  amount: -30, // -30k (reduce debt)
  desc: "Admin thu ti·ªÅn m·∫∑t"
}
```

**Shipper Screen Display:**
```
Icon: receipt (if still in debt) / cash-check (if surplus)
Desc: "Admin thu ti·ªÅn m·∫∑t"
Date: "27/01/2026, 11:00:00"
Amount: +30,000ƒë (green)
```

### Example 3: Refund t·ª´ discount
**Firestore Data:**
```js
{
  type: "REFUND",
  amount: -5, // -5k (admin owes)
  desc: "B√π discount v∆∞·ª£t qu√° adminShare",
  orderId: "order_def456"
}
```

**Shipper Screen Display:**
```
Icon: cash-check (if now surplus) / receipt (if still in debt)
Desc: "B√π discount v∆∞·ª£t qu√° adminShare"
Date: "27/01/2026, 12:00:00"
Amount: +5,000ƒë (green)
```

### Example 4: Balance progression
**Initial:** 0ƒë (neutral)

**After Order 1:** (+15k Firestore)
- Display: -15,000ƒë (orange card)
- Status: "B·∫†N ƒêANG N·ª¢ ADMIN"

**After Order 2:** (+15+10=+25k Firestore)
- Display: -25,000ƒë (orange card)
- Status: "B·∫†N ƒêANG N·ª¢ ADMIN"

**After Payment:** (+25-20=+5k Firestore)
- Display: -5,000ƒë (orange card, still debt)
- Status: "B·∫†N ƒêANG N·ª¢ ADMIN"

**After Refund:** (+5-7=-2k Firestore)
- Display: +2,000ƒë (green card, surplus!)
- Status: "ADMIN ƒêANG N·ª¢ B·∫†N"

## üéØ USE CASES

### 1. Shipper ki·ªÉm tra s·ªë d∆∞ tr∆∞·ªõc khi n·ªôp ti·ªÅn
- M·ªü app ‚Üí Shipper tab ‚Üí T√†i ch√≠nh
- Xem balance: -150,000ƒë
- Shipper chu·∫©n b·ªã 150k cash ƒë·ªÉ n·ªôp cho admin

### 2. Shipper theo d√µi l·ªãch s·ª≠ giao ƒë∆°n
- Scroll qua transaction list
- Xem c√°c ƒë∆°n ƒë√£ giao (DEBT transactions)
- Check desc, date, amount

### 3. Shipper x√°c minh admin ƒë√£ thu ti·ªÅn
- After n·ªôp ti·ªÅn cho admin
- Reload screen
- Check c√≥ PAYMENT transaction m·ªõi
- Confirm balance gi·∫£m ƒë√∫ng s·ªë ti·ªÅn

### 4. Shipper ph√°t hi·ªán balance d∆∞∆°ng
- Th·∫•y balance card m√†u xanh: +20,000ƒë
- Status: "ADMIN ƒêANG N·ª¢ B·∫†N"
- Shipper nh·∫Øc admin tr·∫£ l·∫°i 20k

### 5. Shipper xem chi ti·∫øt 1 transaction
- Currently: Kh√¥ng c√≥ detail view
- Suggestion: Tap v√†o transaction ‚Üí Show order detail

## üö® EDGE CASES

1. **No Transactions:**
   - transactions = []
   - displayBalance = 0
   - FlatList empty
   - Show "Ch∆∞a c√≥ giao d·ªãch"

2. **Zero Balance:**
   - rawBalance = 0
   - displayBalance = 0
   - Card background: Orange (default)
   - Status: "B·∫†N ƒêANG N·ª¢ ADMIN" (because 0 is not > 0)
   - Fix: Should show neutral state

3. **Not Shipper Role:**
   - currentUser.role !== 'shipper'
   - Redirect to home immediately
   - User kh√¥ng th·∫•y screen n√†y

4. **No CurrentUser:**
   - currentUser === null
   - Redirect to home
   - Should redirect to login

5. **Firestore Index Missing:**
   - Query v·ªõi orderBy fail
   - Error: "Index not found"
   - Solution: Remove orderBy, sort in JS (like admin view)

6. **Large Balance:**
   - displayBalance = -999,999k
   - Format: "-999,999,000ƒë"
   - May overflow card width
   - Need responsive fontSize

7. **Very Long Desc:**
   - desc = "Admin thu ti·ªÅn m·∫∑t t·∫°i c·ª≠a h√†ng l√∫c 10h s√°ng ng√†y 27/01/2026..."
   - May overflow transaction row
   - Need ellipsis: `numberOfLines={2}`

8. **Date Parse Error:**
   - Invalid createdAt string
   - new Date(invalid) = Invalid Date
   - toLocaleString() = "Invalid Date"
   - Should handle error

## üìù SUGGESTED IMPROVEMENTS

### 1. Zero Balance Neutral State
```js
const getBalanceStatus = (balance) => {
  if (balance === 0) {
    return {
      color: '#95A5A6', // Gray
      text: "KH√îNG N·ª¢",
      icon: 'check-circle'
    };
  } else if (balance < 0) {
    return {
      color: '#E67E22',
      text: "B·∫†N ƒêANG N·ª¢ ADMIN",
      icon: 'receipt'
    };
  } else {
    return {
      color: '#27AE60',
      text: "ADMIN ƒêANG N·ª¢ B·∫†N",
      icon: 'cash-check'
    };
  }
};
```

### 2. Transaction Detail Modal
```js
const [selectedTransaction, setSelectedTransaction] = useState(null);

const renderItem = ({ item }) => (
  <TouchableOpacity onPress={() => setSelectedTransaction(item)}>
    {/* Transaction row */}
  </TouchableOpacity>
);

<Modal visible={!!selectedTransaction}>
  <Text>M√¥ t·∫£: {selectedTransaction?.desc}</Text>
  <Text>M√£ ƒë∆°n: {selectedTransaction?.orderId}</Text>
  <Text>Kh√°ch h√†ng: {selectedTransaction?.customerName}</Text>
  <Text>S·ªë ti·ªÅn: {selectedTransaction?.amount}</Text>
  <Text>Th·ªùi gian: {selectedTransaction?.createdAt}</Text>
  <Text>Th·ª±c hi·ªán b·ªüi: {selectedTransaction?.performedBy}</Text>
  <Button onPress={() => setSelectedTransaction(null)}>ƒê√≥ng</Button>
</Modal>
```

### 3. Pull to Refresh
```js
const [refreshing, setRefreshing] = useState(false);

const onRefresh = async () => {
  setRefreshing(true);
  // Firestore already realtime, just visual feedback
  await new Promise(resolve => setTimeout(resolve, 500));
  setRefreshing(false);
};

<FlatList 
  refreshing={refreshing}
  onRefresh={onRefresh}
/>
```

### 4. Date Range Filter
```js
const [filter, setFilter] = useState('all'); // 'all', 'today', 'week', 'month'

const filteredTransactions = useMemo(() => {
  const now = new Date();
  return transactions.filter(t => {
    const date = new Date(t.createdAt);
    switch(filter) {
      case 'today':
        return date.toDateString() === now.toDateString();
      case 'week':
        return (now - date) < 7 * 24 * 60 * 60 * 1000;
      case 'month':
        return date.getMonth() === now.getMonth() && 
               date.getFullYear() === now.getFullYear();
      default:
        return true;
    }
  });
}, [transactions, filter]);
```

### 5. Statistics Summary
```js
const stats = useMemo(() => {
  const today = new Date().toDateString();
  const todayTransactions = transactions.filter(
    t => new Date(t.createdAt).toDateString() === today
  );
  
  const debts = todayTransactions.filter(t => t.type === 'DEBT');
  const payments = todayTransactions.filter(t => t.type === 'PAYMENT');
  
  return {
    todayOrders: debts.length,
    todayDebt: debts.reduce((sum, t) => sum + t.amount, 0) * -1,
    todayPaid: payments.reduce((sum, t) => sum + Math.abs(t.amount), 0)
  };
}, [transactions]);

<View style={styles.statsSection}>
  <Text>H√¥m nay: {stats.todayOrders} ƒë∆°n</Text>
  <Text>N·ª£ ph√°t sinh: {(stats.todayDebt*1000).toLocaleString()}ƒë</Text>
  <Text>ƒê√£ n·ªôp: {(stats.todayPaid*1000).toLocaleString()}ƒë</Text>
</View>
```

### 6. Balance History Chart
```js
import { LineChart } from 'react-native-chart-kit';

const balanceHistory = useMemo(() => {
  let runningBalance = 0;
  return transactions.map(t => {
    runningBalance += t.amount;
    return {
      date: t.createdAt,
      balance: runningBalance * -1 // Flip for display
    };
  }).reverse(); // Oldest to newest
}, [transactions]);

<LineChart 
  data={{
    labels: balanceHistory.map(h => formatDate(h.date)),
    datasets: [{ data: balanceHistory.map(h => h.balance) }]
  }}
/>
```

### 7. Export PDF Receipt
```js
import * as Print from 'expo-print';

const exportReceipt = async () => {
  const html = `
    <h1>BI√äN NH·∫¨N GIAO D·ªäCH</h1>
    <p>Shipper: ${currentUser.name}</p>
    <p>S·ªë d∆∞ hi·ªán t·∫°i: ${(displayBalance*1000).toLocaleString()}ƒë</p>
    <h2>L·ªãch s·ª≠ giao d·ªãch</h2>
    <table>
      ${transactions.map(t => `
        <tr>
          <td>${t.desc}</td>
          <td>${formatDate(t.createdAt)}</td>
          <td>${((t.amount||0)*-1000).toLocaleString()}ƒë</td>
        </tr>
      `).join('')}
    </table>
  `;
  
  await Print.printAsync({ html });
};
```

### 8. Notification Badge
```js
// In useAppStore
const getUnreadTransactionCount = () => {
  const lastSeen = localStorage.getItem('lastSeenTransaction');
  if (!lastSeen) return 0;
  
  return transactions.filter(
    t => new Date(t.createdAt) > new Date(lastSeen)
  ).length;
};

// In Shipper tab icon
<Icon 
  name="wallet" 
  badge={getUnreadTransactionCount()} 
/>

// Mark as seen when open
useEffect(() => {
  if (transactions.length > 0) {
    localStorage.setItem(
      'lastSeenTransaction', 
      transactions[0].createdAt
    );
  }
}, [transactions]);
```

### 9. Error Handling for Date
```js
const formatDate = (isoString) => {
  try {
    const date = new Date(isoString);
    if (isNaN(date.getTime())) {
      return 'Ng√†y kh√¥ng h·ª£p l·ªá';
    }
    return date.toLocaleString('vi-VN', {...});
  } catch (error) {
    console.error('Date format error:', error);
    return 'L·ªói ƒë·ªãnh d·∫°ng ng√†y';
  }
};
```

### 10. Empty State Design
```js
{transactions.length === 0 && !loading && (
  <View style={styles.emptyState}>
    <Icon name="inbox" size={64} color="#BDC3C7" />
    <Text style={styles.emptyText}>Ch∆∞a c√≥ giao d·ªãch n√†o</Text>
    <Text style={styles.emptyHint}>
      Giao d·ªãch s·∫Ω xu·∫•t hi·ªán khi b·∫°n giao ƒë∆°n
    </Text>
  </View>
)}
```
